#!/bin/bash
# Add anycast link-local addresses to SDN VNet interfaces
# Deployed via Ansible to /usr/local/bin/sdn-linklocal-setup.sh
# This script adds the anycast gateway link-local address (fe80::ffff) to all VNet SVIs
# to support dynamic unnumbered BGP peering from VMs
# All VMs can peer with the well-known address fe80::ffff regardless of which vnet they're on

{% if inventory_hostname in ['pve01','pve02','pve03'] %}

# Define the anycast link-local address used by all vnets
ANYCAST_LLA="fe80::ffff"

# Loop through all active tenant VLANs and configure their vnets
{% for vlan_id in TENANT_VLANS | sort %}
if ip link show vnet{{ vlan_id }} >/dev/null 2>&1; then
  # Add anycast link-local if not already present
  if ! ip -6 addr show dev vnet{{ vlan_id }} | grep -q "${ANYCAST_LLA}"; then
    ip -6 addr add ${ANYCAST_LLA}/64 dev vnet{{ vlan_id }}
    echo "Added anycast link-local ${ANYCAST_LLA} to vnet{{ vlan_id }}"
  else
    echo "Anycast link-local ${ANYCAST_LLA} already present on vnet{{ vlan_id }}"
  fi
else
  echo "vnet{{ vlan_id }} interface not found - SDN may not be configured yet"
fi

{% endfor %}
{% endif %}
