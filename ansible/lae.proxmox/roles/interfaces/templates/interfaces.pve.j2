{% set node_id  = (inventory_hostname | regex_replace('^pve0?', '') | int) %}
{% set public   = (public_interfaces[inventory_hostname] | default({})) %}
{% set HAS_MESH = inventory_hostname in ['pve01','pve02','pve03'] %}

# ==============================================================================
# PROXMOX VE NETWORK CONFIGURATION - DC STANDARD
# ==============================================================================

auto lo
iface lo inet loopback

# ------------------------------------------------------------------------------
# 1. PHYSICAL UPLINKS & BONDING
# ------------------------------------------------------------------------------
{% for slave in public.slaves %}
auto {{ slave }}
iface {{ slave }} inet manual
{% endfor %}

auto bond0
iface bond0 inet manual
    bond-mode {{ public.mode | default('802.3ad') }}
    bond-slaves {{ public.slaves | join(' ') }}
    bond-miimon 100
    bond-xmit-hash-policy layer2+3
{% if public.primary is defined %}
    bond-primary {{ public.primary }}
{% endif %}

# ------------------------------------------------------------------------------
# Management Plane (Untagged PVID 1)
# ------------------------------------------------------------------------------
# Purpose: SSH/GUI Access. Untagged for "Out-of-Band" style reliability.
auto vmbr0
iface vmbr0 inet static
    address 10.1.0.{{ node_id }}/24
    # No static gateway - using BGP-learned default route from RouterOS
    bridge-ports bond0
    bridge-vlan-aware yes
    bridge-vids 1 10 200
    bridge-pvid 1
    bridge-stp off
    bridge-fd 0
    mtu 1500
    post-up bridge vlan add dev vmbr0 vid 1 pvid untagged self || true
    post-up bridge vlan del dev vmbr0 vid 2 self 2>/dev/null || true

iface vmbr0 inet6 static
    address fd00:1::{{ node_id }}/64
    # Accept RAs on management plane
    #post-up   sleep 1 && sysctl -w net.ipv6.conf.vmbr0.accept_ra=2 || true
    #post-up   sysctl -w net.ipv6.conf.vmbr0.accept_ra_defrtr=2 || true

# ------------------------------------------------------------------------------
# Transit / Exit Path (Tagged VLAN 10)
# ------------------------------------------------------------------------------
# Purpose: BGP Peering to MikroTik. Tagged for Control Plane isolation.
auto vmbr0.10
iface vmbr0.10 inet static
    address 10.10.0.{{ node_id }}/24
    vlan-raw-device vmbr0
    mtu 1500

iface vmbr0.10 inet6 static
    address fd00:10::{{ node_id }}/64
    # SLAAC/RA disabled on transit interface - static routing only
    # post-up   sleep 1 && sysctl -w net.ipv6.conf.vmbr0/10.accept_ra=2 || true
    # post-up   sysctl -w net.ipv6.conf.vmbr0/10.accept_ra_defrtr=2 || true
    # pre-down  sysctl -w net.ipv6.conf.vmbr0/10.accept_ra_defrtr=1 || true
    # pre-down  sysctl -w net.ipv6.conf.vmbr0/10.accept_ra=1 || true

# Generic Workload / Ceph Transport (VLAN 200)
auto vmbr0.200
iface vmbr0.200 inet static
    address 10.200.0.{{ node_id }}/24
    vlan-raw-device vmbr0
    mtu 1500

iface vmbr0.200 inet6 static
    address fd00:200::{{ node_id }}/64

# ------------------------------------------------------------------------------
# 2. UNDERLAY MESH (25G Ring)
# ------------------------------------------------------------------------------
{% if HAS_MESH %}
{% for link in mesh_links[inventory_hostname] %}
{% set a = [node_id, link.peer_id] | min %}
{% set b = [node_id, link.peer_id] | max %}
auto {{ link.iface }}
iface {{ link.iface }} inet static
    address 10.99.{{ a }}{{ b }}.{{ node_id }}/29
    mtu 9000

iface {{ link.iface }} inet6 static
    address fc00:99:{{ a }}{{ b }}::{{ node_id }}/125
{% endfor %}
{% endif %}

# ------------------------------------------------------------------------------
# 3. IDENTITY LOOPBACKS (Used by FRR)
# ------------------------------------------------------------------------------
{% if HAS_MESH %}
# lo-infra: BGP/EVPN Router-ID & VTEP Source
auto lo-infra
iface lo-infra inet static
    address 10.255.0.{{ node_id }}/32
    pre-up ip link add lo-infra type dummy 2>/dev/null || true

iface lo-infra inet6 static
    address fd00:0:0:ffff::{{ node_id }}/128

# lo-svcs: Storage/Internal Application identity
auto lo-svcs
iface lo-svcs inet manual
    pre-up ip link add lo-svcs type dummy 2>/dev/null || true
    up ip -6 addr add fc00:20::{{ node_id }}/128 dev lo-svcs
    up ip -6 addr add fc00:21::{{ node_id }}/128 dev lo-svcs
{% endif %}

source /etc/network/interfaces.d/*
