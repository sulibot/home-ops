{% set node_id  = (inventory_hostname | regex_replace('^pve0?', '') | int) %}
{% set public   = (public_interfaces[inventory_hostname] | default({})) %}
{% set HAS_MESH = inventory_hostname in ['pve01','pve02','pve03'] %}

{# -----------------------------------------------------------------------------
   VRF PIPE SETTINGS (Proxmox SDN "xvrf_*" / "xvrfp_*" veth pair)
   - Proxmox already assigns IPv6 /127 on these links.
   - We add IPv4 /31 so BGP v4 between GLOBAL <-> VRF can come up.
   - Address scheme:
       VRF  side: 10.255.254.(2*node_id)/31
       GLOB side: 10.255.254.(2*node_id+1)/31
   - Zone name should match your SDN zone (default: evpnz1)
----------------------------------------------------------------------------- #}
{% set vrf_zone = (vrf_zone | default('evpnz1')) %}
{% set pipe_v4_vrf  = "10.255.254." ~ (2 * node_id) %}
{% set pipe_v4_glob = "10.255.254." ~ (2 * node_id + 1) %}

# ==============================================================================
# PROXMOX VE NETWORK CONFIGURATION - DC STANDARD
# ==============================================================================

auto lo
iface lo inet loopback

# ------------------------------------------------------------------------------
# 1. PHYSICAL UPLINKS & BONDING
# ------------------------------------------------------------------------------
{% for slave in (public.slaves | default([])) %}
auto {{ slave }}
iface {{ slave }} inet manual
{% endfor %}

auto bond0
iface bond0 inet manual
    bond-mode {{ public.mode | default('802.3ad') }}
    bond-slaves {{ (public.slaves | default([])) | join(' ') }}
    bond-miimon 100
    bond-xmit-hash-policy layer2+3
{% if public.primary is defined %}
    bond-primary {{ public.primary }}
{% endif %}

# ------------------------------------------------------------------------------
# Management Plane (Untagged PVID 1)
# ------------------------------------------------------------------------------
# Purpose: SSH/GUI Access. Untagged for "Out-of-Band" style reliability.
auto vmbr0
iface vmbr0 inet static
    address 10.1.0.{{ node_id }}/24
    # No static gateway - using BGP-learned default route from RouterOS
    bridge-ports bond0
    bridge-vlan-aware yes
    bridge-vids 1 10 30 31 200
    bridge-pvid 1
    bridge-stp off
    bridge-fd 0
    mtu 1500
    post-up bridge vlan add dev vmbr0 vid 1 pvid untagged self || true
    post-up bridge vlan del dev vmbr0 vid 2 self 2>/dev/null || true

iface vmbr0 inet6 static
    address fd00:1::{{ node_id }}/64
    # Accept RAs on management plane
    #post-up   sleep 1 && sysctl -w net.ipv6.conf.vmbr0.accept_ra=2 || true
    #post-up   sysctl -w net.ipv6.conf.vmbr0.accept_ra_defrtr=2 || true

# ------------------------------------------------------------------------------
# Transit / Exit Path (Tagged VLAN 10)
# ------------------------------------------------------------------------------
# Purpose: BGP Peering to MikroTik. Tagged for Control Plane isolation.
auto vmbr0.10
iface vmbr0.10 inet static
    address 10.10.0.{{ node_id }}/24
    gateway 10.10.0.254
    metric 1024
    vlan-raw-device vmbr0
    mtu 1500

iface vmbr0.10 inet6 static
    address fd00:10::{{ node_id }}/64
    gateway fe80::10:fffe
    metric 1024
    # SLAAC/RA disabled on transit interface - static routing only
    # post-up   sleep 1 && sysctl -w net.ipv6.conf.vmbr0/10.accept_ra=2 || true
    # post-up   sysctl -w net.ipv6.conf.vmbr0/10.accept_ra_defrtr=2 || true
    # pre-down  sysctl -w net.ipv6.conf.vmbr0/10.accept_ra_defrtr=1 || true
    # pre-down  sysctl -w net.ipv6.conf.vmbr0/10.accept_ra=1 || true

# ------------------------------------------------------------------------------
# Generic Workload / Ceph Transport (VLAN 200)
# ------------------------------------------------------------------------------
auto vmbr0.200
iface vmbr0.200 inet static
    address 10.200.0.{{ node_id }}/24
    vlan-raw-device vmbr0
    mtu 1500

iface vmbr0.200 inet6 static
    address fd00:200::{{ node_id }}/64

## VLAN 30
#auto vmbr0.30
#iface vmbr0.30 inet static
#    address 10.30.0.{{ node_id }}/24
#    vlan-raw-device vmbr0
#    mtu 1500
#
#iface vmbr0.30 inet6 static
#    address fd00:30::{{ node_id }}/64
#
## VLAN 31
#auto vmbr0.31
#iface vmbr0.31 inet static
#    address 10.31.0.{{ node_id }}/24
#    vlan-raw-device vmbr0
#    mtu 1500
#
#iface vmbr0.31 inet6 static
#    address fd00:31::{{ node_id }}/64

# ------------------------------------------------------------------------------
# 2. UNDERLAY MESH (25G Ring)
# ------------------------------------------------------------------------------
{% if HAS_MESH %}
{% for link in mesh_links[inventory_hostname] %}
{% set a = [node_id, link.peer_id] | min %}
{% set b = [node_id, link.peer_id] | max %}
auto {{ link.iface }}
iface {{ link.iface }} inet static
    address 10.99.{{ a }}{{ b }}.{{ node_id }}/29
    mtu 9000

iface {{ link.iface }} inet6 static
    address fc00:99:{{ a }}{{ b }}::{{ node_id }}/125
{% endfor %}
{% endif %}

# ------------------------------------------------------------------------------
# 3. IDENTITY LOOPBACKS (Used by FRR)
# ------------------------------------------------------------------------------
{% if HAS_MESH %}
# lo-infra: BGP/EVPN Router-ID & VTEP Source
auto lo-infra
iface lo-infra inet static
    address 10.255.0.{{ node_id }}/32
    pre-up ip link add lo-infra type dummy 2>/dev/null || true

iface lo-infra inet6 static
    address fd00:0:0:ffff::{{ node_id }}/128
    post-up sh -c 'echo 1 > /proc/sys/net/ipv6/conf/$IFACE/forwarding'

# lo-svcs: Storage/Internal Application identity
auto lo-svcs
iface lo-svcs inet manual
    pre-up ip link add lo-svcs type dummy 2>/dev/null || true
    up ip -6 addr add fc00:20::{{ node_id }}/128 dev lo-svcs
    up ip -6 addr add fc00:21::{{ node_id }}/128 dev lo-svcs
{% endif %}

# ------------------------------------------------------------------------------
# 4. GLOBAL <-> VRF "PIPE" (Proxmox SDN creates links; we add IPv4 /31)
# ------------------------------------------------------------------------------
# Proxmox SDN creates:
#   - xvrf_{{ vrf_zone }}  (global side)
#   - xvrfp_{{ vrf_zone }} (VRF side)
# IPv6 /127 is managed by Proxmox SDN; we only add IPv4 /31 here.

auto xvrf_{{ vrf_zone }}
iface xvrf_{{ vrf_zone }} inet manual
    # Global side of pipe (odd address) - MUST share the same /31 with VRF side
    post-up   ip addr add {{ pipe_v4_glob }}/31 dev $IFACE 2>/dev/null || true
    pre-down  ip addr del {{ pipe_v4_glob }}/31 dev $IFACE 2>/dev/null || true

auto xvrfp_{{ vrf_zone }}
iface xvrfp_{{ vrf_zone }} inet manual
    # VRF side of pipe (even address)
    post-up   ip link set dev $IFACE master vrf_{{ vrf_zone }} 2>/dev/null || true
    post-up   ip addr add {{ pipe_v4_vrf }}/31 dev $IFACE 2>/dev/null || true
    pre-down  ip addr del {{ pipe_v4_vrf }}/31 dev $IFACE 2>/dev/null || true

source /etc/network/interfaces.d/*
