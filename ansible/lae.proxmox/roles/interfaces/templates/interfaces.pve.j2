{% set node_id  = (inventory_hostname[-2:] | regex_replace('^0*', '') | int) %}
{% set public   = (public_interfaces[inventory_hostname] | default({})) %}
{% set HAS_MESH = inventory_hostname in ['pve01','pve02','pve03'] %}

# ============================================================
# Proxmox VE Network Configuration — {{ inventory_hostname }}
#
# - vmbr0: VLAN-aware bridge (egress/infra, MTU 1500)
# - bond0: uplink bond for vmbr0
# - mesh links: 25G ring, MTU 9000, IPv6-only (link-local)
# - dummy_underlay: Ceph public/cluster IPv6 + IPv4 loopback
# - lo:
#     * infra loopback for BGP router-id: fd00:255::{{ node_id }}/128
#     * tenant anycast gateways: fd00:<vlan>::fffe/128
# ============================================================

auto lo
iface lo inet loopback

# Host infra loopback (BGP router-id, infra identity)
iface lo inet static
    address 10.255.0.{{ node_id }}/32

iface lo inet6 static
    address fd00:255::{{ node_id }}/128

# ------------------------------------------------------------
# Bond (bond0) + slaves (egress / management uplink)
# ------------------------------------------------------------

{% for slave in public.slaves %}
auto {{ slave }}
iface {{ slave }} inet manual
{% endfor %}

auto bond0
iface bond0 inet manual
    bond-mode {{ public.mode }}
    bond-miimon 100
    bond-slaves {{ public.slaves | join(' ') }}
{% if public.primary is defined %}
    bond-primary {{ public.primary }}
{% endif %}
{% if public.xmit_hash_policy is defined %}
    bond-xmit-hash-policy {{ public.xmit_hash_policy }}
{% endif %}

# ------------------------------------------------------------
# vmbr0 — VLAN-aware egress/infra bridge (MTU 1500)
# ------------------------------------------------------------

auto vmbr0
iface vmbr0 inet manual
    bridge-ports bond0
    bridge-stp off
    bridge-fd 0
    bridge-vlan-aware yes
    bridge-pvid 10
    bridge-vids 10 100-103 200
    mtu 1500

# VLAN 10 — management/API (native)
auto vmbr0.10
iface vmbr0.10 inet static
    address 10.0.10.{{ node_id }}/24
    gateway 10.0.10.254
    vlan-raw-device vmbr0

iface vmbr0.10 inet6 static
    address fd00:10::{{ node_id }}/64
    vlan-raw-device vmbr0
    # Accept RAs even with forwarding and accept default from RA
    post-up   sh -c 'echo 2 > /proc/sys/net/ipv6/conf/$IFACE/accept_ra'
    post-up   sh -c 'echo 2 > /proc/sys/net/ipv6/conf/$IFACE/accept_ra_defrtr'
    pre-down  sh -c 'echo 1 > /proc/sys/net/ipv6/conf/$IFACE/accept_ra_defrtr'
    pre-down  sh -c 'echo 1 > /proc/sys/net/ipv6/conf/$IFACE/accept_ra'

# ---- tenant VLANs on vmbr0.V (VM networks, gateways via ANYCAST on lo) ----
{% for vlan_id in TENANT_VLANS | sort %}
auto vmbr0.{{ vlan_id }}
iface vmbr0.{{ vlan_id }} inet manual
    vlan-raw-device vmbr0
    mtu 1500

iface vmbr0.{{ vlan_id }} inet6 static
    address fe80::255:{{ node_id }}/64
    vlan-raw-device vmbr0
    mtu 1500
    post-up sh -c 'echo 1 > /proc/sys/net/ipv6/conf/$IFACE/proxy_ndp'
    post-up sh -c 'echo 0 > /proc/sys/net/ipv6/conf/$IFACE/accept_ra'
    post-up sh -c 'echo 0 > /proc/sys/net/ipv6/conf/$IFACE/accept_ra_defrtr'
    post-up sh -c 'echo 0 > /proc/sys/net/ipv6/conf/$IFACE/autoconf'
{% endfor %}

# VLAN 200 — Ceph client / storage LAN (tagged)
auto vmbr0.200
iface vmbr0.200 inet static
    address 10.0.200.{{ node_id }}/24
    vlan-raw-device vmbr0
    mtu 1500

# ------------------------------------------------------------
# Underlay ring links @ MTU 9000 — IPv6-only
#
# These are 25Gb point-to-point links between PVE nodes.
# We rely on IPv6 link-local for BGP neighbors (neighbor <iface> interface).
# ------------------------------------------------------------

{% if HAS_MESH %}
{% for link in mesh_links[inventory_hostname] %}
auto {{ link.iface }}
iface {{ link.iface }} inet manual
    mtu 9000

iface {{ link.iface }} inet6 manual
    mtu 9000
    # No ULA/GUA here; IPv6 link-local only (fe80::/64) for BGP peering.
{% endfor %}
{% endif %}

# ------------------------------------------------------------
# dummy_underlay — Ceph public & cluster IPs + IPv4 loopback
#
# These addresses are redistributed into BGP so Ceph traffic
# follows the routed underlay.
# ------------------------------------------------------------

{% if HAS_MESH %}
#auto dummy_underlay
#iface dummy_underlay inet static
#    address 10.255.0.{{ node_id }}/32
#    pre-up ip link add dummy_underlay type dummy 2>/dev/null || true
#    mtu 9000

iface dummy_underlay inet6 static
    address fc00:20::{{ node_id }}/128
    address fc00:21::{{ node_id }}/128
    pre-up ip link add dummy_underlay type dummy 2>/dev/null || true
    mtu 9000
{% endif %}

# ------------------------------------------------------------
# Include drop-ins (Proxmox SDN, manual tweaks, etc.)
# ------------------------------------------------------------

source /etc/network/interfaces.d/*
