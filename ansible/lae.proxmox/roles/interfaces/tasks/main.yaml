---
# ============================================================================
# Proxmox Host Network Configuration and Kernel Tuning
# ============================================================================

## Deploy /etc/network/interfaces.d/dummy_underlay from template
#- name: Deploy /etc/network/interfaces.d/dummy_underlay
#  ansible.builtin.template:
#    src: interfaces.dummy_underlay.pve.j2
#    dest: /etc/network/interfaces.d/dummy_underlay
#    mode: '0644'
#  notify: Reload network

# Deploy /etc/network/interfaces from template
- name: Deploy /etc/network/interfaces
  ansible.builtin.template:
    src: interfaces.pve.j2
    dest: /etc/network/interfaces
    mode: '0644'
  notify: Reload network

# Ensure /etc/sysctl.d directory exists for custom sysctl files
- name: Ensure /etc/sysctl.d exists
  ansible.builtin.file:
    path: /etc/sysctl.d
    state: directory
    mode: '0755'

# Task: Configure global IP forwarding and general network sanity settings
- name: Configure global IP forwarding and general network sanity
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-forwarding.conf
    state: present
    reload: yes
  loop:
    # --- IP Forwarding ---
    - { name: 'net/ipv4/ip_forward',                 value: '1' }
    - { name: 'net/ipv6/conf/all/forwarding',        value: '1' }
    - { name: 'net/ipv6/conf/default/forwarding',    value: '1' }
    - { name: 'net/ipv6/conf/lo/forwarding',         value: '1' }

    # --- ARP Behavior (IPv4) - Global permissive ---
    - { name: 'net/ipv4/conf/all/arp_ignore',        value: '0' }
    - { name: 'net/ipv4/conf/default/arp_ignore',    value: '0' }
    - { name: 'net/ipv4/conf/all/arp_filter',        value: '0' }
    - { name: 'net/ipv4/conf/default/arp_filter',    value: '0' }
    - { name: 'net/ipv4/conf/all/arp_announce',      value: '2' }
    - { name: 'net/ipv4/conf/default/arp_announce',  value: '2' }

    # --- Neighbor (IPv6) - Global ---
    - { name: 'net/ipv6/conf/all/proxy_ndp',         value: '0' }
    - { name: 'net/ipv6/conf/default/proxy_ndp',     value: '0' }

    # --- Reverse Path Filtering (IPv4) ---
    # Loose globally; we turn OFF per anycast VLAN
    - { name: 'net/ipv4/conf/all/rp_filter',         value: '0' }
    - { name: 'net/ipv4/conf/default/rp_filter',     value: '0' }

    # --- ICMP Redirects (v4/v6) ---
    - { name: 'net/ipv4/conf/all/accept_redirects',     value: '0' }
    - { name: 'net/ipv4/conf/default/accept_redirects', value: '0' }
    - { name: 'net/ipv4/conf/all/send_redirects',       value: '0' }
    - { name: 'net/ipv4/conf/default/send_redirects',   value: '0' }
    - { name: 'net/ipv6/conf/all/accept_redirects',     value: '0' }
    - { name: 'net/ipv6/conf/default/accept_redirects', value: '0' }

    # --- DAD on loopback anycast /128s ---
    - { name: 'net/ipv6/conf/lo/accept_dad',         value: '0' }

# ============================================================================
# xvrf Cross-Connect Configuration
# ============================================================================
# Creates IPv6 /127 point-to-point link between default VRF and vrf_evpnz1
# Enables BGP "import vrf default" routes to have resolvable nexthops
# ============================================================================

# ============================================================================
# xvrf Cross-Connect Configuration
# ============================================================================
# Creates IPv6 /127 point-to-point link between default VRF and vrf_evpnz1
# Enables BGP "import vrf default" routes to have resolvable nexthops
# ============================================================================

- name: Deploy xvrf cross-connect network configuration
  ansible.builtin.template:
    src: xvrf_ips.j2
    dest: /etc/network/interfaces.d/xvrf-ips
    mode: '0644'
  notify: Reload network
  when: inventory_hostname in ['pve01','pve02','pve03']

# ============================================================================
# SDN Anycast Link-Local Address Configuration
# ============================================================================
# Configures static link-local IPv6 addresses (fe80::<vnet_id>:fffe) on all
# VNet bridges to enable BGP unnumbered peering with consistent addresses
# across all PVE nodes for seamless VM migration
# ============================================================================

- name: Deploy SDN anycast link-local address configuration
  ansible.builtin.template:
    src: sdn_anycast_lla.j2
    dest: /etc/network/interfaces.d/sdn-anycast-lla
    mode: '0644'
  notify: Reload network
  when: inventory_hostname in ['pve01','pve02','pve03']
