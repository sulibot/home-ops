---
# ============================================================================
# Proxmox Host Network Configuration and Kernel Tuning
# ============================================================================

## Deploy /etc/network/interfaces.d/dummy_underlay from template
#- name: Deploy /etc/network/interfaces.d/dummy_underlay
#  ansible.builtin.template:
#    src: interfaces.dummy_underlay.pve.j2
#    dest: /etc/network/interfaces.d/dummy_underlay
#    mode: '0644'
#  notify: Reload network

# Deploy /etc/network/interfaces from template
- name: Deploy /etc/network/interfaces
  ansible.builtin.template:
    src: interfaces.pve.j2
    dest: /etc/network/interfaces
    mode: '0644'
  notify: Reload network

# Ensure /etc/sysctl.d directory exists for custom sysctl files
- name: Ensure /etc/sysctl.d exists
  ansible.builtin.file:
    path: /etc/sysctl.d
    state: directory
    mode: '0755'

# Task: Configure global IP forwarding and general network sanity settings
- name: Configure global IP forwarding and general network sanity
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-forwarding.conf
    state: present
    reload: yes
  loop:
    # --- IP Forwarding ---
    - { name: 'net/ipv4/ip_forward',                 value: '1' }
    - { name: 'net/ipv6/conf/all/forwarding',        value: '1' }
    - { name: 'net/ipv6/conf/default/forwarding',    value: '1' }
    - { name: 'net/ipv6/conf/lo/forwarding',         value: '1' }

    # --- ARP Behavior (IPv4) - Global permissive ---
    - { name: 'net/ipv4/conf/all/arp_ignore',        value: '0' }
    - { name: 'net/ipv4/conf/default/arp_ignore',    value: '0' }
    - { name: 'net/ipv4/conf/all/arp_filter',        value: '0' }
    - { name: 'net/ipv4/conf/default/arp_filter',    value: '0' }
    - { name: 'net/ipv4/conf/all/arp_announce',      value: '2' }
    - { name: 'net/ipv4/conf/default/arp_announce',  value: '2' }

    # --- Neighbor (IPv6) - Global ---
    - { name: 'net/ipv6/conf/all/proxy_ndp',         value: '0' }
    - { name: 'net/ipv6/conf/default/proxy_ndp',     value: '0' }

    # --- Reverse Path Filtering (IPv4) ---
    # Loose globally; we turn OFF per anycast VLAN
    - { name: 'net/ipv4/conf/all/rp_filter',         value: '0' }
    - { name: 'net/ipv4/conf/default/rp_filter',     value: '0' }

    # --- ICMP Redirects (v4/v6) ---
    - { name: 'net/ipv4/conf/all/accept_redirects',     value: '0' }
    - { name: 'net/ipv4/conf/default/accept_redirects', value: '0' }
    - { name: 'net/ipv4/conf/all/send_redirects',       value: '0' }
    - { name: 'net/ipv4/conf/default/send_redirects',   value: '0' }
    - { name: 'net/ipv6/conf/all/accept_redirects',     value: '0' }
    - { name: 'net/ipv6/conf/default/accept_redirects', value: '0' }

    # --- DAD on loopback anycast /128s ---
    - { name: 'net/ipv6/conf/lo/accept_dad',         value: '0' }
# 
# # IPv6 RA/autoconf OFF on vmbr0.* (anycast VLAN bridges)
# - name: Disable IPv6 Autoconf/RA on vmbr0 anycast bridges
#   ansible.posix.sysctl:
#     name: "net/ipv6/conf/vmbr0.{{ item.0 }}/{{ item.1 }}"
#     value: '0'
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ vmbr0_anycast_vlans | product(['accept_ra', 'autoconf', 'accept_dad', 'router_solicitations']) | list }}"
# 
# # IPv6 RA/autoconf OFF on mesh0 parent bridge
# - name: Disable IPv6 Autoconf/RA on mesh0 VLAN-aware bridge
#   ansible.posix.sysctl:
#     name: "{{ item }}"
#     value: '0'
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop:
#     - 'net/ipv6/conf/mesh0/accept_ra'
#     - 'net/ipv6/conf/mesh0/autoconf'
#     - 'net/ipv6/conf/mesh0/accept_dad'
#     - 'net/ipv6/conf/mesh0/router_solicitations'
#   when: inventory_hostname in ['pve01','pve02','pve03']
# 
# # >>> IPv6 RA ON for bond0.5 (accept RA even with forwarding=1)
# - name: Allow IPv6 RA + default route via RA on bond0.5
#   ansible.posix.sysctl:
#     name: "{{ item.name }}"
#     value: "{{ item.value }}"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop:
#     - { name: 'net/ipv6/conf/bond0.5/accept_ra',        value: '2' }
#     - { name: 'net/ipv6/conf/bond0.5/accept_ra_defrtr', value: '2' }
# 
# # --------------------------
# # Anycast per-VLAN on vmbr0
# # --------------------------
# 
# # ARP hygiene (IPv4) on vmbr0 VLAN bridges
# - name: Set ARP hygiene on vmbr0 anycast VLAN bridges (IPv4)
#   ansible.posix.sysctl:
#     name: "net/ipv4/conf/vmbr0.{{ item.0 }}/{{ item.1.name }}"
#     value: "{{ item.1.value }}"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ vmbr0_anycast_vlans | product([
#            {'name': 'arp_ignore',           'value': '0'},
#            {'name': 'arp_announce',         'value': '2'},
#            {'name': 'arp_filter',           'value': '0'},
#            {'name': 'drop_gratuitous_arp',  'value': '1'}
#          ]) | list }}"
# 
# # rp_filter OFF (IPv4) on vmbr0 VLAN bridges
# - name: Disable rp_filter on vmbr0 anycast VLAN bridges (IPv4)
#   ansible.posix.sysctl:
#     name: "net/ipv4/conf/vmbr0.{{ item }}/rp_filter"
#     value: "0"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ vmbr0_anycast_vlans }}"
# 
# # Proxy ARP on vmbr0.* (IPv4)
# - name: Enable Proxy ARP on vmbr0 anycast VLAN bridges (IPv4)
#   ansible.posix.sysctl:
#     name: "net/ipv4/conf/vmbr0.{{ item }}/proxy_arp"
#     value: "1"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ vmbr0_anycast_vlans }}"
# 
# # Proxy NDP on vmbr0.* (IPv6)
# - name: Enable Proxy NDP on vmbr0 anycast VLAN bridges (IPv6)
#   ansible.posix.sysctl:
#     name: "net/ipv6/conf/vmbr0.{{ item }}/proxy_ndp"
#     value: "1"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ vmbr0_anycast_vlans }}"
# 
# # --------------------------
# # Anycast per-VLAN on mesh0
# # --------------------------
# 
# # IPv6 RA/autoconf OFF on mesh0.* VLAN SVIs
# - name: Disable IPv6 Autoconf/RA on mesh0 VLAN SVIs
#   ansible.posix.sysctl:
#     name: "net/ipv6/conf/mesh0.{{ item.0 }}/{{ item.1 }}"
#     value: '0'
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ mesh0_anycast_vlans | default([]) | product(['accept_ra','autoconf','accept_dad','router_solicitations']) | list }}"
#   when: inventory_hostname in ['pve01','pve02','pve03']
# 
# # ARP hygiene (IPv4) on mesh0 VLAN bridges
# - name: Set ARP hygiene on mesh0 anycast VLAN bridges (IPv4)
#   ansible.posix.sysctl:
#     name: "net/ipv4/conf/mesh0.{{ item.0 }}/{{ item.1.name }}"
#     value: "{{ item.1.value }}"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ mesh0_anycast_vlans | default([]) | product([
#            {'name': 'arp_ignore',           'value': '0'},
#            {'name': 'arp_announce',         'value': '2'},
#            {'name': 'arp_filter',           'value': '0'},
#            {'name': 'drop_gratuitous_arp',  'value': '1'}
#          ]) | list }}"
#   when: inventory_hostname in ['pve01','pve02','pve03']
# 
# # rp_filter OFF (IPv4) on mesh0 VLAN bridges
# - name: Disable rp_filter on mesh0 anycast VLAN bridges (IPv4)
#   ansible.posix.sysctl:
#     name: "net/ipv4/conf/mesh0.{{ item }}/rp_filter"
#     value: "0"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ mesh0_anycast_vlans | default([]) }}"
#   when: inventory_hostname in ['pve01','pve02','pve03']
# 
# # Proxy ARP on mesh0.* (IPv4)
# - name: Enable Proxy ARP on mesh0 anycast VLAN bridges (IPv4)
#   ansible.posix.sysctl:
#     name: "net/ipv4/conf/mesh0.{{ item }}/proxy_arp"
#     value: "1"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ mesh0_anycast_vlans | default([]) }}"
#   when: inventory_hostname in ['pve01','pve02','pve03']
# 
# # Proxy NDP on mesh0.* (IPv6)
# - name: Enable Proxy NDP on mesh0 anycast VLAN bridges (IPv6)
#   ansible.posix.sysctl:
#     name: "net/ipv6/conf/mesh0.{{ item }}/proxy_ndp"
#     value: "1"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop: "{{ mesh0_anycast_vlans | default([]) }}"
#   when: inventory_hostname in ['pve01','pve02','pve03']
# 
# # --------------------------
# # Bridge netfilter (do not hairpin L2 through iptables/nft)
# # --------------------------
# - name: Keep L2 off iptables/nft (bridge-nf)
#   ansible.posix.sysctl:
#     name: "{{ item }}"
#     value: "0"
#     sysctl_file: "{{ sysctl_file_path }}"
#     state: present
#     reload: no
#   loop:
#     - 'net/bridge/bridge-nf-call-iptables'
#     - 'net/bridge/bridge-nf-call-ip6tables'
#     - 'net/bridge/bridge-nf-call-arptables'
# 
# # Apply all sysctl settings once now; systemd-sysctl will persist on reboot
# - name: Reload sysctls once
#   ansible.builtin.command: sysctl --system
#   changed_when: true

# ============================================================================
# SDN IPv4 Gateway Configuration
# ============================================================================
# Deploy script to add IPv4 gateway addresses to SDN VNet interfaces
# Required because Proxmox SDN (as of 9.x) doesn't automatically configure
# IPv4 gateway addresses from subnet definitions
# ============================================================================

- name: Deploy SDN IPv4 gateway setup script
  ansible.builtin.template:
    src: sdn_ipv4_gateway.j2
    dest: /usr/local/bin/sdn-ipv4-gateway-setup.sh
    mode: '0755'
  when: inventory_hostname in ['pve01','pve02','pve03']

- name: Execute SDN IPv4 gateway setup
  ansible.builtin.command: /usr/local/bin/sdn-ipv4-gateway-setup.sh
  when: inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: sdn_ipv4_result

- name: Display SDN IPv4 gateway setup result
  ansible.builtin.debug:
    var: sdn_ipv4_result.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - sdn_ipv4_result.stdout_lines is defined

# ============================================================================
# Tenant Anycast BGP Peering (interfaces.d policy - disabled)
# ============================================================================

- name: Disable tenant anycast BGP peering policy drop-in
  ansible.builtin.file:
    path: /etc/network/interfaces.d/92-tenant-anycast-bgp
    state: absent
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Remove legacy tenant anycast BGP peering drop-in
  ansible.builtin.file:
    path: /etc/network/interfaces.d/92-tenant-bgp-anycast
    state: absent
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after disabling tenant anycast BGP peering
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: ifreload_result

- name: Display tenant anycast BGP peering disable result
  ansible.builtin.debug:
    var: ifreload_result.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - ifreload_result.stdout_lines is defined

# ============================================================================
# Tenant export-only VRF (control-plane only)
# ============================================================================

- name: Deploy tenant export-only VRF drop-in
  ansible.builtin.template:
    src: tenant_export_vrf.j2
    dest: /etc/network/interfaces.d/90-tenant-export-vrf
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after export-only VRF drop-in
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: export_vrf_reload

- name: Display export-only VRF reload result
  ansible.builtin.debug:
    var: export_vrf_reload.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - export_vrf_reload.stdout_lines is defined

# ============================================================================
# Tenant Anycast BGP Peering (host -> VRF steering)
# ============================================================================

- name: Deploy tenant anycast BGP steering script
  ansible.builtin.template:
    src: tenant_anycast_bgp_steer.sh.j2
    dest: /usr/local/sbin/tenant-anycast-bgp-steer.sh
    mode: '0755'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Deploy tenant anycast BGP steering unit
  ansible.builtin.template:
    src: tenant_anycast_bgp_steer.service.j2
    dest: /etc/systemd/system/tenant-anycast-bgp-steer.service
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Reload systemd daemon for tenant anycast BGP steering
  ansible.builtin.systemd:
    daemon_reload: true
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Enable tenant anycast BGP steering service
  ansible.builtin.systemd:
    name: tenant-anycast-bgp-steer.service
    enabled: true
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Start tenant anycast BGP steering service
  ansible.builtin.systemd:
    name: tenant-anycast-bgp-steer.service
    state: started
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Verify tenant anycast BGP peering state
  ansible.builtin.import_tasks: tenant_anycast_bgp_debug.yaml

# ============================================================================
# xvrf Cross-Connect Configuration
# ============================================================================
# Creates IPv6 /127 point-to-point link between default VRF and vrf_evpnz1
# Enables BGP "import vrf default" routes to have resolvable nexthops
# ============================================================================

- name: Deploy xvrf cross-connect network configuration
  ansible.builtin.template:
    src: xvrf_addresses.j2
    dest: /etc/network/interfaces.d/xvrf-cross-connect
    mode: '0644'
  notify: Reload network
  when: inventory_hostname in ['pve01','pve02','pve03']

# ============================================================================
# DEPRECATED: radvd configuration removed - now using dnsmasq-ra
# See roles/dnsmasq_ra for current IPv6 RA configuration
# ============================================================================

# ============================================================================
# Tenant VNet GUA Address Configuration
# ============================================================================
# Configures Global Unicast Addresses on tenant vnets from AT&T PD
# Uses VXLAN local interfaces for each vnet
# ============================================================================

- name: Deploy tenant VNet GUA address configuration
  ansible.builtin.template:
    src: tenant_vnet_ipv6_gua.j2
    dest: /etc/network/interfaces.d/91-tenant-vnet-gua
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after tenant VNet GUA configuration
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: tenant_gua_reload

- name: Display tenant VNet GUA reload result
  ansible.builtin.debug:
    var: tenant_gua_reload.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - tenant_gua_reload.stdout_lines is defined

# ============================================================================
# dnsmasq-ra VRF-aware Service for GUA Router Advertisements
# ============================================================================
# Configures dnsmasq to run in VRF context to advertise GUA prefixes to VMs.
# ULA prefixes are static (configured via Proxmox SDN), only GUA needs RA.
# Fixes Proxmox SDN limitation where dnsmasq can't bind to VRF interfaces.
# ============================================================================

- name: Ensure dnsmasq.d directory exists
  ansible.builtin.file:
    path: /etc/dnsmasq.d
    state: directory
    mode: '0755'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Stop and disable old unified dnsmasq-ra service
  ansible.builtin.systemd:
    name: dnsmasq-ra
    state: stopped
    enabled: no
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  failed_when: false

- name: Deploy per-vnet dnsmasq-ra configuration with explicit GUA
  ansible.builtin.template:
    src: dnsmasq_ra_per_vnet.conf.j2
    dest: /etc/dnsmasq.d/{{ item.name }}-ra.conf
    mode: '0644'
  loop: "{{ tenant_vnets }}"
  vars:
    vnet_name: "{{ item.name }}"
    vnet_id: "{{ item.id }}"
    gua_prefix: "{{ item.gua_prefix }}"
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  notify: Restart per-vnet dnsmasq

- name: Deploy per-vnet dnsmasq-ra systemd service
  ansible.builtin.template:
    src: dnsmasq_ra_vnet.service.j2
    dest: /etc/systemd/system/dnsmasq-{{ item.name }}.service
    mode: '0644'
  loop: "{{ tenant_vnets }}"
  vars:
    vnet_name: "{{ item.name }}"
    vrf_name: vrf_evpnz1
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Enable and start per-vnet dnsmasq-ra services
  ansible.builtin.systemd:
    name: dnsmasq-{{ item.name }}
    enabled: yes
    state: started
    daemon_reload: yes
  loop: "{{ tenant_vnets }}"
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

# ============================================================================
# Static Anycast LLA Configuration for BGP Unnumbered Peering
# ============================================================================
# Configures identical link-local IPv6 addresses on all PVE nodes for VM BGP
# unnumbered peering. VMs peer with fe80::<cluster_id>:1 which is present on
# every PVE node, enabling seamless VM live migration.
# ============================================================================

- name: Deploy Static Anycast LLA configuration for BGP unnumbered
  ansible.builtin.template:
    src: sdn_anycast_lla.j2
    dest: /etc/network/interfaces.d/93-sdn-anycast-lla
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after Static Anycast LLA configuration
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: anycast_lla_reload

- name: Display Static Anycast LLA reload result
  ansible.builtin.debug:
    var: anycast_lla_reload.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - anycast_lla_reload.stdout_lines is defined
