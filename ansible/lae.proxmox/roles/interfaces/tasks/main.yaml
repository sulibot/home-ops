---
# ============================================================================
# Proxmox Host Network Configuration and Kernel Tuning
# ============================================================================

## Deploy /etc/network/interfaces.d/dummy_underlay from template
#- name: Deploy /etc/network/interfaces.d/dummy_underlay
#  ansible.builtin.template:
#    src: interfaces.dummy_underlay.pve.j2
#    dest: /etc/network/interfaces.d/dummy_underlay
#    mode: '0644'
#  notify: Reload network

# Deploy /etc/network/interfaces from template
- name: Deploy /etc/network/interfaces
  ansible.builtin.template:
    src: interfaces.pve.j2
    dest: /etc/network/interfaces
    mode: '0644'
  notify: Reload network

# Ensure /etc/sysctl.d directory exists for custom sysctl files
- name: Ensure /etc/sysctl.d exists
  ansible.builtin.file:
    path: /etc/sysctl.d
    state: directory
    mode: '0755'

# Task: Configure global IP forwarding and general network sanity settings
- name: Configure global IP forwarding and general network sanity
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-forwarding.conf
    state: present
    reload: yes
  loop:
    # --- IP Forwarding ---
    - { name: 'net/ipv4/ip_forward',                 value: '1' }
    - { name: 'net/ipv6/conf/all/forwarding',        value: '1' }
    - { name: 'net/ipv6/conf/default/forwarding',    value: '1' }
    - { name: 'net/ipv6/conf/lo/forwarding',         value: '1' }

    # --- ARP Behavior (IPv4) - Global permissive ---
    - { name: 'net/ipv4/conf/all/arp_ignore',        value: '0' }
    - { name: 'net/ipv4/conf/default/arp_ignore',    value: '0' }
    - { name: 'net/ipv4/conf/all/arp_filter',        value: '0' }
    - { name: 'net/ipv4/conf/default/arp_filter',    value: '0' }
    - { name: 'net/ipv4/conf/all/arp_announce',      value: '2' }
    - { name: 'net/ipv4/conf/default/arp_announce',  value: '2' }

    # --- Neighbor (IPv6) - Global ---
    - { name: 'net/ipv6/conf/all/proxy_ndp',         value: '0' }
    - { name: 'net/ipv6/conf/default/proxy_ndp',     value: '0' }

    # --- Reverse Path Filtering (IPv4) ---
    # Loose globally; we turn OFF per anycast VLAN
    - { name: 'net/ipv4/conf/all/rp_filter',         value: '0' }
    - { name: 'net/ipv4/conf/default/rp_filter',     value: '0' }

    # --- ICMP Redirects (v4/v6) ---
    - { name: 'net/ipv4/conf/all/accept_redirects',     value: '0' }
    - { name: 'net/ipv4/conf/default/accept_redirects', value: '0' }
    - { name: 'net/ipv4/conf/all/send_redirects',       value: '0' }
    - { name: 'net/ipv4/conf/default/send_redirects',   value: '0' }
    - { name: 'net/ipv6/conf/all/accept_redirects',     value: '0' }
    - { name: 'net/ipv6/conf/default/accept_redirects', value: '0' }

    # --- DAD on loopback anycast /128s ---
    - { name: 'net/ipv6/conf/lo/accept_dad',         value: '0' }

# ============================================================================
# Legacy Tenant Anycast BGP Configuration Cleanup
# ============================================================================

- name: Disable tenant anycast BGP peering policy drop-in
  ansible.builtin.file:
    path: /etc/network/interfaces.d/92-tenant-anycast-bgp
    state: absent
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Remove legacy tenant anycast BGP peering drop-in
  ansible.builtin.file:
    path: /etc/network/interfaces.d/92-tenant-bgp-anycast
    state: absent
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after disabling tenant anycast BGP peering
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: ifreload_result

- name: Display tenant anycast BGP peering disable result
  ansible.builtin.debug:
    var: ifreload_result.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - ifreload_result.stdout_lines is defined

# ============================================================================
# Tenant export-only VRF (control-plane only)
# ============================================================================

- name: Deploy tenant export-only VRF drop-in
  ansible.builtin.template:
    src: tenant_export_vrf.j2
    dest: /etc/network/interfaces.d/90-tenant-export-vrf
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after export-only VRF drop-in
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: export_vrf_reload

- name: Display export-only VRF reload result
  ansible.builtin.debug:
    var: export_vrf_reload.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - export_vrf_reload.stdout_lines is defined

# ============================================================================
# Tenant Anycast BGP Peering (host -> VRF steering)
# ============================================================================

- name: Deploy tenant anycast BGP steering script
  ansible.builtin.template:
    src: tenant_anycast_bgp_steer.sh.j2
    dest: /usr/local/sbin/tenant-anycast-bgp-steer.sh
    mode: '0755'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Deploy tenant anycast BGP steering unit
  ansible.builtin.template:
    src: tenant_anycast_bgp_steer.service.j2
    dest: /etc/systemd/system/tenant-anycast-bgp-steer.service
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Reload systemd daemon for tenant anycast BGP steering
  ansible.builtin.systemd:
    daemon_reload: true
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Enable tenant anycast BGP steering service
  ansible.builtin.systemd:
    name: tenant-anycast-bgp-steer.service
    enabled: true
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Start tenant anycast BGP steering service
  ansible.builtin.systemd:
    name: tenant-anycast-bgp-steer.service
    state: started
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Verify tenant anycast BGP peering state
  ansible.builtin.import_tasks: tenant_anycast_bgp_debug.yaml

# ============================================================================
# xvrf Cross-Connect Configuration
# ============================================================================
# Creates IPv6 /127 point-to-point link between default VRF and vrf_evpnz1
# Enables BGP "import vrf default" routes to have resolvable nexthops
# ============================================================================

- name: Deploy xvrf cross-connect network configuration
  ansible.builtin.template:
    src: xvrf_ips.j2
    dest: /etc/network/interfaces.d/xvrf-ips
    mode: '0644'
  notify: Reload network
  when: inventory_hostname in ['pve01','pve02','pve03']

# ============================================================================
# Tenant VNet GUA Address Configuration
# ============================================================================
# Configures Global Unicast Addresses on tenant vnets from AT&T PD
# Uses VXLAN local interfaces for each vnet
# ============================================================================

- name: Deploy tenant VNet GUA address configuration
  ansible.builtin.template:
    src: tenant_vnet_ipv6_gua.j2
    dest: /etc/network/interfaces.d/91-tenant-vnet-gua
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after tenant VNet GUA configuration
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: tenant_gua_reload

- name: Display tenant VNet GUA reload result
  ansible.builtin.debug:
    var: tenant_gua_reload.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - tenant_gua_reload.stdout_lines is defined

# ============================================================================
# Static Anycast LLA Configuration for BGP Unnumbered Peering
# ============================================================================
# Configures identical link-local IPv6 addresses on all PVE nodes for VM BGP
# unnumbered peering. VMs peer with fe80::<cluster_id>:1 which is present on
# every PVE node, enabling seamless VM live migration.
# ============================================================================

- name: Deploy Static Anycast LLA configuration for BGP unnumbered
  ansible.builtin.template:
    src: sdn_anycast_lla.j2
    dest: /etc/network/interfaces.d/93-sdn-anycast-lla
    mode: '0644'
  when:
    - inventory_hostname in ['pve01','pve02','pve03']

- name: Apply network reload after Static Anycast LLA configuration
  ansible.builtin.command: /usr/sbin/ifreload -a
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
  changed_when: false
  register: anycast_lla_reload

- name: Display Static Anycast LLA reload result
  ansible.builtin.debug:
    var: anycast_lla_reload.stdout_lines
  when:
    - inventory_hostname in ['pve01','pve02','pve03']
    - anycast_lla_reload.stdout_lines is defined
