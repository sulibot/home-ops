{# ---------- Host-scoped helpers ---------- #}
{% set HAS_MESH = inventory_hostname in ['pve01','pve02','pve03'] %}
{% set PVE_ID = inventory_hostname | regex_replace('^pve0?', '') | int %}
{% set EDGE_ASN = EDGE_ASN | default(65000) %}
{% set PVE_ASN = PVE_ASN | default(65001) %}
{% set EDGE_V6_LO = EDGE_V6_LO | default('fd00:255::fffe') %}
! ======================================================================
! frr.conf.local - Proxmox SDN BGP EVPN extension with L3 gateways
! ======================================================================
{% if HAS_MESH %}
! ---------- Prefer 25Gb P2P Ring for Data Plane Traffic ----------
! Strategy: Filter BGP-learned routes to peer PVE loopbacks so OpenFabric routes
! (via 25Gb P2P ring) are preferred. This makes BGP next-hop resolution use the
! high-bandwidth ring instead of the 2.5Gb vmbr0.10 management interface.
!
! Result: Internet routes, tenant networks, and other BGP-learned prefixes will
! traverse the P2P ring. Direct ROS management traffic still uses vmbr0.10.
!
! IPv6 prefix list: Filter internal cluster routes from external BGP
! 1. Filter peer PVE loopbacks (fd00:255::1-3) - allows OpenFabric to win
! 2. Filter tenant VNI networks (fd00:100-103, fd00:200) - allows EVPN to handle routing
! 3. Filter K8s cluster loopbacks (fd00:255:101::/64 and all /128s) - VMs within cluster
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:255::1/128
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:255::2/128
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:255::3/128
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:100::/64
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:101::/64
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:102::/64
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:103::/64
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:200::/64
ipv6 prefix-list FILTER_PEER_LOOPBACKS deny fd00:255:101::/64 le 128
ipv6 prefix-list FILTER_PEER_LOOPBACKS permit ::/0 le 128
!
! Route-map: Apply prefix-list filter to BGP neighbor
route-map BGP_IN_FILTER permit 10
 match ipv6 address prefix-list FILTER_PEER_LOOPBACKS
exit
!
! ---------- Static Routes for K8s VM Loopbacks ----------
! K8s VMs are within the cluster and reachable via mesh network (VXLAN VNI 101)
! Route K8s loopbacks directly to the vnet101 interface (EVPN bridge)
! Traffic will traverse the 25Gb P2P ring via VXLAN tunnels
!
ipv6 route fd00:255:101::/64 vnet101
!
! ---------- BGP Edge Router Peering ----------
router bgp {{ PVE_ASN }}
 !
 address-family ipv6 unicast
  neighbor BGP activate
  neighbor BGP soft-reconfiguration inbound
  neighbor BGP route-map BGP_IN_FILTER in
 exit-address-family
 !
 address-family l2vpn evpn
  advertise ipv6 unicast
 exit-address-family
exit
!

! ---------- Anycast Gateway IPs per VNI ----------
! These are attached directly to the VXLAN bridge devices so VMs can reach fc00:X::fffe locally.

interface vnet101
 ipv6 address fc00:101::fffe/64
exit
!
interface vnet102
 ipv6 address fc00:102::fffe/64
exit
!
interface vnet103
 ipv6 address fc00:103::fffe/64
exit
!
{% endif %}
