{# Variable Mapping #}
{% set node_id    = (inventory_hostname | regex_replace('^pve0?', '') | int) %}
{% set infra_ip4  = "10.255.0." ~ node_id %}
{% set infra_ip6  = "fd00:0:0:ffff::" ~ node_id %}
{% set pipe_global = "fd00:255:254:" ~ node_id ~ "::1" %}
{% set pipe_vrf    = "fd00:255:254:" ~ node_id ~ "::0" %}
{% set vrf_router_id = "10.255.255." ~ ((node_id - 1) * 4 + 2) %}
{% set HAS_MESH   = inventory_hostname in ['pve01','pve02','pve03'] %}

{% if HAS_MESH %}
! FRR 10.5 - Datacenter Framework
! Optimized for 25G Mesh + EVPN + Cross-Connect Peering
!
frr version 10.5
frr defaults datacenter
hostname {{ inventory_hostname }}
service integrated-vtysh-config
!
! -----------------------------------------------------------------------------
! PREFIX LISTS
! -----------------------------------------------------------------------------
ip prefix-list PL_DEFAULT_V4 seq 5 permit 0.0.0.0/0
ipv6 prefix-list PL_DEFAULT_V6 seq 5 permit ::/0
!
! Infrastructure loopbacks (BGP Peer IDs)
ip prefix-list PL_INFRA_V4 seq 5 permit 10.255.0.0/16 le 32
ipv6 prefix-list PL_INFRA_V6 seq 5 permit fd00:0:0:ffff::/64 le 128
!
! Ceph / Services (OSPF advertised for resilience)
ipv6 prefix-list PL_SVCS_V6 seq 5 permit fc00:20::/48 le 128
!
! Tenant VM/Pod/Loopback ranges
ip prefix-list PL_TENANT_V4 seq 5 permit 10.0.0.0/16 ge 24 le 32
ip prefix-list PL_TENANT_V4 seq 10 permit 10.100.0.0/14 ge 24 le 32
!
! ULA Tenant Ranges (Generated via loop)
{% for id in range(100, 104) %}
ipv6 prefix-list PL_TENANT_V6 seq {{ loop.index * 5 }} permit fd00:{{ id }}::/64 le 128
{% endfor %}
!
! Cluster pod + LB pools (explicit ranges)
ipv6 prefix-list PL_TENANT_V6 seq 25 permit fd00:101:224::/60 le 128
ipv6 prefix-list PL_TENANT_V6 seq 30 permit fd00:101:250::/112 le 128
!
! GUA Tenant Ranges (AT&T Fiber Residential Block)
! Permitting broader block to handle dynamic PD rotation
ipv6 prefix-list PL_TENANT_V6 seq 100 permit 2600:1700::/28 le 128
!
! -----------------------------------------------------------------------------
! ROUTE MAPS
! -----------------------------------------------------------------------------
! Underlay: Export Loopbacks and Ceph Services into OSPF
route-map RM_OSPF_EXPORT permit 10
 match ip address prefix-list PL_INFRA_V4
 match ipv6 address prefix-list PL_INFRA_V6
!
route-map RM_OSPF_EXPORT permit 20
 match ipv6 address prefix-list PL_SVCS_V6
!
! Edge Export: Force Next-Hop to local PVE identity for MikroTik
route-map RM_EDGE_EXPORT permit 10
 match ip address prefix-list PL_TENANT_V4
 set ip next-hop {{ infra_ip4 }}
!
route-map RM_EDGE_EXPORT permit 20
 match ipv6 address prefix-list PL_TENANT_V6
 set ipv6 next-hop global {{ infra_ip6 }}
!
! Leak Down: Global -> VRF (Default Route only)
route-map RM_GLOBAL_TO_VRF permit 10
 match ip address prefix-list PL_DEFAULT_V4
route-map RM_GLOBAL_TO_VRF permit 20
 match ipv6 address prefix-list PL_DEFAULT_V6
!
! Leak Up: VRF -> Global (Tenant routes only)
route-map RM_VRF_TO_GLOBAL permit 10
 match ip address prefix-list PL_TENANT_V4
route-map RM_VRF_TO_GLOBAL permit 20
 match ipv6 address prefix-list PL_TENANT_V6
!
! -----------------------------------------------------------------------------
! NEXT-HOP TRACKING - Allow BGP to use default route for next-hop resolution
! -----------------------------------------------------------------------------
ip nht resolve-via-default
ipv6 nht resolve-via-default
!
! -----------------------------------------------------------------------------
! UNDERLAY (OSPF / OSPF6) - The 25G Fabric
! -----------------------------------------------------------------------------
router ospf
 ospf router-id {{ infra_ip4 }}
 redistribute connected route-map RM_OSPF_EXPORT
!
! OSPF Interface Costs (Primary: mesh=10, Backup: vmbr0.10=1000)
{% for link in mesh_links[inventory_hostname] %}
interface {{ link.iface }}
 ip ospf area 0.0.0.0
 ip ospf cost 10
 ipv6 ospf6 area 0.0.0.0
 ipv6 ospf6 cost 10
!
{% endfor %}
interface vmbr0.10
 ip ospf area 0.0.0.0
 ip ospf cost 1000
 ipv6 ospf6 area 0.0.0.0
 ipv6 ospf6 cost 1000
!
interface lo-infra
 ipv6 ospf6 area 0.0.0.0
!
interface lo-svcs
 ipv6 ospf6 area 0.0.0.0
!
router ospf6
 ospf6 router-id {{ infra_ip4 }}
 redistribute connected route-map RM_OSPF_EXPORT
!
! -----------------------------------------------------------------------------
! BGP GLOBAL (EVPN & Edge Peering)
! -----------------------------------------------------------------------------
router bgp 4200001000
 bgp router-id {{ infra_ip4 }}
 no bgp default ipv4-unicast
 bgp bestpath as-path multipath-relax
2 !
 ! iBGP Mesh: EVPN Transport over 25G Links
 neighbor IBGP_MESH peer-group
 neighbor IBGP_MESH remote-as 4200001000
 neighbor IBGP_MESH update-source lo-infra
{% for peer_id in [1,2,3] if peer_id != node_id %}
 neighbor fd00:0:0:ffff::{{ peer_id }} peer-group IBGP_MESH
{% endfor %}
 !
 ! Edge: MikroTik Peering
 neighbor 10.255.0.254 remote-as 4200000000
 neighbor 10.255.0.254 update-source lo-infra
 neighbor 10.255.0.254 ebgp-multihop 2
 neighbor 10.255.0.254 timers 10 30
 neighbor fd00:0:0:ffff::fffe remote-as 4200000000
 neighbor fd00:0:0:ffff::fffe update-source lo-infra
 neighbor fd00:0:0:ffff::fffe ebgp-multihop 2
 neighbor fd00:0:0:ffff::fffe timers 10 30
 !
 ! Cross-Connect Pipe (Global Side)
 neighbor {{ pipe_vrf }} remote-as 4200001000
 neighbor {{ pipe_vrf }} description "INTERNAL_LINK_TO_VRF"
 neighbor {{ pipe_vrf }} capability extended-nexthop
 !
 address-family ipv4 unicast
  neighbor 10.255.0.254 activate
  neighbor 10.255.0.254 route-map RM_EDGE_EXPORT out
  neighbor {{ pipe_vrf }} activate
  neighbor {{ pipe_vrf }} next-hop-self
  neighbor {{ pipe_vrf }} route-map RM_VRF_TO_GLOBAL in
  neighbor {{ pipe_vrf }} route-map RM_GLOBAL_TO_VRF out
  maximum-paths 4
 exit-address-family
 !
 address-family ipv6 unicast
  neighbor fd00:0:0:ffff::fffe activate
  neighbor fd00:0:0:ffff::fffe route-map RM_EDGE_EXPORT out
  neighbor {{ pipe_vrf }} activate
  neighbor {{ pipe_vrf }} route-map RM_VRF_TO_GLOBAL in
  neighbor {{ pipe_vrf }} route-map RM_GLOBAL_TO_VRF out
  maximum-paths 4
 exit-address-family
 !
 address-family l2vpn evpn
  neighbor IBGP_MESH activate
  advertise-all-vni
 exit-address-family
!
! -----------------------------------------------------------------------------
! BGP VRF (Tenant Workloads & Talos)
! -----------------------------------------------------------------------------
router bgp 4200001000 vrf vrf_evpnz1
 bgp router-id {{ vrf_router_id }}
 !
 ! Dynamic Peering (Talos / VMs)
 neighbor VMS peer-group
 neighbor VMS remote-as external
 neighbor VMS passive
 neighbor VMS capability extended-nexthop
{% for id in range(100, 104) %}
 bgp listen range fd00:{{ id }}::/64 peer-group VMS
 bgp listen range fd00:{{ id }}:fe::/64 peer-group VMS
{% endfor %}
 !
 ! Cross-Connect Pipe (VRF Side)
 neighbor {{ pipe_global }} remote-as 4200001000
 neighbor {{ pipe_global }} description "INTERNAL_LINK_TO_GLOBAL"
 neighbor {{ pipe_global }} capability extended-nexthop
 !
 address-family ipv4 unicast
  neighbor VMS activate
  neighbor {{ pipe_global }} activate
  neighbor {{ pipe_global }} next-hop-self
  redistribute connected
 exit-address-family
 !
 address-family ipv6 unicast
  neighbor VMS activate
  neighbor {{ pipe_global }} activate
  redistribute connected
 exit-address-family
!
{% endif %}
