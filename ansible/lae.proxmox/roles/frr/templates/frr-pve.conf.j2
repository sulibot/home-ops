{# ---------- Host-scoped helpers ---------- #}
{% set HAS_MESH   = inventory_hostname in ['pve01','pve02','pve03'] %}
{% set PVE_ID     = inventory_hostname | regex_replace('^pve0?', '') | int %}

{# ASNs:
   - Edge (MikroTik):      4200000000   # RouterOS
   - PVE underlay iBGP:    4200001000
   - K8s clusters (Talos/Cilium, not used directly here):
       * cluster-101:      4220101000
       * cluster-102:      4220102000
       * cluster-103:      4220103000
#}
{% set PVE_ASN    = PVE_ASN    | default(4200001000) %}
{% set EDGE_ASN   = EDGE_ASN   | default(4200000000) %}
{# Edge peer over IPv6 transport: RouterOS fd00:255::fffe #}
{% set EDGE_V6_PEER = EDGE_V6_PEER | default('fd00:255::fffe') %}

! ======================================================================
! frr-pve.conf.local.j2
!
! Local FRR config for Proxmox PVE nodes:
! - iBGP underlay over 25G mesh interfaces (MTU 9000, IPv6-only)
! - Redistribute:
!     * Infra loopbacks: fd00:255::N/128
!     * Tenant anycast gateways: fd00:<vlan>::fffe/128
!     * Ceph loopbacks: fc00:20::N/128 and fc00:21::N/128
! - Edge eBGP to MikroTik (separate IPv4 and IPv6 sessions) in AS {{ EDGE_ASN }}
!
! NOTE: Linux must have a route to {{ EDGE_V6_PEER }} (e.g. fd00:255::/64
!       on the RouterOS-facing interface or a static /128 route), otherwise
!       the BGP session cannot establish.
! ======================================================================

{% if HAS_MESH %}

! ---------- Prefix-lists for connected exports ----------

ipv6 prefix-list PVE_CONNECTED_V6 permit fd00:255::/48 le 128
ipv6 prefix-list PVE_CONNECTED_V6 permit fc00:20::/64  le 128
ipv6 prefix-list PVE_CONNECTED_V6 permit fc00:21::/64  le 128
{% for vlan_id in TENANT_VLANS | sort %}
ipv6 prefix-list PVE_CONNECTED_V6 permit fd00:{{ vlan_id }}::/64 le 128
{% endfor %}
ipv6 prefix-list PVE_CONNECTED_V6 deny   ::/0 le 128

route-map EXPORT_V6_CONNECTED permit 10
  match ipv6 address prefix-list PVE_CONNECTED_V6
exit

! Export 10.255.0.N/32 (dummy_underlay v4 loopback) to BGP
ip prefix-list PVE_CONNECTED_V4 permit 10.255.0.0/16 le 32

route-map EXPORT_V4_CONNECTED permit 10
  match ip address prefix-list PVE_CONNECTED_V4
exit

! Accept Talos pod CIDRs and loopbacks
ip prefix-list TALOS_POD_CIDRS permit 10.101.0.0/16 le 32
ip prefix-list TALOS_LOOPBACKS permit 10.255.101.0/24 le 32

ipv6 prefix-list TALOS_POD_CIDRS_V6 permit fd00:101::/60 le 128
ipv6 prefix-list TALOS_LOOPBACKS_V6 permit fd00:255:101::/120 le 128

route-map IMPORT_TALOS permit 10
  match ip address prefix-list TALOS_POD_CIDRS
exit
route-map IMPORT_TALOS permit 20
  match ip address prefix-list TALOS_LOOPBACKS
exit
route-map IMPORT_TALOS permit 30
  match ipv6 address prefix-list TALOS_POD_CIDRS_V6
exit
route-map IMPORT_TALOS permit 40
  match ipv6 address prefix-list TALOS_LOOPBACKS_V6
exit

! Export default route to Talos
ip prefix-list DEFAULT_V4 permit 0.0.0.0/0
ipv6 prefix-list DEFAULT_V6 permit ::/0

route-map EXPORT_TO_TALOS permit 10
  match ip address prefix-list DEFAULT_V4
exit
route-map EXPORT_TO_TALOS permit 20
  match ipv6 address prefix-list DEFAULT_V6
exit

! ---------- BGP Underlay (iBGP within PVE AS {{ PVE_ASN }}) ----------

router bgp {{ PVE_ASN }}
  bgp router-id 10.0.10.{{ PVE_ID }}
  no bgp default ipv4-unicast
  timers bgp 10 30

  ! iBGP neighbors over mesh links (IPv6 LL on each interface)
{% for link in mesh_links[inventory_hostname] %}
  neighbor {{ link.iface }} interface remote-as {{ PVE_ASN }}
  neighbor {{ link.iface }} description "iBGP mesh link on {{ link.iface }}"
{% endfor %}

  ! Dynamic BGP neighbors for Talos cluster-101 VMs (link-local on vmbr0.101)
  neighbor TALOS_CLUSTER_101 peer-group
  neighbor TALOS_CLUSTER_101 remote-as 4210101000-4210101999
  neighbor TALOS_CLUSTER_101 capability extended-nexthop
  neighbor TALOS_CLUSTER_101 description "Talos cluster-101 link-local peering"
  neighbor TALOS_CLUSTER_101 ebgp-multihop 2

  bgp listen range fe80::/10 peer-group TALOS_CLUSTER_101

  ! Edge eBGP to MikroTik - separate IPv4 and IPv6 sessions
  ! IPv6 session for IPv6 routes
  neighbor {{ EDGE_V6_PEER }} remote-as {{ EDGE_ASN }}
  neighbor {{ EDGE_V6_PEER }} description "MikroTik edge (IPv6 only)"
  neighbor {{ EDGE_V6_PEER }} update-source fd00:255::{{ PVE_ID }}
  neighbor {{ EDGE_V6_PEER }} ebgp-multihop 5

  ! IPv4 session for IPv4 routes
  neighbor 10.255.255.254 remote-as {{ EDGE_ASN }}
  neighbor 10.255.255.254 description "MikroTik edge (IPv4 only)"
  neighbor 10.255.255.254 update-source 10.255.0.{{ PVE_ID }}
  neighbor 10.255.255.254 ebgp-multihop 5

  address-family ipv6 unicast
    redistribute connected route-map EXPORT_V6_CONNECTED
    neighbor {{ EDGE_V6_PEER }} activate
    neighbor {{ EDGE_V6_PEER }} route-map EXPORT_V6_CONNECTED out
    neighbor {{ EDGE_V6_PEER }} next-hop-self

    ! Talos cluster-101 peering
    neighbor TALOS_CLUSTER_101 activate
    neighbor TALOS_CLUSTER_101 route-map IMPORT_TALOS in
    neighbor TALOS_CLUSTER_101 route-map EXPORT_TO_TALOS out

    maximum-paths 4
    maximum-paths ibgp 4
  exit-address-family

  address-family ipv4 unicast
    redistribute connected route-map EXPORT_V4_CONNECTED
    neighbor 10.255.255.254 activate
    neighbor 10.255.255.254 route-map EXPORT_V4_CONNECTED out
    neighbor 10.255.255.254 next-hop-self

    ! Talos cluster-101 peering (MP-BGP over IPv6)
    neighbor TALOS_CLUSTER_101 activate
    neighbor TALOS_CLUSTER_101 route-map IMPORT_TALOS in
    neighbor TALOS_CLUSTER_101 route-map EXPORT_TO_TALOS out

    maximum-paths 4
    maximum-paths ibgp 4
  exit-address-family

exit

{% endif %}
