---
# Configure IPv6 GUA addressing on Proxmox SDN VNets
# Uses Proxmox SDN API (pvesh) to add GUA subnets alongside existing ULA subnets

- name: Add GUA subnet to VNet via pvesh
  ansible.builtin.command: >
    pvesh create /cluster/sdn/vnets/{{ item.key }}/subnets
    --subnet {{ item.value }}
    --gateway {{ item.value | regex_replace('::/64', '::ffff') }}
    --type subnet
  loop: "{{ delegated_prefixes | dict2items }}"
  register: subnet_add
  failed_when:
    - subnet_add.rc != 0
    - '"already exists" not in subnet_add.stderr'
  changed_when: subnet_add.rc == 0

- name: Apply SDN configuration
  ansible.builtin.command: pvesh set /cluster/sdn
  when: subnet_add is changed
  notify: reload frr
