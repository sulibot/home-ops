---
# Main tasks for test VM network configuration

- name: Install required packages
  ansible.builtin.apt:
    name:
      - frr
      - frr-pythontools
      - netplan.io
    state: present
    update_cache: yes
  become: yes

- name: Disable cloud-init network configuration
  ansible.builtin.copy:
    dest: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    content: "network: {config: disabled}\n"
    owner: root
    group: root
    mode: '0644'
  become: yes

- name: Deploy netplan configuration
  ansible.builtin.template:
    src: netplan.yaml.j2
    dest: /etc/netplan/50-cloud-init.yaml
    owner: root
    group: root
    mode: '0600'
  become: yes
  notify: apply netplan

- name: Configure ND/ARP notifications for EVPN learning
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-evpn-notify.conf
    state: present
    reload: yes
  loop:
    - { name: 'net/ipv6/conf/all/ndisc_notify',     value: '1' }
    - { name: 'net/ipv6/conf/default/ndisc_notify', value: '1' }
    - { name: 'net/ipv6/conf/eth0/ndisc_notify',    value: '1' }
    - { name: 'net/ipv4/conf/all/arp_notify',       value: '1' }
    - { name: 'net/ipv4/conf/default/arp_notify',   value: '1' }
    - { name: 'net/ipv4/conf/eth0/arp_notify',      value: '1' }
  become: yes

- name: Deploy FRR daemons configuration
  ansible.builtin.template:
    src: frr-daemons.j2
    dest: /etc/frr/daemons
    owner: frr
    group: frr
    mode: '0640'
  become: yes
  notify: restart frr

- name: Deploy FRR configuration
  ansible.builtin.template:
    src: frr.conf.j2
    dest: /etc/frr/frr.conf
    owner: frr
    group: frr
    mode: '0640'
    backup: yes
  become: yes
  notify: restart frr

- name: Enable and start FRR service
  ansible.builtin.systemd:
    name: frr
    enabled: yes
    state: started
  become: yes
