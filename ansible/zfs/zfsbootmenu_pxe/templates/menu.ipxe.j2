#!ipxe

# Vars
set menu-timeout 5000
set zbm_url {{ http_web_root }}/zfsbootmenu.efi

:start
menu ZFSBootMenu PXE Boot Menu
{% for node in groups['pve'] %}
item --key {{ loop.index }} {{ node }} Boot {{ node }}
{% endfor %}
item --gap -- Tools
item --key n netboot  Netboot.xyz
item --key s shell    iPXE Shell
item --key x exit     Exit to BIOS

choose --timeout ${menu-timeout} selected || goto cancel
goto ${selected}

:netboot
    chain --replace https://boot.netboot.xyz/ipxe.netboot.xyz.efi || goto failed
    goto start

:shell
    shell
    goto start

:cancel
    echo No selection — launching shell
    shell
    goto start

:exit
    exit

:failed
    echo Boot failed — returning to menu
    goto start

{% for node in groups['pve'] %}
:{{ node }}
echo Booting {{ node }} via ZFSBootMenu...
chain ${zbm_url} || goto shell
goto start
{% endfor %}