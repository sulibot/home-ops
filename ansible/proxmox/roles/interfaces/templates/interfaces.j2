{% set node_id = inventory_hostname[-1] | int %}
{% set peer_id = 6 - node_id %}

# ============================================================
# Proxmox VE Network Configuration â€“ {{ inventory_hostname }}
# ============================================================

auto lo
iface lo inet loopback
    address 10.255.255.{{ node_id }}/32

    address 10.0.10.{{ node_id }}/32
    {% for vlan in [100,101,102,103] %}
    address 10.0.{{ vlan }}.{{ node_id }}/32
    {% endfor %}

    address 10.0.10.254/32
    {% for vlan in [100,101,102,103] %}
    address 10.0.{{ vlan }}.254/32
    {% endfor %}

iface lo inet6 static
    address fd00:255::{{ node_id }}/128

    address fd00:10::{{ node_id }}/128
    {% for vlan in [100,101,102,103] %}
    address fd00:{{ vlan }}::{{ node_id }}/128
    {% endfor %}

    {# anycast loopbacks #}
    {% for prefix in [10,100,101,102,103] %}
    address fd00:{{ prefix }}::fffe/128
    {% endfor %}
    address fc00:20::{{ node_id }}/128
    address fc00:21::{{ node_id }}/128


# Bonded trunk
auto bond0
iface bond0 inet manual
    bond-slaves enp3s0 enp4s0
    bond-mode 802.3ad
    bond-miimon 100
    mtu 1500

# VLAN 5 as untagged on bond0.5
auto bond0.5
iface bond0.5 inet static
    address 10.0.5.{{ node_id }}/24
    gateway 10.0.5.254
    mtu 1500

iface bond0.5 inet6 static
    address fd00:5::{{ node_id }}/64
    gateway fd00:5::fffe

# VLAN 8 - Infra bridge
auto vmbr8
iface vmbr8 inet manual
    bridge-ports bond0.8
    bridge-stp off
    bridge-fd 0
    mtu 1500

# VLAN 9 - Native
auto vmbr9
iface vmbr9 inet static
    address 10.0.9.{{ node_id }}/24
    gateway 10.0.9.254
    bridge-ports bond0
    bridge-stp off
    bridge-fd 0
    mtu 1500

iface vmbr9 inet6 static
    address fd00:9::{{ node_id }}/64
    gateway fd00:9::fffe

# VLAN 10 - Management
auto vmbr10
iface vmbr10 inet manual
    bridge-ports bond0.10
    bridge-stp off
    bridge-fd 0
    mtu 1500

# VLAN 100-103 bridges
{% for vlan in [100,101,102,103] %}
auto vmbr{{ vlan }}
iface vmbr{{ vlan }} inet manual
    bridge-ports bond0.{{ vlan }}
    bridge-stp off
    bridge-fd 0
    mtu 1500

{% endfor %}

# Dummy interface for VM mesh L3
auto dummy0
iface dummy0 inet manual
    pre-up modprobe dummy
    pre-up ip link add dummy0 type dummy || true
    pre-up ip link set dummy0 up
    post-down ip link del dummy0 || true

# vmbr1: Bridge backed by dummy0 (MTU 9000)
auto mesh0
iface mesh0 inet manual
    mtu 9000
    bridge-ports dummy0
    bridge-stp off
    bridge-fd 0

# Mesh ring links
auto enp1s0f0np0
iface enp1s0f0np0 inet static
    mtu 9000
    address 10.99.13.{{ node_id }}/31
#    pointopoint 10.99.13.{{ peer_id }}
iface enp1s0f0np0 inet6 manual

auto enp1s0f1np1
iface enp1s0f1np1 inet static
    mtu 9000
    address 10.99.12.{{ node_id }}/31
#    pointopoint 10.99.12.{{ peer_id }}
iface enp1s0f1np1 inet6 manual

# Include drop-ins
source /etc/network/interfaces.d/*
