# Taskfile.yaml
version: '3'

vars:
  INVENTORY: inventory/hosts.ini
  ANSIBLE_FLAGS: "-i ${INVENTORY} --forks 10 --timeout 30"
  # If you want to run in check mode by default, uncomment:
  # ANSIBLE_FLAGS: "${ANSIBLE_FLAGS} --check"

tasks:
  # —————————————————————————————————————————————————————————————
  #  Render & Prep
  # —————————————————————————————————————————————————————————————

  render-vars:
    desc: Render per‐cluster variables
    cmds:
      - ansible-playbook ${ANSIBLE_FLAGS} tasks/render-cluster-vars.yaml

  # —————————————————————————————————————————————————————————————
  #  Stage 2 – Core Host Configuration
  # —————————————————————————————————————————————————————————————

  bootstrap-network:
    desc: Configure network primitives (bonds, bridges, VLANs)
    cmds:
      - ansible-playbook ${ANSIBLE_FLAGS} playbooks/stage2-bootstrap-network.yaml

  host-tuning:
    desc: Apply sysctl, BBR, proxy ARP/NDP, SSH, journald, fstrim
    cmds:
      - ansible-playbook ${ANSIBLE_FLAGS} playbooks/stage2-host-configuration.yaml

  configure-network:
    desc: Populate /etc/network/interfaces
    cmds:
      - ansible-playbook ${ANSIBLE_FLAGS} playbooks/stage2-configure-network.yaml

  configure-frr:
    desc: Deploy FRR (ISIS + BGP + anycast)
    cmds:
      - ansible-playbook ${ANSIBLE_FLAGS} playbooks/stage2-configure-frr.yaml

  # —————————————————————————————————————————————————————————————
  #  Stage 2 – Ceph & Destructive Operations
  #
  #  ⚠️ Requires confirmation each run
  # —————————————————————————————————————————————————————————————

  prep-ceph-disks:
    desc: "⚠️ Wipe & prep Ceph OSD disks (interactive confirmation)"
    confirm: "This will destroy all data on your Ceph OSD devices. Type 'YES' to proceed:"
    cmds:
      - >
        ansible-playbook ${ANSIBLE_FLAGS}
        playbooks/stage2-prep-ceph-disks.yaml
        --extra-vars "confirm_destruction=YES"

  # —————————————————————————————————————————————————————————————
  #  Composite tasks
  # —————————————————————————————————————————————————————————————

  stage2-all:
    desc: Run all non-destructive Stage 2 tasks in order
    deps:
      - render-vars
      - bootstrap-network
      - host-tuning
      - configure-network
      - configure-frr

  all:
    desc: Render vars, then Stage 2, then Ceph prep
    deps:
      - stage2-all
      - prep-ceph-disks
