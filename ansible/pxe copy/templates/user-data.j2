#cloud-config
hostname: {{ item }}
fqdn: {{ item }}.{{ hostname_domain }}
manage_etc_hosts: true

locale: {{ hostvars[item].locale | default(locale) }}
timezone: {{ hostvars[item].timezone | default(timezone) }}

# Install openssh-server so sshd is available
package_update: true
packages:
  - openssh-server
  - ifupdown

# Inject SSH public key
ssh_authorized_keys:
  - {{ hostvars[item].ssh_pubkey | default(ssh_pubkey) }}

# Write out /etc/network/interfaces to use ifupdown
write_files:
  - path: /etc/network/interfaces
    permissions: "0644"
    owner: root:root
    content: |
      # Generated by cloud-init
      auto lo
      iface lo inet loopback

      auto {{ hostvars[item].proxmox_nic }}
      iface {{ hostvars[item].proxmox_nic }} inet static
          address {{ hostvars[item].proxmox_ipv4 | regex_replace('/.*$','') }}
          netmask 255.255.255.0
          gateway {{ hostvars[item].proxmox_ipv4_gw }}
          dns-nameservers {{ hostvars[item].proxmox_dns[0] }} {{ hostvars[item].proxmox_dns[1] }}

      iface {{ hostvars[item].proxmox_nic }} inet6 static
          address {{ hostvars[item].proxmox_ipv6 | regex_replace('/.*$','') }}
          netmask 64
          gateway {{ hostvars[item].proxmox_ipv6_gw }}

# Run commands at first boot
runcmd:
  - [ /usr/bin/systemctl, "disable", "systemd-networkd.service" ]
  - [ /usr/bin/systemctl, "stop",    "systemd-networkd.service" ]
  - [ /usr/bin/apt-get, "update" ]
  - [ /usr/sbin/ifup, "-a" ]
  - [ /usr/bin/systemctl, "enable", "ssh" ]
  - [ /usr/bin/systemctl, "start",  "ssh" ]
  - [ "/usr/bin/zpool", "create", "-f", "{{ hostvars[item].zfs_pool }}", "mirror", "{{ hostvars[item].optane_disk }}", "{{ hostvars[item].nvme_disk }}", "-o", "{{ hostvars[item].zfs_options }}" ]
  - [ "/usr/bin/zfs", "create", "{{ hostvars[item].zfs_pool }}/ROOT" ]
  - [ "/usr/bin/zfs", "create", "-o", "mountpoint=/", "{{ hostvars[item].zfs_pool }}/ROOT/debian" ]
  - [ "/usr/bin/zfs", "create", "-o", "mountpoint=/var/lib/vz", "{{ hostvars[item].zfs_pool }}/vmdata" ]
  - [ "/usr/bin/zpool", "set", "bootfs={{ hostvars[item].zfs_pool }}/ROOT/debian", "{{ hostvars[item].zfs_pool }}" ]
  - [ "/usr/sbin/mkfs.vfat", "-F32", "{{ hostvars[item].optane_efi }}" ]
  - [ "/usr/sbin/mkfs.vfat", "-F32", "{{ hostvars[item].nvme_efi }}" ]
  - [ "/bin/mkdir", "-p", "/boot/efi" ]
  - [ "/bin/mount", "{{ hostvars[item].optane_efi }}", "/boot/efi" ]
  - [ "/usr/sbin/grub-install", "--target=x86_64-efi", "--efi-directory=/boot/efi", "--bootloader-id=debian", "--recheck", "--no-nvram", "--removable" ]
  - [ "/bin/umount", "/boot/efi" ]
  - [ "/bin/mount", "{{ hostvars[item].nvme_efi }}", "/boot/efi" ]
  - [ "/usr/sbin/grub-install", "--target=x86_64-efi", "--efi-directory=/boot/efi", "--bootloader-id=debian", "--recheck", "--no-nvram", "--removable" ]
  - [ "/usr/sbin/update-initramfs", "-u" ]
  - [ "/bin/sh", "-c", "echo '{{ hostvars[item].pve_apt_repo }}' > /etc/apt/sources.list.d/pve-install-repo.list" ]
  - [ "/usr/bin/wget", "-qO-", "{{ hostvars[item].pve_apt_key }}", "|", "tee", "/etc/apt/trusted.gpg.d/proxmox.gpg" ]
  - [ "/usr/bin/apt-get", "update" ]
  - [ "/usr/bin/apt-get", "-y", "install", "{{ hostvars[item].pkgsel_include | join(' ') }}" ]
  - [ "/usr/bin/systemctl", "disable", "apt-daily.service", "apt-daily-upgrade.service" ]
  - [ "/usr/bin/reboot" ]