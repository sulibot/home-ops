---
- name: "A) Prepare RouterOS for TFTP + iPXE menu"
  hosts: pxe_servers
  gather_facts: no
  vars_files:
    - group_vars/pve.yml
  collections:
    - community.routeros
    - ansible.netcommon
  roles:
    - role: pxe_routeros


- name: "C) Publish HTTP files into /srv/webroot/pxe/ on Infra Web Server"
  hosts: caddy
  gather_facts: no
  vars_files:
    - group_vars/pve.yml
  tasks:
    - name: Ensure /srv/webroot/pxe/ exists
      ansible.builtin.file:
        path: /srv/webroot/pxe
        state: directory
        owner: caddy
        group: caddy
        mode: '0755'
        recurse: yes

    - name: Render menu.ipxe.j2 to HTTP PXE webroot
      ansible.builtin.template:
        src: menu.ipxe.j2
        dest: /srv/webroot/pxe/menu.ipxe
        mode: '0644'

    - name: Ensure base directories exist under /srv/webroot/pxe/proxmox
      ansible.builtin.file:
        path: /srv/webroot/pxe/proxmox/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64
        state: directory
        owner: caddy
        group: caddy
        mode: '0755'

    - name: Ensure user-data directory exists under /srv/webroot/pxe/proxmox
      ansible.builtin.file:
        path: /srv/webroot/pxe/proxmox/user-data
        state: directory
        owner: caddy
        group: caddy
        mode: '0755'
        recurse: yes

    - name: Copy Debian netboot linux kernel to Caddy webroot
      ansible.builtin.get_url:
        url: "http://deb.debian.org/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64/linux"
        dest: "/srv/webroot/pxe/proxmox/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64/linux"
        owner: caddy
        group: caddy
        mode: '0755'

    - name: Copy Debian netboot initrd.gz to Caddy webroot
      ansible.builtin.get_url:
        url: "http://deb.debian.org/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64/initrd.gz"
        dest: "/srv/webroot/pxe/proxmox/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64/initrd.gz"
        owner: caddy
        group: caddy
        mode: '0755'

    - name: Template and copy cloud-init user-data for each PVE host
      ansible.builtin.template:
        src: "../templates/user-data.j2"
        dest: "/srv/webroot/pxe/proxmox/user-data/{{ item }}-user-data.yml"
        owner: caddy
        group: caddy
        mode: '0755'
      loop: "{{ groups['pve'] }}"
