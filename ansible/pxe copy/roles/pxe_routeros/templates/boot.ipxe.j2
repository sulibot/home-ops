#!ipxe
#
# {{ inventory_hostname }} PXE menu generated by Ansible
#

# Base URLs for installer and cloud-init userdata
set installer_url {{ http_web_root }}{{ installer_subpath }}
set userdata_url  {{ http_web_root }}{{ user_data_base }}

# Positional menu title
menu --name pxemenu "Proxmox PXE Boot Menu"
item --gap --           Boot Options
item --key n netboot    Launch netboot.xyz
item --key a auto       Auto Boot
{% for host in groups['pve'] %}
item --key {{ loop.index }} {{ host }} Install {{ host }}
{% endfor %}
item --gap --           Tools
item --key s shell      iPXE Shell

# Launch the selected entry
enable-menu
enable-text
choose --menu pxemenu --timeout 5000 target && goto ${target}

# Default to first host if no selection
:auto
  echo "Defaulting to install {{ groups['pve'][0] }}"
  goto {{ groups['pve'][0] }}

# Per-host installation entries
{% for host in groups['pve'] %}
:{{ host }}
  echo "Installing {{ host }}"
  kernel ${installer_url}/linux \
        auto=true \
        ds="nocloud-net;s=${userdata_url}/{{ host }}-user-data.yml" \
        hostname={{ host }} domain={{ hostname_domain }}
  initrd ${installer_url}/initrd.gz
  boot
{% endfor %}

# Netboot.xyz fallback
:netboot
  echo "Chainloading netboot.xyz"
  chain --replace {{ netboot_url }}

# Drop to interactive shell
:shell
  echo "Dropping to iPXE shell"
  shell
