#!ipxe

# Vars
set menu-timeout 5000
set submenu-timeout ${menu-timeout}
set inst_base {{ http_web_root }}{{ installer_subpath }}

:start
echo >>> Starting Proxmox PXE Menu
menu Proxmox PXE Boot Menu
{% for host in groups['pve'] %}
item --key {{ loop.index }} {{ host }}   Install {{ host }}
{% endfor %}
item --gap -- Tools
item --key n netboot  Netboot.xyz
item --key s shell    iPXE Shell
item --key x exit     Exit to BIOS

choose --timeout ${menu-timeout} selected || goto cancel
goto ${selected}

:netboot
    chain --replace https://boot.netboot.xyz/ipxe.netboot.xyz.efi || goto failed
    goto start

:shell
    shell
    goto start

:cancel
    echo No selection — launching shell
    shell
    goto start

:exit
    exit

:failed
    echo Boot failed — returning to menu
    goto start

{% for host in groups['pve'] %}
:{{ host }}
echo Installing {{ host }}...
kernel ${inst_base}/linux \
    auto=true \
    ds=nocloud-net;s={{ http_web_root }}/pxe/proxmox/{{ host }}/ \
    hostname={{ host }} domain={{ hostname_domain }}
initrd ${inst_base}/initrd.gz
boot || goto failed
goto start
{% endfor %}
