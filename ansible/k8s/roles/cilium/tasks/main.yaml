# roles/cilium/tasks/main.yaml
---
- name: Write Cilium values file
  ansible.builtin.copy:
    # Extract values from the HelmRelease spec['values']
    content: "{{ (lookup('file', playbook_dir + '/../../../kubernetes/manifests/platform/cni/cilium/app/helmrelease.yaml') | from_yaml)['spec']['values'] | to_nice_yaml }}"
    dest: "{{ cilium_config_file }}"
    mode: "0644"
  become: true

- name: Add Cilium Helm repo
  community.kubernetes.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io
    state: present
  become: true

- name: Install or upgrade Cilium via Helm
  kubernetes.core.helm:
    chart_ref: cilium/cilium
    chart_version: "1.18"
    release_name: cilium
    release_namespace: kube-system
    create_namespace: true
    values_files:
      - "{{ cilium_config_file }}"
    dependency_update: true
    atomic: true
    wait: true
    timeout: 1200s
  become: true
