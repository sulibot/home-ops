# roles/k8s_init/tasks/main.yaml

- name: Check if control-plane is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: kubeadm_init_stat

- name: Temporarily add VIP to interface for kubeadm init
  ansible.builtin.shell: |
    ip -6 addr add {{ control_plane_vip }}/128 dev {{ kube_vip_interface }} 2>/dev/null || true
  when: not kubeadm_init_stat.stat.exists

- name: Render kubeadm-init.yaml (first CP only)
  template:
    src: ../../../templates/kubeadm-init.yaml.j2
    dest: /root/kubeadm-init.yaml
  when: not kubeadm_init_stat.stat.exists

- name: Run kubeadm init (first control-plane)
  ansible.builtin.command:
    argv:
      - kubeadm
      - init
      - --config
      - /root/kubeadm-init.yaml
      - --upload-certs
  args:
    creates: /etc/kubernetes/admin.conf
  when: not kubeadm_init_stat.stat.exists

- name: Wait for kube-apiserver port to be open
  ansible.builtin.wait_for:
    host: "{{ control_plane_vip }}"
    port: 6443
    timeout: 60
  when: not kubeadm_init_stat.stat.exists

- name: Create RBAC for anonymous cluster-info access (required for node joins)
  ansible.builtin.shell: |
    export KUBECONFIG=/etc/kubernetes/super-admin.conf
    cat <<'EOF' | kubectl apply -f -
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: kubeadm:public-info-viewer
    rules:
    - apiGroups: ['']
      resources: ['configmaps']
      resourceNames: ['cluster-info']
      verbs: ['get']
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: kubeadm:public-info-viewer
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: kubeadm:public-info-viewer
    subjects:
    - apiGroup: rbac.authorization.k8s.io
      kind: Group
      name: system:unauthenticated
    EOF
  args:
    executable: /bin/bash
  become: true
  when: not kubeadm_init_stat.stat.exists

- name: Create remote kube dir
  file:
    path: /root/.kube
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Install admin.conf on the host
  copy:
    remote_src: yes
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    owner: root
    group: root
    mode: '0644'

- name: Create local kube dir
  delegate_to: localhost
  run_once: true
  become: false
  file:
    path: "{{ lookup('env','HOME') }}/.kube"
    state: directory
    mode: '0755'


- name: Fetch remote kubeconfig to local machine
  run_once: true
  fetch:
    src: /etc/kubernetes/admin.conf
    dest: /Users/sulibot/.kube/config
    flat: yes
