- name: Ensure kubeâ€‘vip manifest directory exists
  ansible.builtin.file:
    path: /etc/kubernetes/manifests
    state: directory
    mode: '0755'

- name: Check if kube-vip manifest exists
  ansible.builtin.stat:
    path: /etc/kubernetes/manifests/kube-vip.yaml
  register: kubevip_manifest

- name: Fetch latest kube-vip version
  ansible.builtin.shell: |
    curl -sL https://api.github.com/repos/kube-vip/kube-vip/releases \
    | jq -r "[.[] | select(.prerelease == false)][0].name"
  register: kubevip_version
  changed_when: false
  when: not kubevip_manifest.stat.exists

- name: Generate kube-vip manifest with ARP/ND
  ansible.builtin.shell: |
    ctr image pull ghcr.io/kube-vip/kube-vip:{{ kubevip_version.stdout }}
    ctr run --rm --net-host ghcr.io/kube-vip/kube-vip:{{ kubevip_version.stdout }} vip /kube-vip manifest pod \
      --interface {{ kube_vip_interface }} \
      --address {{ control_plane_vip }} \
      --controlplane \
      --arp \
      --leaderElection > /etc/kubernetes/manifests/kube-vip.yaml
  args:
    executable: /bin/bash
    chdir: /root
  register: kubevip_manifest
  changed_when: true
  when: not kubevip_manifest.stat.exists

#- name: Write kube-vip static pod manifest
#  ansible.builtin.copy:
#    content: "{{ kubevip_manifest.stdout }}"
#    dest: /etc/kubernetes/manifests/kube-vip.yaml
#  when: not kubevip_manifest.stat.exists
