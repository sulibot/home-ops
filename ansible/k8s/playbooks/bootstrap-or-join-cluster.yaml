---
# 0) Preflight: Prepare all cluster nodes
- name: "Preflight: Prepare all cluster nodes"
  hosts: all
  become: true
  gather_facts: true
  vars_files:
    - "../group_vars/all.yaml"
  roles:
    - common


# 1) Bootstrap primary control-plane
- name: "Bootstrap primary control-plane"
  hosts: "{{ groups['controlplane'][0] }}"
  become: true
  gather_facts: true
  vars_files:
    - "../group_vars/all.yaml"
  vars:
    kubeconfig:        /etc/kubernetes/admin.conf
    super_admin_conf:  /etc/kubernetes/super-admin.conf
  roles:
    - kubevip
    - k8s_init


# 2) Generate join credentials
- name: "Generate join credentials"
  hosts: "{{ groups['controlplane'][0] }}"
  become: true
  gather_facts: false
  vars_files:
    - "../group_vars/all.yaml"
  roles:
    - k8s_generate_join_creds


# 3) Join additional control-planes
- name: "Join additional control-planes"
  hosts: "{{ groups['controlplane'][1:] }}"
  become: true
  gather_facts: true
  serial: 1
  vars_files:
    - "../group_vars/all.yaml"
  roles:
    - etcd_member
    - k8s_join_controlplane


# 4) Join worker nodes
- name: "Join worker nodes"
  hosts: worker
  become: true
  gather_facts: true
  vars_files:
    - "../group_vars/all.yaml"
  roles:
    - k8s_join_worker
