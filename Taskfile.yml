# =============================================================================
# Home-Ops Task Management
# =============================================================================
#
# Unified task runner for Kubernetes cluster lifecycle management
#
# QUICK START
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#   task cluster:create -- 101         # Create complete cluster (~15-20 min)
#   task flux:install -- 101           # Install Flux GitOps
#   task status:cluster                # Check cluster health
#
# WORKFLOWS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Creating a Cluster:
#   1. task infra:provision -- 101     # Provision VMs on Proxmox
#   2. task talos:secrets -- 101       # Generate encrypted secrets
#   3. task talos:config -- 101        # Generate machine configs
#   4. task cluster:bootstrap -- 101   # Bootstrap cluster + CNI
#   5. task flux:install -- 101        # Install Flux for GitOps
#
# Daily Operations:
#   task status:all                    # Full health check
#   task flux:reconcile                # Force Flux sync
#   task logs:talos -- 101             # View Talos logs
#   task logs:pod -- <namespace/pod>   # View pod logs
#
# Maintenance:
#   task ops:drain -- <node>           # Drain node for maintenance
#   task ops:upgrade:talos -- 101      # Upgrade Talos version
#   task backup:etcd                   # Backup etcd cluster
#
# Troubleshooting:
#   task debug:events                  # Watch cluster events
#   task debug:network                 # Test network connectivity
#   task status:cilium                 # Check Cilium health
#
# üìö Documentation: https://github.com/sulibot/home-ops/docs
#

version: '3'

vars:
  CLUSTER_ID: '{{.CLI_ARGS | default .CLUSTER_ID | default "101"}}'
  CLUSTER_NAME: '{{.CLUSTER_ID}}'
  TALOS_TEMPLATE: 'templates/talconfig.j2'

tasks:
  default:
    desc: 'Show interactive menu'
    cmds:
      - task: menu

  list:
    desc: 'üìã Interactive task browser with search'
    summary: |
      Browse all available tasks with arrow keys and fuzzy search.

      Usage: task list

      Features:
        - Arrow keys to navigate
        - Type to fuzzy search
        - Enter to see task details
        - Press Ctrl+C to exit
    cmds:
      - |
        #!/bin/bash
        set -e

        if ! command -v gum &> /dev/null; then
          echo "‚ùå Gum not installed - showing plain list"
          task --list-all
          exit 0
        fi

        while true; do
          # Get all tasks and format them
          TASKS=$(task --list-all 2>/dev/null | grep '^\*' | sed 's/^* //')

          # Use gum filter for fuzzy search with arrow keys
          # Shows 30 lines at once, supports Page Up/Down
          SELECTED=$(echo "$TASKS" | gum filter \
            --placeholder "Search tasks (type to filter, ‚Üë‚Üì or PgUp/PgDn to navigate)..." \
            --height 30 \
            --prompt "‚Üí " || true)

          if [ -z "$SELECTED" ]; then
            # User pressed Ctrl+C or Esc
            exit 0
          fi

          # Extract task name (first word before colon)
          TASK_NAME=$(echo "$SELECTED" | awk -F: '{print $1}')

          clear
          gum style --border rounded --padding "1 2" --bold "Task: $TASK_NAME"
          echo ""

          # Show full task details
          task --summary "$TASK_NAME" 2>/dev/null || echo "No additional details available"

          echo ""
          echo "Commands:"
          echo "  [R]un task"
          echo "  [B]ack to list"
          echo "  [Q]uit"
          echo ""

          ACTION=$(gum choose "Run task" "Back to list" "Quit")

          case "$ACTION" in
            "Run task")
              echo ""
              gum style --foreground 212 "Running: task $TASK_NAME"
              echo ""

              # Check if task needs arguments
              if task --summary "$TASK_NAME" 2>/dev/null | grep -q "<cluster_id>"; then
                ARGS=$(gum input --placeholder "Enter arguments (e.g., 101)" || echo "")
                if [ -n "$ARGS" ]; then
                  task "$TASK_NAME" -- $ARGS
                else
                  task "$TASK_NAME"
                fi
              else
                task "$TASK_NAME"
              fi

              echo ""
              gum input --placeholder "Press Enter to continue..."
              ;;
            "Back to list")
              continue
              ;;
            "Quit")
              exit 0
              ;;
          esac
        done

  menu:
    desc: 'üé® Interactive main menu (Gum-powered)'
    summary: |
      Beautiful interactive menu for all cluster operations.
      Uses Charm Gum for rich TUI experience.

      Usage: task menu
      Or simply: task
    cmds:
      - |
        #!/bin/bash
        set -e

        # Check if Gum is installed
        if ! command -v gum &> /dev/null; then
          echo "‚ùå Gum is not installed"
          echo "Install: brew install gum"
          echo ""
          echo "Falling back to list view..."
          task --list-all
          exit 1
        fi

        while true; do
          clear

          # Header
          gum style \
            --foreground 212 \
            --border double \
            --border-foreground 212 \
            --padding "1 2" \
            --bold \
            "üè† Home-Ops Cluster Management" \
            "" \
            "Kubernetes cluster lifecycle automation"

          echo ""

          # Main menu - show all 13 items at once
          ACTION=$(gum choose \
            --height 15 \
            --cursor-prefix "‚Üí " \
            "üöÄ Create Cluster" \
            "üóëÔ∏è  Destroy Cluster" \
            "üîß Bootstrap Talos" \
            "üì¶ Install Flux" \
            "üìä Status Dashboard" \
            "üìú View Logs" \
            "‚öôÔ∏è  Operations" \
            "üêõ Debug & Troubleshoot" \
            "ü§ñ AI Assistant" \
            "üìö Documentation" \
            "üîß Install Dependencies" \
            "üìã List All Tasks" \
            "‚ùå Exit")

          case "$ACTION" in
            *"Create Cluster"*)
              task menu:create
              ;;
            *"Destroy Cluster"*)
              task menu:destroy
              ;;
            *"Bootstrap Talos"*)
              task menu:bootstrap
              ;;
            *"Install Flux"*)
              task menu:flux
              ;;
            *"Status Dashboard"*)
              task menu:status
              ;;
            *"View Logs"*)
              task menu:logs
              ;;
            *"Operations"*)
              task menu:ops
              ;;
            *"Debug & Troubleshoot"*)
              task menu:debug
              ;;
            *"AI Assistant"*)
              task menu:ai
              ;;
            *"Documentation"*)
              task menu:docs
              ;;
            *"Install Dependencies"*)
              task menu:install
              ;;
            *"List All Tasks"*)
              task list
              ;;
            *"Exit"*)
              exit 0
              ;;
          esac
        done

  menu:install:
    desc: 'üîß Interactive dependency installer'
    cmds:
      - |
        #!/bin/bash
        while true; do
          clear
          gum style --border rounded --padding "1 2" --bold "üîß Dependency Management"
          echo ""

          CHOICE=$(gum choose \
            --height 10 \
            "Check All Dependencies" \
            "Install All Dependencies" \
            "Install Charm Tools" \
            "Install Kubernetes Tools" \
            "Install Talos Tools" \
            "Install Infrastructure Tools" \
            "Install Utilities" \
            "‚Üê Back")

          case "$CHOICE" in
            "Check All Dependencies")
              task install:check
              ;;
            "Install All Dependencies")
              if gum confirm "Install all missing dependencies?"; then
                task install:all
              fi
              ;;
            "Install Charm Tools")
              if gum confirm "Install gum, glow, mods?"; then
                task install:charm
              fi
              ;;
            "Install Kubernetes Tools")
              if gum confirm "Install kubectl, helm, flux?"; then
                task install:kubernetes
              fi
              ;;
            "Install Talos Tools")
              if gum confirm "Install talosctl, talhelper?"; then
                task install:talos
              fi
              ;;
            "Install Infrastructure Tools")
              if gum confirm "Install terraform, terragrunt?"; then
                task install:infra
              fi
              ;;
            "Install Utilities")
              if gum confirm "Install jinja2-cli, sops, age?"; then
                task install:utils
              fi
              ;;
            "‚Üê Back")
              break
              ;;
          esac

          echo ""
          gum input --placeholder "Press Enter to continue..."
        done

  # ===========================================================================
  # INTERACTIVE MENUS - Charm Gum Powered
  # ===========================================================================

  menu:create:
    desc: 'üöÄ Interactive cluster creation'
    cmds:
      - |
        #!/bin/bash
        set -e

        # Get cluster ID with validation
        CLUSTER=$(gum input \
          --placeholder "Cluster ID (e.g., 101)" \
          --value "101" \
          --prompt "‚Üí ")

        if [ -z "$CLUSTER" ]; then
          gum style --foreground 196 "‚ùå Cluster ID required"
          sleep 2
          exit 1
        fi

        # Confirm
        gum confirm \
          --default=false \
          "Create cluster-$CLUSTER with 3 control planes + 3 workers?" || exit 0

        echo ""
        gum style --border rounded --padding "1 2" --bold \
          "Creating Cluster $CLUSTER"

        # Step 1: Provision
        echo ""
        gum spin --spinner moon --title "Step 1/5: Provisioning VMs on Proxmox..." -- \
          task infra:provision -- $CLUSTER
        echo "$(gum style --foreground 212 '‚úì') VMs provisioned"

        # Step 2: Secrets
        gum spin --spinner moon --title "Step 2/5: Generating Talos secrets..." -- \
          task talos:secrets -- $CLUSTER
        echo "$(gum style --foreground 212 '‚úì') Secrets encrypted"

        # Step 3: Config
        gum spin --spinner moon --title "Step 3/5: Generating machine configs..." -- \
          task talos:config -- $CLUSTER
        echo "$(gum style --foreground 212 '‚úì') Configs generated"

        # Step 4: Wait
        gum spin --spinner pulse --title "Step 4/5: Waiting for VMs to boot (60s)..." -- \
          sleep 60
        echo "$(gum style --foreground 212 '‚úì') VMs ready"

        # Step 5: Bootstrap
        gum spin --spinner moon --title "Step 5/5: Bootstrapping Talos cluster..." -- \
          task cluster:bootstrap -- $CLUSTER
        echo "$(gum style --foreground 212 '‚úì') Cluster bootstrapped"

        echo ""
        gum style \
          --foreground 212 --border double --padding "1 2" --bold \
          "‚úì Cluster $CLUSTER Ready!" \
          "" \
          "Next: Install Flux from main menu"

        echo ""
        gum input --placeholder "Press Enter to continue..."

  menu:destroy:
    desc: 'üóëÔ∏è  Interactive cluster destruction'
    cmds:
      - |
        #!/bin/bash
        set -e

        # Get cluster ID
        CLUSTER=$(gum input \
          --placeholder "Cluster ID to destroy (e.g., 101)" \
          --prompt "‚Üí ")

        if [ -z "$CLUSTER" ]; then
          gum style --foreground 196 "‚ùå Cluster ID required"
          sleep 2
          exit 1
        fi

        # Warning message
        echo ""
        gum style \
          --foreground 196 --border rounded --padding "1 2" --bold \
          "‚ö†Ô∏è  DESTRUCTIVE OPERATION" \
          "" \
          "This will DELETE cluster-$CLUSTER:" \
          "  ‚Ä¢ All VMs destroyed" \
          "  ‚Ä¢ All data lost" \
          "  ‚Ä¢ All configs removed"

        echo ""

        # First confirmation
        if ! gum confirm --default=false "‚ö†Ô∏è  Are you SURE you want to destroy cluster-$CLUSTER?"; then
          gum style --foreground 212 "Cancelled - cluster not destroyed"
          sleep 2
          exit 0
        fi

        # Production protection for cluster-101
        if [ "$CLUSTER" = "101" ]; then
          echo ""
          gum style --foreground 196 --bold "üõë PRODUCTION CLUSTER PROTECTION"
          echo ""

          CONFIRM=$(gum input \
            --placeholder "Type cluster name 'sol' to confirm" \
            --prompt "‚Üí ")

          if [ "$CONFIRM" != "sol" ]; then
            gum style --foreground 212 "‚ùå Incorrect confirmation - cancelled"
            sleep 2
            exit 0
          fi
        fi

        # Final confirmation
        echo ""
        if ! gum confirm --default=false "FINAL WARNING: Delete cluster-$CLUSTER now?"; then
          gum style --foreground 212 "Cancelled - cluster not destroyed"
          sleep 2
          exit 0
        fi

        # Destroy cluster
        echo ""
        gum spin --spinner moon --title "Destroying cluster infrastructure..." -- \
          task infra:destroy -- $CLUSTER

        echo "$(gum style --foreground 196 '‚úì') VMs destroyed"

        gum spin --spinner moon --title "Removing configs..." -- \
          rm -rf talos/clusters/cluster-$CLUSTER

        echo "$(gum style --foreground 196 '‚úì') Configs removed"

        echo ""
        gum style \
          --foreground 196 --border double --padding "1 2" --bold \
          "‚úì Cluster $CLUSTER Destroyed" \
          "" \
          "All resources have been removed"

        echo ""
        gum input --placeholder "Press Enter to continue..."

  menu:bootstrap:
    desc: 'üîß Interactive bootstrap'
    cmds:
      - |
        #!/bin/bash
        CLUSTER=$(gum input --placeholder "Cluster ID" --value "101")
        gum confirm "Bootstrap cluster-$CLUSTER?" || exit 0
        task cluster:bootstrap -- $CLUSTER
        gum input --placeholder "Press Enter to continue..."

  menu:flux:
    desc: 'üì¶ Interactive Flux installation'
    cmds:
      - |
        #!/bin/bash
        CLUSTER=$(gum input --placeholder "Cluster ID" --value "101")
        gum confirm "Install Flux on cluster-$CLUSTER?" || exit 0
        task flux:install -- $CLUSTER
        gum input --placeholder "Press Enter to continue..."

  menu:status:
    desc: 'üìä Interactive status dashboard'
    cmds:
      - |
        #!/bin/bash
        while true; do
          clear
          gum style --border rounded --padding "1 2" --bold "üìä Status Dashboard"
          echo ""

          CHOICE=$(gum choose \
            --height 10 \
            "Cluster Overview" \
            "Node Status" \
            "Flux Status" \
            "Cilium Status" \
            "Storage Status" \
            "All Pods" \
            "Complete Health Check" \
            "‚Üê Back")

          case "$CHOICE" in
            "Cluster Overview") task status:cluster ;;
            "Node Status") task status:nodes ;;
            "Flux Status") task status:flux ;;
            "Cilium Status") task status:cilium ;;
            "Storage Status") task status:storage ;;
            "All Pods") task status:pods ;;
            "Complete Health Check") task status:all ;;
            "‚Üê Back") break ;;
          esac

          echo ""
          gum input --placeholder "Press Enter to continue..."
        done

  menu:logs:
    desc: 'üìú Interactive log viewer'
    cmds:
      - |
        #!/bin/bash
        while true; do
          clear
          gum style --border rounded --padding "1 2" --bold "üìú Log Viewer"
          echo ""

          CHOICE=$(gum choose \
            --height 7 \
            "Talos System Logs" \
            "Flux Controller Logs" \
            "Cilium Logs" \
            "Pod Logs (select)" \
            "‚Üê Back")

          case "$CHOICE" in
            "Talos System Logs")
              CLUSTER=$(gum input --placeholder "Cluster ID" --value "101")
              task logs:talos -- $CLUSTER
              ;;
            "Flux Controller Logs")
              task logs:flux
              ;;
            "Cilium Logs")
              task logs:cilium
              ;;
            "Pod Logs (select)")
              POD=$(kubectl get pods -A --no-headers | \
                gum filter --placeholder "Search pods..." | \
                awk '{print $1"/"$2}')
              if [ -n "$POD" ]; then
                task logs:pod -- $POD
              fi
              ;;
            "‚Üê Back")
              break
              ;;
          esac

          echo ""
          gum input --placeholder "Press Enter to continue..."
        done

  menu:ops:
    desc: '‚öôÔ∏è  Interactive operations menu'
    cmds:
      - |
        #!/bin/bash
        while true; do
          clear
          gum style --border rounded --padding "1 2" --bold "‚öôÔ∏è  Operations"
          echo ""

          CHOICE=$(gum choose \
            --height 9 \
            "Drain Node" \
            "Cordon Node" \
            "Uncordon Node" \
            "Reboot Node" \
            "Node Shell" \
            "Upgrade Talos" \
            "‚Üê Back")

          case "$CHOICE" in
            "Drain Node")
              NODE=$(kubectl get nodes --no-headers | gum filter --placeholder "Select node..." | awk '{print $1}')
              if [ -n "$NODE" ]; then
                gum confirm "Drain node $NODE?" && task ops:drain -- $NODE
              fi
              ;;
            "Cordon Node")
              NODE=$(kubectl get nodes --no-headers | gum filter --placeholder "Select node..." | awk '{print $1}')
              if [ -n "$NODE" ]; then
                gum confirm "Cordon node $NODE?" && task ops:cordon -- $NODE
              fi
              ;;
            "Uncordon Node")
              NODE=$(kubectl get nodes --no-headers | gum filter --placeholder "Select node..." | awk '{print $1}')
              if [ -n "$NODE" ]; then
                task ops:uncordon -- $NODE
              fi
              ;;
            "Reboot Node")
              NODE=$(kubectl get nodes --no-headers | gum filter --placeholder "Select node..." | awk '{print $1}')
              if [ -n "$NODE" ]; then
                gum confirm --default=false "‚ö†Ô∏è  Reboot node $NODE?" && \
                  CLUSTER=$(gum input --placeholder "Cluster ID" --value "101") && \
                  task ops:reboot -- $NODE $CLUSTER
              fi
              ;;
            "Node Shell")
              NODE=$(kubectl get nodes --no-headers | gum filter --placeholder "Select node..." | awk '{print $1}')
              if [ -n "$NODE" ]; then
                CLUSTER=$(gum input --placeholder "Cluster ID" --value "101")
                task ops:shell -- $NODE $CLUSTER
              fi
              ;;
            "Upgrade Talos")
              CLUSTER=$(gum input --placeholder "Cluster ID" --value "101")
              VERSION=$(gum input --placeholder "Talos version (e.g., 1.11.5)")
              gum confirm --default=false "‚ö†Ô∏è  Upgrade cluster-$CLUSTER to Talos $VERSION?" && \
                task ops:upgrade:talos -- $CLUSTER $VERSION
              ;;
            "‚Üê Back")
              break
              ;;
          esac

          echo ""
          gum input --placeholder "Press Enter to continue..."
        done

  menu:debug:
    desc: 'üêõ Interactive debug menu'
    cmds:
      - |
        #!/bin/bash
        while true; do
          clear
          gum style --border rounded --padding "1 2" --bold "üêõ Debug & Troubleshoot"
          echo ""

          CHOICE=$(gum choose \
            --height 8 \
            "Watch Events" \
            "Test Network" \
            "Test DNS" \
            "Debug Pod" \
            "Debug Node" \
            "‚Üê Back")

          case "$CHOICE" in
            "Watch Events") task debug:events ;;
            "Test Network") task debug:network ;;
            "Test DNS") task debug:dns ;;
            "Debug Pod")
              POD=$(kubectl get pods -A --no-headers | \
                gum filter --placeholder "Search pods..." | \
                awk '{print $1"/"$2}')
              if [ -n "$POD" ]; then
                task debug:pod -- $POD
              fi
              ;;
            "Debug Node")
              NODE=$(kubectl get nodes --no-headers | gum filter --placeholder "Select node..." | awk '{print $1}')
              if [ -n "$NODE" ]; then
                task debug:node -- $NODE
              fi
              ;;
            "‚Üê Back")
              break
              ;;
          esac

          echo ""
          gum input --placeholder "Press Enter to continue..."
        done

  menu:ai:
    desc: 'ü§ñ AI-powered troubleshooting assistant'
    cmds:
      - |
        #!/bin/bash
        set -e

        # Check if Mods is installed
        if ! command -v mods &> /dev/null; then
          gum style --foreground 196 "‚ùå Mods (AI) is not installed"
          echo "Install: brew install mods"
          echo "Configure: mods --settings"
          gum input --placeholder "Press Enter to continue..."
          exit 1
        fi

        while true; do
          clear
          gum style --border rounded --padding "1 2" --bold "ü§ñ AI Assistant"
          echo ""

          CHOICE=$(gum choose \
            --height 8 \
            "Analyze Recent Events" \
            "Troubleshoot Pod Issues" \
            "Analyze Flux Errors" \
            "Network Diagnostics" \
            "Ask Custom Question" \
            "‚Üê Back")

          case "$CHOICE" in
            "Analyze Recent Events")
              gum spin --title "Gathering events..." -- \
                kubectl get events -A --sort-by='.lastTimestamp' | tail -30 > /tmp/k8s-events.txt

              gum spin --title "AI analyzing events..." -- \
                mods --role "kubernetes expert" \
                "Analyze these Kubernetes events and explain any issues or warnings. Provide actionable fixes:" \
                < /tmp/k8s-events.txt | gum pager
              ;;

            "Troubleshoot Pod Issues")
              POD=$(kubectl get pods -A --no-headers | \
                gum filter --placeholder "Search pods..." | \
                awk '{print $1" "$2}')

              if [ -n "$POD" ]; then
                NAMESPACE=$(echo $POD | awk '{print $1}')
                NAME=$(echo $POD | awk '{print $2}')

                gum spin --title "Gathering pod info..." -- bash -c \
                  "kubectl describe pod -n $NAMESPACE $NAME > /tmp/pod-describe.txt; \
                   kubectl logs -n $NAMESPACE $NAME --tail=100 > /tmp/pod-logs.txt 2>&1 || echo 'No logs available' > /tmp/pod-logs.txt"

                gum spin --title "AI analyzing pod..." -- bash -c \
                  "cat /tmp/pod-describe.txt /tmp/pod-logs.txt | \
                   mods --role 'kubernetes expert' \
                   'Analyze this pod description and logs. Identify issues and provide fixes:'" | gum pager
              fi
              ;;

            "Analyze Flux Errors")
              gum spin --title "Gathering Flux status..." -- \
                flux get all -A > /tmp/flux-status.txt

              gum spin --title "AI analyzing Flux..." -- \
                mods --role "flux expert" \
                "Analyze this Flux status output. Identify any reconciliation failures and suggest fixes:" \
                < /tmp/flux-status.txt | gum pager
              ;;

            "Network Diagnostics")
              gum spin --title "Running network tests..." -- bash -c \
                "kubectl get svc -A > /tmp/services.txt; \
                 kubectl get ingress -A > /tmp/ingress.txt 2>&1 || echo 'No ingress' > /tmp/ingress.txt; \
                 kubectl get networkpolicies -A > /tmp/netpol.txt 2>&1 || echo 'No policies' > /tmp/netpol.txt"

              gum spin --title "AI analyzing network..." -- bash -c \
                "cat /tmp/services.txt /tmp/ingress.txt /tmp/netpol.txt | \
                 mods --role 'kubernetes networking expert' \
                 'Analyze this network configuration. Identify potential connectivity issues:'" | gum pager
              ;;

            "Ask Custom Question")
              QUESTION=$(gum write --placeholder "Describe your issue or question...")

              if [ -n "$QUESTION" ]; then
                # Let user select context
                CONTEXT=$(gum choose --no-limit \
                  "Include cluster events" \
                  "Include pod status" \
                  "Include Flux status" \
                  "Include node status" \
                  "No additional context")

                CONTEXT_DATA=""

                if [[ "$CONTEXT" == *"cluster events"* ]]; then
                  CONTEXT_DATA+="\n\nRecent Events:\n$(kubectl get events -A --sort-by='.lastTimestamp' | tail -20)"
                fi

                if [[ "$CONTEXT" == *"pod status"* ]]; then
                  CONTEXT_DATA+="\n\nPod Status:\n$(kubectl get pods -A)"
                fi

                if [[ "$CONTEXT" == *"Flux status"* ]]; then
                  CONTEXT_DATA+="\n\nFlux Status:\n$(flux get all -A 2>&1 || echo 'Flux not available')"
                fi

                if [[ "$CONTEXT" == *"node status"* ]]; then
                  CONTEXT_DATA+="\n\nNode Status:\n$(kubectl get nodes -o wide)"
                fi

                echo "Question: $QUESTION $CONTEXT_DATA" | \
                  mods --role "kubernetes and talos linux expert" | gum pager
              fi
              ;;

            "‚Üê Back")
              break
              ;;
          esac

          echo ""
          gum input --placeholder "Press Enter to continue..."
        done

  menu:docs:
    desc: 'üìö Interactive documentation viewer'
    cmds:
      - |
        #!/bin/bash
        set -e

        # Check if Glow is installed
        if ! command -v glow &> /dev/null; then
          gum style --foreground 196 "‚ùå Glow is not installed"
          echo "Install: brew install glow"
          gum input --placeholder "Press Enter to continue..."
          exit 1
        fi

        while true; do
          clear
          gum style --border rounded --padding "1 2" --bold "üìö Documentation"
          echo ""

          # Find markdown files
          DOCS=$(find . -name "*.md" -not -path "*/node_modules/*" -not -path "*/.git/*" | sort)

          if [ -z "$DOCS" ]; then
            gum style --foreground 196 "No documentation files found"
            sleep 2
            break
          fi

          DOC=$(echo "$DOCS" | gum filter --placeholder "Search documentation...")

          if [ -n "$DOC" ]; then
            glow "$DOC"
            echo ""
            gum input --placeholder "Press Enter to continue..."
          else
            break
          fi
        done

  # ===========================================================================
  # DEPENDENCIES - Install Required Tools
  # ===========================================================================

  install:
    desc: 'üì¶ Install all required dependencies'
    summary: |
      Installs all tools needed to run this Taskfile:
        - Charm tools (gum, glow, mods)
        - Kubernetes tools (kubectl, helm, flux)
        - Talos tools (talosctl, talhelper)
        - Infrastructure tools (terraform, terragrunt)
        - Utilities (jinja2-cli, sops, age)

      Platform support: macOS (Homebrew), Linux (binary downloads)

      Usage: task install
    cmds:
      - task: install:check
      - |
        echo ""
        if gum confirm "Install all missing dependencies?"; then
          task install:all
        else
          echo "Cancelled"
          exit 0
        fi

  install:all:
    desc: 'Install all dependencies'
    cmds:
      - task: install:charm
      - task: install:kubernetes
      - task: install:talos
      - task: install:infra
      - task: install:utils
      - |
        echo ""
        gum style --foreground 212 --border double --padding "1 2" --bold \
          "‚úì All Dependencies Installed!" \
          "" \
          "Run 'task install:check' to verify"

  install:check:
    desc: 'üîç Check installed dependencies'
    summary: |
      Checks which required tools are installed and shows versions.

      Usage: task install:check
    cmds:
      - |
        #!/bin/bash

        echo "Checking dependencies..."
        echo ""

        # Colors
        GREEN='\033[0;32m'
        RED='\033[0;31m'
        YELLOW='\033[1;33m'
        NC='\033[0m'

        check_cmd() {
          local cmd=$1
          local name=$2
          local required=$3
          local version_arg="${4:---version}"

          if command -v $cmd &> /dev/null; then
            version=$($cmd $version_arg 2>&1 | head -1 || echo "installed")
            printf "${GREEN}‚úì${NC} %-20s %s\n" "$name" "$version"
            return 0
          else
            if [ "$required" = "required" ]; then
              printf "${RED}‚úó${NC} %-20s %s\n" "$name" "NOT INSTALLED (required)"
            else
              printf "${YELLOW}‚óã${NC} %-20s %s\n" "$name" "NOT INSTALLED (optional)"
            fi
            return 1
          fi
        }

        echo "Charm Tools (Interactive UI):"
        check_cmd gum "gum" "optional"
        check_cmd glow "glow" "optional"
        check_cmd mods "mods" "optional"
        echo ""

        echo "Kubernetes Tools:"
        check_cmd kubectl "kubectl" "required" "version --client"
        check_cmd helm "helm" "required" "version --short"
        check_cmd flux "flux" "required"
        echo ""

        echo "Talos Tools:"
        check_cmd talosctl "talosctl" "required" "version --client --short"
        check_cmd talhelper "talhelper" "required"
        echo ""

        echo "Infrastructure Tools:"
        check_cmd terraform "terraform" "required"
        check_cmd terragrunt "terragrunt" "required"
        echo ""

        echo "Utilities:"
        check_cmd jinja2 "jinja2-cli" "required"
        check_cmd sops "sops" "required"
        check_cmd age "age" "required"
        check_cmd python3 "python3" "required"
        echo ""

        echo "Legend:"
        printf "${GREEN}‚úì${NC} Installed  ${RED}‚úó${NC} Missing (required)  ${YELLOW}‚óã${NC} Missing (optional)\n"

  install:charm:
    desc: 'üé® Install Charm tools (gum, glow, mods)'
    cmds:
      - |
        #!/bin/bash
        set -e

        echo "Installing Charm tools..."

        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS
          brew install gum glow mods
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
          # Linux
          echo "Installing via go..."
          go install github.com/charmbracelet/gum@latest
          go install github.com/charmbracelet/glow@latest
          go install github.com/charmbracelet/mods@latest
        else
          echo "‚ùå Unsupported OS: $OSTYPE"
          echo "Install manually: https://github.com/charmbracelet/gum"
          exit 1
        fi

        echo "‚úì Charm tools installed"

  install:kubernetes:
    desc: '‚ò∏Ô∏è  Install Kubernetes tools (kubectl, helm, flux)'
    cmds:
      - |
        #!/bin/bash
        set -e

        echo "Installing Kubernetes tools..."

        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS
          brew install kubectl helm fluxcd/tap/flux
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
          # Linux - kubectl
          if ! command -v kubectl &> /dev/null; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi

          # Linux - helm
          if ! command -v helm &> /dev/null; then
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          fi

          # Linux - flux
          if ! command -v flux &> /dev/null; then
            curl -s https://fluxcd.io/install.sh | bash
          fi
        else
          echo "‚ùå Unsupported OS: $OSTYPE"
          exit 1
        fi

        echo "‚úì Kubernetes tools installed"

  install:talos:
    desc: 'üîß Install Talos tools (talosctl, talhelper)'
    cmds:
      - |
        #!/bin/bash
        set -e

        echo "Installing Talos tools..."

        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS
          brew install siderolabs/tap/talosctl budimanjojo/tap/talhelper
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
          # Linux - talosctl
          if ! command -v talosctl &> /dev/null; then
            curl -sL https://talos.dev/install | sh
          fi

          # Linux - talhelper
          if ! command -v talhelper &> /dev/null; then
            TALHELPER_VERSION=$(curl -s https://api.github.com/repos/budimanjojo/talhelper/releases/latest | grep tag_name | cut -d '"' -f 4)
            curl -L "https://github.com/budimanjojo/talhelper/releases/download/${TALHELPER_VERSION}/talhelper_linux_amd64" -o talhelper
            chmod +x talhelper
            sudo mv talhelper /usr/local/bin/
          fi
        else
          echo "‚ùå Unsupported OS: $OSTYPE"
          exit 1
        fi

        echo "‚úì Talos tools installed"

  install:infra:
    desc: 'üèóÔ∏è  Install infrastructure tools (terraform, terragrunt)'
    cmds:
      - |
        #!/bin/bash
        set -e

        echo "Installing infrastructure tools..."

        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS
          brew install terraform terragrunt
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
          # Linux - terraform
          if ! command -v terraform &> /dev/null; then
            curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
            sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
            sudo apt-get update && sudo apt-get install terraform
          fi

          # Linux - terragrunt
          if ! command -v terragrunt &> /dev/null; then
            TERRAGRUNT_VERSION=$(curl -s https://api.github.com/repos/gruntwork-io/terragrunt/releases/latest | grep tag_name | cut -d '"' -f 4)
            curl -L "https://github.com/gruntwork-io/terragrunt/releases/download/${TERRAGRUNT_VERSION}/terragrunt_linux_amd64" -o terragrunt
            chmod +x terragrunt
            sudo mv terragrunt /usr/local/bin/
          fi
        else
          echo "‚ùå Unsupported OS: $OSTYPE"
          exit 1
        fi

        echo "‚úì Infrastructure tools installed"

  install:utils:
    desc: 'üîß Install utilities (jinja2, sops, age, python3)'
    cmds:
      - |
        #!/bin/bash
        set -e

        echo "Installing utilities..."

        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS
          brew install sops age
          pip3 install jinja2-cli pyyaml --break-system-packages 2>/dev/null || pip3 install jinja2-cli pyyaml
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
          # Linux - sops
          if ! command -v sops &> /dev/null; then
            SOPS_VERSION=$(curl -s https://api.github.com/repos/getsops/sops/releases/latest | grep tag_name | cut -d '"' -f 4)
            curl -L "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" -o sops
            chmod +x sops
            sudo mv sops /usr/local/bin/
          fi

          # Linux - age
          if ! command -v age &> /dev/null; then
            AGE_VERSION=$(curl -s https://api.github.com/repos/FiloSottile/age/releases/latest | grep tag_name | cut -d '"' -f 4)
            curl -L "https://github.com/FiloSottile/age/releases/download/${AGE_VERSION}/age-${AGE_VERSION}-linux-amd64.tar.gz" -o age.tar.gz
            tar xzf age.tar.gz
            sudo mv age/age age/age-keygen /usr/local/bin/
            rm -rf age age.tar.gz
          fi

          # Linux - jinja2-cli
          pip3 install jinja2-cli pyyaml
        else
          echo "‚ùå Unsupported OS: $OSTYPE"
          exit 1
        fi

        echo "‚úì Utilities installed"

  install:ci:
    desc: 'ü§ñ Install dependencies for CI/CD (non-interactive)'
    summary: |
      Installs required tools for CI/CD environments.
      Skips optional Charm tools (gum, glow, mods).

      Usage: task install:ci
    cmds:
      - task: install:kubernetes
      - task: install:talos
      - task: install:infra
      - task: install:utils
      - echo "‚úì CI/CD dependencies installed"

  # ===========================================================================
  # INFRASTRUCTURE - Proxmox VM Management
  # ===========================================================================

  infra:provision:
    desc: '1Ô∏è‚É£  Provision cluster VMs on Proxmox'
    aliases: ['infra:apply']
    summary: |
      Usage: task infra:provision -- <cluster_id>
      Example: task infra:provision -- 101

      Creates Talos VMs on Proxmox using Terraform/Terragrunt.
      Automatically uploads Talos image (cached if checksum matches).

      Time: ~2-3 min (first time), ~30s (subsequent)

      üìö Docs: docs/infrastructure/proxmox.md
    dir: 'terraform/infra/live/cluster-{{.CLUSTER_NAME}}'
    cmds:
      - |
        echo "üèóÔ∏è  Provisioning cluster-{{.CLUSTER_NAME}} infrastructure..."
        echo "  üí° Creates Talos ISO and 6 VMs on Proxmox"
        echo ""
        terragrunt apply --all --auto-approve --non-interactive
        echo ""
        echo "‚úÖ Infrastructure provisioned successfully"
        echo ""
        echo "Next steps:"
        echo "  task talos:secrets -- {{.CLUSTER_NAME}}"

  infra:plan:
    desc: 'Preview infrastructure changes'
    summary: |
      Usage: task infra:plan -- <cluster_id>
      Example: task infra:plan -- 101

      Shows what Terraform will change without applying.
    dir: 'terraform/infra/live/cluster-{{.CLUSTER_NAME}}'
    cmds:
      - terragrunt plan --all

  infra:update-image:
    desc: 'Force update Talos image in Proxmox'
    summary: |
      Usage: task infra:update-image -- <cluster_id>
      Example: task infra:update-image -- 101

      Forces re-download and re-upload of Talos image.
      Use when upgrading Talos or fixing corrupted images.

      Time: ~1-2 minutes
    dir: 'terraform/infra/live/cluster-{{.CLUSTER_NAME}}/image'
    cmds:
      - |
        echo "üîÑ Updating Talos image for cluster-{{.CLUSTER_NAME}}..."
        echo "  üí° Forcing re-download and re-upload"
        echo ""
        rm -f terraform/infra/live/cluster-{{.CLUSTER_NAME}}/.talos-images/*
        terragrunt apply --auto-approve --non-interactive -replace='proxmox_virtual_environment_file.uploaded["pve01"]'
        echo ""
        echo "‚úÖ Talos image updated"

  infra:destroy:
    desc: 'Destroy cluster infrastructure'
    summary: |
      Usage: task infra:destroy -- <cluster_id>
      Example: task infra:destroy -- 102

      ‚ö†Ô∏è  Destroys all VMs and removes infrastructure.
      Use cluster:destroy for complete cleanup instead.
    dir: 'terraform/infra/live/cluster-{{.CLUSTER_NAME}}'
    cmds:
      - terragrunt destroy --all --auto-approve --non-interactive

  # ===========================================================================
  # TALOS - Configuration Management
  # ===========================================================================

  talos:secrets:
    desc: '2Ô∏è‚É£  Generate encrypted Talos secrets'
    aliases: ['talos:gen-secrets']
    summary: |
      Usage: task talos:secrets -- <cluster_id>
      Example: task talos:secrets -- 101

      Generates and encrypts Talos cluster secrets with SOPS.
      Secrets stored at: talos/clusters/cluster-<id>/talsecret.sops.yaml

      To regenerate: FORCE=1 task talos:secrets -- <id>

      üìö Docs: docs/talos/secrets.md
    vars:
      SECRETS_FILE: 'clusters/cluster-{{.CLUSTER_ID}}/talsecret.sops.yaml'
    dir: 'talos'
    cmds:
      - |
        if [ -f "{{.SECRETS_FILE}}" ] && [ "$FORCE" != "1" ]; then
          echo "‚ÑπÔ∏è  Secrets already exist: talos/{{.SECRETS_FILE}}"
          echo "  üí° To regenerate: FORCE=1 task talos:secrets -- {{.CLUSTER_ID}}"
          exit 0
        fi

        echo "üîê Generating Talos cluster secrets..."
        mkdir -p clusters/cluster-{{.CLUSTER_ID}}
        talhelper gensecret > {{.SECRETS_FILE}}
        sops -e -i {{.SECRETS_FILE}}
        echo "‚úÖ Encrypted secrets generated"
        echo ""
        echo "Next steps:"
        echo "  task talos:config -- {{.CLUSTER_ID}}"

  talos:config:
    desc: '3Ô∏è‚É£  Generate Talos machine configs'
    aliases: ['talos:gen-config']
    summary: |
      Usage: task talos:config -- <cluster_id>
      Example: task talos:config -- 101

      Generates machine configs for all nodes using talhelper.

      Requires:
        - talenv.yaml (from Terraform)
        - talsecret.sops.yaml (from talos:secrets)

      Outputs: talos/clusters/cluster-<id>/*.yaml

      üìö Docs: docs/talos/configuration.md
    vars:
      CLUSTER_DIR: 'clusters/cluster-{{.CLUSTER_ID}}'
      ENV_FILE: 'clusters/cluster-{{.CLUSTER_ID}}/talenv.yaml'
      SECRET_FILE: 'clusters/cluster-{{.CLUSTER_ID}}/talsecret.sops.yaml'
      RENDERED_CONFIG: 'clusters/cluster-{{.CLUSTER_ID}}/talconfig.rendered.yaml'
    dir: 'talos'
    preconditions:
      - sh: '[ -f "{{.ENV_FILE}}" ]'
        msg: |
          ‚ùå Missing talenv.yaml: {{.ENV_FILE}}

          Generate with: task infra:provision -- {{.CLUSTER_ID}}
      - sh: '[ -f "{{.SECRET_FILE}}" ]'
        msg: |
          ‚ùå Missing talsecret.sops.yaml: {{.SECRET_FILE}}

          Generate with: task talos:secrets -- {{.CLUSTER_ID}}
    cmds:
      - |
        echo "‚öôÔ∏è  Generating Talos machine configs..."
        python3 scripts/validate_talenv.py --file {{.ENV_FILE}}
        jinja2 {{.TALOS_TEMPLATE}} {{.ENV_FILE}} -D secret_file={{.SECRET_FILE}} -o {{.RENDERED_CONFIG}}
        talhelper genconfig --config-file {{.RENDERED_CONFIG}} --secret-file {{.SECRET_FILE}} --out-dir {{.CLUSTER_DIR}}
        echo ""
        echo "‚úÖ Machine configs generated: talos/{{.CLUSTER_DIR}}/"
        echo ""
        echo "Next steps:"
        echo "  task cluster:bootstrap -- {{.CLUSTER_ID}}"

  # ===========================================================================
  # CLUSTER - Bootstrap & Lifecycle
  # ===========================================================================

  cluster:bootstrap:
    desc: '4Ô∏è‚É£  Bootstrap Talos cluster with CNI'
    aliases: ['talos:bootstrap']
    summary: |
      Usage: task cluster:bootstrap -- <cluster_id>
      Example: task cluster:bootstrap -- 101

      Complete cluster bootstrap:
        1. Apply configs to all nodes
        2. Bootstrap etcd cluster
        3. Install Cilium CNI
        4. Wait for nodes Ready

      Time: ~5-10 minutes

      üìö Docs: docs/cluster/bootstrap.md
    vars:
      CLUSTER_DIR: 'clusters/cluster-{{.CLUSTER_ID}}'
    dir: 'talos/clusters/cluster-{{.CLUSTER_ID}}'
    cmds:
      - |
        echo "üöÄ Bootstrapping cluster {{.CLUSTER_ID}}"
        echo ""

        # Helper functions
        format_node() {
          local ip="$1"
          if [[ -z "$ip" || "$ip" == "null" ]]; then
            echo ""
          elif [[ "$ip" == *:* ]]; then
            echo "[$ip]"
          else
            echo "$ip"
          fi
        }

        ping_node() {
          local ip="$1"
          if [[ -z "$ip" || "$ip" == "null" ]]; then
            return 1
          fi
          if [[ "$ip" == *:* ]]; then
            if command -v ping6 &>/dev/null; then
              ping6 -c 1 "$ip" &>/dev/null
            else
              ping -6 -c 1 -W 2 "$ip" &>/dev/null
            fi
          else
            ping -c 1 -W 2 "$ip" &>/dev/null
          fi
        }

        # Read node IPs (prefer IPv6)
        CP01_IP=$(yq -r '.solcp01_public_ipv6 // .solcp01_ipAddress // ""' talenv.yaml)
        CP02_IP=$(yq -r '.solcp02_public_ipv6 // .solcp02_ipAddress // ""' talenv.yaml)
        CP03_IP=$(yq -r '.solcp03_public_ipv6 // .solcp03_ipAddress // ""' talenv.yaml)
        WK01_IP=$(yq -r '.solwk01_public_ipv6 // .solwk01_ipAddress // ""' talenv.yaml)
        WK02_IP=$(yq -r '.solwk02_public_ipv6 // .solwk02_ipAddress // ""' talenv.yaml)
        WK03_IP=$(yq -r '.solwk03_public_ipv6 // .solwk03_ipAddress // ""' talenv.yaml)

        echo "üìã Node IPs:"
        echo "  Control Planes: $CP01_IP, $CP02_IP, $CP03_IP"
        echo "  Workers: $WK01_IP, $WK02_IP, $WK03_IP"
        echo ""

        # Wait for nodes to be reachable
        echo "‚è≥ Waiting for nodes to be reachable..."
        MAX_WAIT=600
        ELAPSED=0
        ALL_REACHABLE=false

        while [ $ELAPSED -lt $MAX_WAIT ]; do
          UNREACHABLE=()
          for node_ip in "$CP01_IP" "$CP02_IP" "$CP03_IP" "$WK01_IP" "$WK02_IP" "$WK03_IP"; do
            if ! ping_node "$node_ip"; then
              UNREACHABLE+=("$node_ip")
            fi
          done

          if [ ${#UNREACHABLE[@]} -eq 0 ]; then
            echo "  ‚úì All nodes reachable (${ELAPSED}s)"
            ALL_REACHABLE=true
            break
          fi

          if [ $((ELAPSED % 30)) -eq 0 ]; then
            echo "  ‚è≥ ${#UNREACHABLE[@]} nodes pending... (${ELAPSED}s/${MAX_WAIT}s)"
          fi
          sleep 10
          ELAPSED=$((ELAPSED + 10))
        done
        echo ""

        if [ "$ALL_REACHABLE" = false ]; then
          echo "‚ö†Ô∏è  ${#UNREACHABLE[@]} node(s) unreachable: ${UNREACHABLE[@]}"
          echo "  Continuing with reachable nodes..."
          echo ""
        fi

        # Apply machine configs (skip if cluster already configured)
        echo "1Ô∏è‚É£  Applying machine configs..."

        # Check if cluster is already configured by trying authenticated talosctl
        if talosctl --nodes "$CP01_IP" --endpoints "$CP01_IP" --talosconfig ./talosconfig version &>/dev/null; then
          echo "  ‚ÑπÔ∏è  Cluster already configured, skipping config application"
        else
          declare -a NODES=(
            "solcp01|$CP01_IP"
            "solcp02|$CP02_IP"
            "solcp03|$CP03_IP"
            "solwk01|$WK01_IP"
            "solwk02|$WK02_IP"
            "solwk03|$WK03_IP"
          )

          for node_def in "${NODES[@]}"; do
            IFS='|' read -r hostname ip <<< "$node_def"
            echo "  ‚Üí $hostname ($ip)"
            talosctl apply-config --insecure --nodes "$ip" --endpoints "$ip" --talosconfig ./talosconfig --file "cluster-{{.CLUSTER_ID}}-${hostname}.yaml" || echo "  ‚ö†Ô∏è  Failed"
          done
        fi
        echo ""

        # Wait for Talos API
        echo "‚è≥ Waiting for Talos API..."
        MAX_WAIT=600
        ELAPSED=0
        while [ $ELAPSED -lt $MAX_WAIT ]; do
          if talosctl --nodes "$CP01_IP" --endpoints "$CP01_IP" --talosconfig ./talosconfig version &>/dev/null; then
            echo "  ‚úì Talos API ready (${ELAPSED}s)"
            break
          fi
          if [ $((ELAPSED % 30)) -eq 0 ]; then
            echo "  ‚è≥ Waiting for Talos... (${ELAPSED}s/${MAX_WAIT}s)"
          fi
          sleep 10
          ELAPSED=$((ELAPSED + 10))
        done

        if [ $ELAPSED -ge $MAX_WAIT ]; then
          echo "‚ùå Talos API timeout"
          exit 1
        fi
        echo ""

        # Bootstrap etcd (skip if already bootstrapped)
        echo "2Ô∏è‚É£  Bootstrapping etcd..."

        # Check if etcd is already running
        if talosctl --nodes "$CP01_IP" --endpoints "$CP01_IP" --talosconfig ./talosconfig get members 2>/dev/null | grep -q "solcp01"; then
          echo "  ‚ÑπÔ∏è  etcd already bootstrapped and healthy"
        else
          talosctl bootstrap --nodes "$CP01_IP" --endpoints "$CP01_IP" --talosconfig ./talosconfig 2>&1 | grep -v "AlreadyExists" || {
            # Bootstrap may fail with AlreadyExists if etcd data directory exists
            echo "  ‚ÑπÔ∏è  etcd may already be bootstrapped, checking status..."
          }
          echo "  ‚úì Bootstrap sent"
        fi
        echo ""

        # Wait for etcd
        echo "‚è≥ Waiting for etcd cluster..."
        MAX_WAIT=180
        ELAPSED=0
        while [ $ELAPSED -lt $MAX_WAIT ]; do
          MEMBER_COUNT=$(talosctl --nodes "$CP01_IP" --endpoints "$CP01_IP" --talosconfig ./talosconfig get members 2>/dev/null | grep -c "Hostname:" || echo "0")
          if talosctl --nodes "$CP01_IP" --endpoints "$CP01_IP" --talosconfig ./talosconfig get members 2>/dev/null | grep -q "solcp01"; then
            echo "  ‚úì etcd healthy ($MEMBER_COUNT members, ${ELAPSED}s)"
            break
          fi
          if [ $((ELAPSED % 10)) -eq 0 ]; then
            echo "  ‚è≥ etcd members: $MEMBER_COUNT/3 (${ELAPSED}s/${MAX_WAIT}s)"
          fi
          sleep 5
          ELAPSED=$((ELAPSED + 5))
        done

        if [ $ELAPSED -ge $MAX_WAIT ]; then
          echo "‚ùå etcd timeout after ${MAX_WAIT}s"
          echo "  üí° Check etcd status: talosctl --nodes $CP01_IP get members"
          exit 1
        fi
        echo ""

        # Get kubeconfig
        echo "3Ô∏è‚É£  Retrieving kubeconfig..."
        talosctl kubeconfig --nodes "$CP01_IP" --endpoints "$CP01_IP" --talosconfig ./talosconfig --force
        echo "  ‚úì Kubeconfig updated"
        echo ""

        # Wait for VIP
        echo "‚è≥ Waiting for Kubernetes VIP (kube-vip)..."
        MAX_WAIT=450
        ELAPSED=0
        while [ $ELAPSED -lt $MAX_WAIT ]; do
          if kubectl cluster-info &>/dev/null; then
            K8S_VERSION=$(kubectl version --short 2>/dev/null | grep "Server Version" | awk '{print $3}' || echo "unknown")
            echo "  ‚úì VIP reachable, Kubernetes $K8S_VERSION (${ELAPSED}s)"
            break
          fi
          if [ $((ELAPSED % 15)) -eq 0 ]; then
            echo "  ‚è≥ Waiting for VIP to become available... (${ELAPSED}s/${MAX_WAIT}s)"
          fi
          sleep 5
          ELAPSED=$((ELAPSED + 5))
        done

        if [ $ELAPSED -ge $MAX_WAIT ]; then
          echo "‚ùå VIP timeout after ${MAX_WAIT}s"
          echo "  üí° Check kube-vip status on control plane nodes"
          exit 1
        fi
        echo ""

        # Install Cilium (idempotent)
        echo "4Ô∏è‚É£  Installing Cilium CNI..."

        # Check if Cilium is already installed
        if helm list -n kube-system | grep -q "^cilium"; then
          echo "  ‚ÑπÔ∏è  Cilium already installed, upgrading if needed..."
        fi

        cd kubernetes/apps/kube-system/cilium/app

        # Fix helm plugin issues that may cause failures
        if helm list -n kube-system 2>&1 | grep -q "failed to load plugin"; then
          echo "  ‚öôÔ∏è  Fixing helm plugin issues..."
          rm -rf ~/Library/helm/plugins/helm-diff 2>/dev/null || true
        fi

        helm repo add cilium https://helm.cilium.io 2>/dev/null || true
        helm repo update cilium

        # Install/upgrade with extended timeout
        helm upgrade --install cilium cilium/cilium \
          --version 1.18.4 \
          --namespace kube-system \
          --values values.yaml \
          --wait \
          --timeout 20m || {
            echo "  ‚ö†Ô∏è  Helm install timed out or failed, checking Cilium status..."
            # Continue to wait below in case pods are still coming up
          }
        echo ""

        # Extended wait for Cilium pods with progress updates
        echo "‚è≥ Waiting for Cilium pods (up to 8 minutes)..."
        MAX_WAIT=480
        ELAPSED=0
        LAST_STATUS=""
        while [ $ELAPSED -lt $MAX_WAIT ]; do
          READY=$(kubectl get pods -n kube-system -l k8s-app=cilium --no-headers 2>/dev/null | grep "Running" | wc -l || echo "0")
          TOTAL=$(kubectl get pods -n kube-system -l k8s-app=cilium --no-headers 2>/dev/null | wc -l || echo "0")

          # Get detailed pod status for better visibility
          POD_STATUS=$(kubectl get pods -n kube-system -l k8s-app=cilium --no-headers 2>/dev/null | awk '{print $3}' | sort | uniq -c | tr '\n' ' ' || echo "")

          if [ "$READY" -gt 0 ] && [ "$READY" -eq "$TOTAL" ]; then
            if kubectl wait --for=condition=Ready pods -l k8s-app=cilium -n kube-system --timeout=30s 2>/dev/null; then
              echo "  ‚úì Cilium running ($READY/$TOTAL pods ready, ${ELAPSED}s)"
              break
            fi
          fi

          # Show status updates every 15s or when status changes
          CURRENT_STATUS="$READY/$TOTAL pods | $POD_STATUS"
          if [ $((ELAPSED % 15)) -eq 0 ] || [ "$CURRENT_STATUS" != "$LAST_STATUS" ]; then
            if [ "$TOTAL" -gt 0 ]; then
              echo "  ‚è≥ Cilium: $READY/$TOTAL ready | Status: $POD_STATUS(${ELAPSED}s/${MAX_WAIT}s)"
            else
              echo "  ‚è≥ Waiting for Cilium pods to be created... (${ELAPSED}s/${MAX_WAIT}s)"
            fi
            LAST_STATUS="$CURRENT_STATUS"
          fi
          sleep 5
          ELAPSED=$((ELAPSED + 5))
        done

        if [ $ELAPSED -ge $MAX_WAIT ]; then
          echo ""
          echo "  ‚ö†Ô∏è  Cilium pods not all ready yet after ${MAX_WAIT}s"
          echo "  üìä Final status: $READY/$TOTAL ready"
          kubectl get pods -n kube-system -l k8s-app=cilium 2>/dev/null || true
          echo ""
          echo "  üí° You can check status later with: kubectl get pods -n kube-system -l k8s-app=cilium"
          echo "  üí° To complete Cilium installation, re-run: task cluster:bootstrap -- {{.CLUSTER_ID}}"
        fi
        echo ""

        # Wait for nodes with extended timeout
        echo "‚è≥ Waiting for nodes to be Ready (up to 8 minutes)..."
        MAX_WAIT=480
        ELAPSED=0
        LAST_NODE_STATUS=""
        while [ $ELAPSED -lt $MAX_WAIT ]; do
          READY=$(kubectl get nodes --no-headers 2>/dev/null | grep " Ready " | wc -l || echo "0")
          TOTAL=$(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo "0")
          NOT_READY=$(kubectl get nodes --no-headers 2>/dev/null | grep " NotReady " | wc -l || echo "0")

          if [ "$READY" -gt 0 ] && [ "$READY" -eq "$TOTAL" ]; then
            echo "  ‚úì All nodes Ready ($READY/$TOTAL nodes, ${ELAPSED}s)"
            break
          fi

          # Show status updates every 15s or when status changes
          CURRENT_NODE_STATUS="$READY/$TOTAL ready, $NOT_READY NotReady"
          if [ $((ELAPSED % 15)) -eq 0 ] || [ "$CURRENT_NODE_STATUS" != "$LAST_NODE_STATUS" ]; then
            if [ "$TOTAL" -gt 0 ]; then
              echo "  ‚è≥ Nodes: $READY/$TOTAL ready, $NOT_READY NotReady (${ELAPSED}s/${MAX_WAIT}s)"
            else
              echo "  ‚è≥ Waiting for nodes to register... (${ELAPSED}s/${MAX_WAIT}s)"
            fi
            LAST_NODE_STATUS="$CURRENT_NODE_STATUS"
          fi
          sleep 5
          ELAPSED=$((ELAPSED + 5))
        done

        if [ $ELAPSED -ge $MAX_WAIT ]; then
          echo ""
          echo "  ‚ö†Ô∏è  Not all nodes ready after ${MAX_WAIT}s"
          echo "  üìä Final status: $READY/$TOTAL ready, $NOT_READY NotReady"
          kubectl get nodes 2>/dev/null || true
          echo ""
          echo "  üí° Re-run this task to retry: task cluster:bootstrap -- {{.CLUSTER_ID}}"
        fi
        echo ""

        echo "‚úÖ Cluster bootstrapped successfully!"
        echo ""
        echo "üìä Cluster Status:"
        kubectl get nodes
        echo ""
        kubectl get pods -n kube-system -l k8s-app=cilium
        echo ""
        echo "üéØ Next steps:"
        echo "  1. Install Flux GitOps:"
        echo "     task flux:install -- {{.CLUSTER_ID}}"
        echo ""
        echo "  2. Check cluster health:"
        echo "     task status:cluster"
        echo ""
        echo "  3. View Cilium status:"
        echo "     kubectl exec -n kube-system ds/cilium -- cilium status"

  cluster:create:
    desc: 'üöÄ Create complete cluster (steps 1-4)'
    summary: |
      Usage: task cluster:create -- <cluster_id>
      Example: task cluster:create -- 101

      Automated cluster creation workflow:
        1. Provision infrastructure
        2. Generate secrets
        3. Generate configs
        4. Bootstrap cluster

      Time: ~15-20 minutes

      Interactive mode: Uses Gum for progress bars (local)
      CI/CD mode: Plain text output (detected automatically)

      üìö Docs: docs/cluster/creation.md
    cmds:
      - |
        #!/bin/bash
        set -e

        # Detect TTY for interactive vs CI/CD
        if [ -t 0 ] && command -v gum &> /dev/null; then
          # Interactive mode with Gum
          echo "üöÄ Creating cluster {{.CLUSTER_ID}} (interactive mode)"
          echo ""

          gum spin --spinner moon --title "Step 1/5: Provisioning VMs..." -- \
            task infra:provision -- {{.CLUSTER_ID}}
          echo "$(gum style --foreground 212 '‚úì') VMs provisioned"

          gum spin --spinner moon --title "Step 2/5: Generating secrets..." -- \
            task talos:secrets -- {{.CLUSTER_ID}}
          echo "$(gum style --foreground 212 '‚úì') Secrets generated"

          gum spin --spinner moon --title "Step 3/5: Generating configs..." -- \
            task talos:config -- {{.CLUSTER_ID}}
          echo "$(gum style --foreground 212 '‚úì') Configs generated"

          gum spin --spinner pulse --title "Step 4/5: Waiting for VMs (60s)..." -- \
            sleep 60
          echo "$(gum style --foreground 212 '‚úì') VMs ready"

          gum spin --spinner moon --title "Step 5/5: Bootstrapping cluster..." -- \
            task cluster:bootstrap -- {{.CLUSTER_ID}}
          echo "$(gum style --foreground 212 '‚úì') Cluster bootstrapped"

          echo ""
          gum style --foreground 212 --border double --padding "1 2" --bold \
            "‚úì Cluster {{.CLUSTER_ID}} Created!" \
            "" \
            "Next: task flux:install -- {{.CLUSTER_ID}}"
        else
          # CI/CD mode (plain text)
          echo "üöÄ Creating cluster {{.CLUSTER_ID}} (CI/CD mode)"
          echo ""

          echo "Step 1/5: Provisioning infrastructure..."
          task infra:provision -- {{.CLUSTER_ID}}
          echo ""

          echo "Step 2/5: Generating secrets..."
          task talos:secrets -- {{.CLUSTER_ID}}
          echo ""

          echo "Step 3/5: Generating configs..."
          task talos:config -- {{.CLUSTER_ID}}
          echo ""

          echo "Step 4/5: Waiting 60s for VMs..."
          sleep 60
          echo ""

          echo "Step 5/5: Bootstrapping cluster..."
          task cluster:bootstrap -- {{.CLUSTER_ID}}
          echo ""

          echo "‚úÖ Cluster {{.CLUSTER_ID}} created successfully!"
          echo ""
          echo "Next steps:"
          echo "  kubectl get nodes"
          echo "  task flux:install -- {{.CLUSTER_ID}}"
        fi

  cluster:destroy:
    desc: 'üóëÔ∏è  Destroy complete cluster'
    summary: |
      Usage: task cluster:destroy -- <cluster_id>
      Example: task cluster:destroy -- 102

      ‚ö†Ô∏è  DESTRUCTIVE: Removes all VMs and configuration

      Protection: cluster-101 requires name confirmation
      Skip: SKIP_CONFIRM=1 task cluster:destroy -- <id>

      üìö Docs: docs/cluster/destruction.md
    preconditions:
      - sh: '[ -n "{{.CLUSTER_ID}}" ]'
        msg: "‚ùå Usage: task cluster:destroy -- <cluster_id>"
    prompt: |
      {{if ne .SKIP_CONFIRM "1"}}
      ‚ö†Ô∏è  DESTROY cluster-{{.CLUSTER_ID}}?

      This will:
        - Delete all VMs
        - Remove all data
        - Clean up configs

      Type 'yes' to confirm:
      {{end}}
    cmds:
      - |
        {{if and (eq .CLUSTER_ID "101") (ne .SKIP_CONFIRM "1")}}
        echo "üõë PRODUCTION PROTECTION"
        echo "Type cluster name 'sol' to confirm:"
        read -p "> " confirm
        if [ "$confirm" != "sol" ]; then
          echo "‚ùå Cancelled"
          exit 1
        fi
        {{end}}
      - echo "üóëÔ∏è  Destroying infrastructure..."
      - task: infra:destroy
        vars: { CLUSTER_NAME: '{{.CLUSTER_ID}}' }
      - echo "üóëÔ∏è  Removing configs..."
      - rm -rf talos/clusters/cluster-{{.CLUSTER_ID}}
      - echo "‚úÖ Cluster destroyed"

  # ===========================================================================
  # FLUX - GitOps Management
  # ===========================================================================

  flux:install:
    desc: '5Ô∏è‚É£  Install Flux CD for GitOps'
    aliases: ['flux:bootstrap']
    summary: |
      Usage: task flux:install -- <cluster_id>
      Example: task flux:install -- 101

      Installs Flux CD for GitOps continuous delivery.

      Prerequisites:
        - GITHUB_TOKEN env var or 1Password CLI
        - SOPS age key: ~/.config/sops/age/keys.txt
        - Cluster with CNI (task cluster:bootstrap)

      Time: ~2-3 minutes

      üìö Docs: docs/flux/installation.md
    preconditions:
      - sh: 'kubectl cluster-info &>/dev/null'
        msg: |
          ‚ùå Kubernetes API not accessible

          Run: task cluster:bootstrap -- {{.CLUSTER_ID}}
      - sh: 'kubectl get nodes | grep -q Ready'
        msg: |
          ‚ùå No Ready nodes

          Run: task cluster:bootstrap -- {{.CLUSTER_ID}}
      - sh: '[ -f ~/.config/sops/age/keys.txt ]'
        msg: |
          ‚ùå SOPS age key not found

          Location: ~/.config/sops/age/keys.txt
      - sh: 'command -v flux &>/dev/null'
        msg: |
          ‚ùå flux CLI not found

          Install: brew install fluxcd/tap/flux
    cmds:
      - |
        echo "üîÑ Installing Flux CD..."
        echo ""

        FLUX_PATH="kubernetes/clusters/cluster-{{.CLUSTER_ID}}"

        # Get GitHub token
        if command -v op &>/dev/null; then
          GITHUB_TOKEN=$(op item get "GitHub Token - flux" --fields token --reveal 2>/dev/null || echo "$GITHUB_TOKEN")
        fi

        if [ -z "$GITHUB_TOKEN" ]; then
          echo "‚ùå GitHub token required"
          echo ""
          echo "Set: export GITHUB_TOKEN=ghp_..."
          exit 1
        fi

        export GITHUB_TOKEN

        # Create namespace
        kubectl create namespace flux-system --dry-run=client -o yaml | kubectl apply -f -

        # Create SOPS secret
        cat ~/.config/sops/age/keys.txt | \
        kubectl create secret generic sops-age \
          --namespace=flux-system \
          --from-file=age.agekey=/dev/stdin \
          --dry-run=client -o yaml | \
        kubectl apply -f -

        # Pre-check
        flux check --pre || echo "  ‚ö†Ô∏è  Pre-check warnings (expected for K8s < 1.32)"

        # Bootstrap
        echo ""
        echo "üöÄ Bootstrapping Flux..."
        flux bootstrap github \
          --owner=sulibot \
          --repository=home-ops \
          --branch=main \
          --path="${FLUX_PATH}" \
          --personal \
          --private \
          --token-auth \
          --interval=10m \
          --timeout=10m

        echo ""
        flux check

        echo ""
        echo "‚úÖ Flux installed!"
        echo ""
        echo "Repository: sulibot/home-ops"
        echo "Path: ${FLUX_PATH}"
        echo ""
        echo "Monitor:"
        echo "  task flux:status"
        echo "  task flux:logs"

  flux:reconcile:
    desc: 'Force Flux to reconcile all resources'
    summary: |
      Usage: task flux:reconcile [--namespace=<ns>]
      Example: task flux:reconcile

      Forces Flux to sync from Git immediately.

      üìö Docs: docs/flux/operations.md
    cmds:
      - |
        echo "üîÑ Forcing Flux reconciliation..."
        flux reconcile source git flux-system
        flux reconcile kustomization flux-system
        echo "‚úÖ Reconciliation triggered"

  flux:status:
    desc: 'Show Flux reconciliation status'
    summary: |
      Usage: task flux:status

      Shows status of all Flux resources.
    cmds:
      - |
        echo "üìä Flux Status"
        echo ""
        echo "Sources:"
        flux get sources git
        echo ""
        echo "Kustomizations:"
        flux get kustomizations
        echo ""
        echo "HelmReleases:"
        flux get helmreleases -A

  flux:logs:
    desc: 'Stream Flux controller logs'
    summary: |
      Usage: task flux:logs [--follow] [--since=<duration>]
      Example: task flux:logs --follow
    cmds:
      - flux logs --all-namespaces {{.CLI_ARGS}}

  flux:suspend:
    desc: 'Suspend Flux reconciliation'
    summary: |
      Usage: task flux:suspend -- <resource>
      Example: task flux:suspend -- kustomization/apps
    cmds:
      - flux suspend {{.CLI_ARGS}}

  flux:resume:
    desc: 'Resume Flux reconciliation'
    summary: |
      Usage: task flux:resume -- <resource>
      Example: task flux:resume -- kustomization/apps
    cmds:
      - flux resume {{.CLI_ARGS}}

  # ===========================================================================
  # STATUS - Health & Monitoring
  # ===========================================================================

  status:cluster:
    desc: 'Show overall cluster health'
    summary: |
      Usage: task status:cluster

      Comprehensive cluster health check.

      üìö Docs: docs/operations/monitoring.md
    cmds:
      - |
        echo "üè• Cluster Health Report"
        echo ""
        echo "Nodes:"
        kubectl get nodes
        echo ""
        echo "System Pods:"
        kubectl get pods -n kube-system -o wide
        echo ""
        echo "Flux Status:"
        flux get all -A 2>/dev/null || echo "  Flux not installed"
        echo ""
        echo "Recent Events:"
        kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -10

  status:nodes:
    desc: 'Show node status and resource usage'
    summary: |
      Usage: task status:nodes
    cmds:
      - |
        echo "üìä Node Status"
        echo ""
        kubectl get nodes -o wide
        echo ""
        echo "Resource Usage:"
        kubectl top nodes 2>/dev/null || echo "  Metrics server not available"

  status:flux:
    desc: 'Show Flux reconciliation status'
    summary: |
      Usage: task status:flux
    cmds:
      - task: flux:status

  status:cilium:
    desc: 'Check Cilium CNI health'
    summary: |
      Usage: task status:cilium

      Checks Cilium pod status and connectivity.
    cmds:
      - |
        echo "üîå Cilium Status"
        echo ""
        kubectl get pods -n kube-system -l k8s-app=cilium
        echo ""
        echo "Cilium Status:"
        kubectl exec -n kube-system -c cilium-agent $(kubectl get pods -n kube-system -l k8s-app=cilium -o jsonpath='{.items[0].metadata.name}') -- cilium status 2>/dev/null || echo "  Unable to get status"

  status:storage:
    desc: 'Show storage and PV status'
    summary: |
      Usage: task status:storage
    cmds:
      - |
        echo "üíæ Storage Status"
        echo ""
        echo "Storage Classes:"
        kubectl get storageclasses
        echo ""
        echo "Persistent Volumes:"
        kubectl get pv
        echo ""
        echo "Persistent Volume Claims:"
        kubectl get pvc -A

  status:pods:
    desc: 'Show pod status across all namespaces'
    summary: |
      Usage: task status:pods [--namespace=<ns>]
    cmds:
      - kubectl get pods -A {{.CLI_ARGS}}

  status:all:
    desc: 'Run all health checks'
    summary: |
      Usage: task status:all

      Comprehensive health check of entire cluster.
    cmds:
      - task: status:cluster
      - echo ""
      - task: status:cilium
      - echo ""
      - task: status:storage

  # ===========================================================================
  # LOGS - Log Viewing
  # ===========================================================================

  logs:talos:
    desc: 'Stream Talos node logs'
    summary: |
      Usage: task logs:talos -- <cluster_id> [--node=<ip>]
      Example: task logs:talos -- 101

      üìö Docs: docs/talos/troubleshooting.md
    dir: 'talos/clusters/cluster-{{.CLUSTER_ID}}'
    cmds:
      - |
        NODE=$(yq -r '.solcp01_public_ipv6 // .solcp01_ipAddress // ""' talenv.yaml)
        echo "üìã Talos logs from $NODE"
        talosctl dmesg --nodes "$NODE" --talosconfig ./talosconfig {{.CLI_ARGS}}

  logs:flux:
    desc: 'Stream Flux controller logs'
    summary: |
      Usage: task logs:flux [--follow]
    cmds:
      - task: flux:logs

  logs:cilium:
    desc: 'Stream Cilium logs'
    summary: |
      Usage: task logs:cilium
    cmds:
      - kubectl logs -n kube-system -l k8s-app=cilium --tail=100 -f

  logs:pod:
    desc: 'Stream pod logs'
    summary: |
      Usage: task logs:pod -- <namespace/pod> [--follow] [--tail=<lines>]
      Example: task logs:pod -- kube-system/cilium-abc123 --follow
    cmds:
      - kubectl logs {{.CLI_ARGS}}

  # ===========================================================================
  # OPS - Operations & Maintenance
  # ===========================================================================

  ops:drain:
    desc: 'Drain node for maintenance'
    summary: |
      Usage: task ops:drain -- <node_name>
      Example: task ops:drain -- solwk01

      Safely drains node by evicting all pods.

      üìö Docs: docs/operations/maintenance.md
    cmds:
      - |
        echo "üöß Draining node {{.CLI_ARGS}}..."
        kubectl drain {{.CLI_ARGS}} --ignore-daemonsets --delete-emptydir-data
        echo "‚úÖ Node drained"

  ops:cordon:
    desc: 'Cordon node (mark unschedulable)'
    summary: |
      Usage: task ops:cordon -- <node_name>
      Example: task ops:cordon -- solwk01
    cmds:
      - kubectl cordon {{.CLI_ARGS}}

  ops:uncordon:
    desc: 'Uncordon node (mark schedulable)'
    summary: |
      Usage: task ops:uncordon -- <node_name>
      Example: task ops:uncordon -- solwk01
    cmds:
      - kubectl uncordon {{.CLI_ARGS}}

  ops:reboot:
    desc: 'Safely reboot Talos node'
    summary: |
      Usage: task ops:reboot -- <cluster_id> <node_ip>
      Example: task ops:reboot -- 101 fd00:101::11

      üìö Docs: docs/talos/operations.md
    dir: 'talos/clusters/cluster-{{.CLUSTER_ID}}'
    cmds:
      - |
        echo "üîÑ Rebooting node {{.CLI_ARGS}}..."
        talosctl reboot --nodes {{.CLI_ARGS}} --talosconfig ./talosconfig
        echo "‚úÖ Reboot initiated"

  ops:shell:
    desc: 'Open interactive Talos shell'
    summary: |
      Usage: task ops:shell -- <cluster_id> <node_ip>
      Example: task ops:shell -- 101 fd00:101::11
    dir: 'talos/clusters/cluster-{{.CLUSTER_ID}}'
    cmds:
      - talosctl shell --nodes {{.CLI_ARGS}} --talosconfig ./talosconfig

  ops:upgrade:talos:
    desc: 'Upgrade Talos version'
    summary: |
      Usage: task ops:upgrade:talos -- <cluster_id> <version>
      Example: task ops:upgrade:talos -- 101 v1.11.6

      Upgrades Talos across all nodes safely.

      üìö Docs: docs/talos/upgrades.md
    dir: 'talos/clusters/cluster-{{.CLUSTER_ID}}'
    cmds:
      - |
        VERSION={{.CLI_ARGS}}
        echo "‚¨ÜÔ∏è  Upgrading Talos to $VERSION..."
        echo ""
        echo "Control Plane Nodes:"
        for node in $(kubectl get nodes -l node-role.kubernetes.io/control-plane -o jsonpath='{.items[*].status.addresses[?(@.type=="InternalIP")].address}'); do
          echo "  ‚Üí Upgrading $node..."
          talosctl upgrade --nodes "$node" --talosconfig ./talosconfig --image "ghcr.io/siderolabs/installer:$VERSION"
          echo "  ‚è≥ Waiting for node to be ready..."
          kubectl wait --for=condition=Ready node/$node --timeout=10m
        done
        echo ""
        echo "Worker Nodes:"
        for node in $(kubectl get nodes -l '!node-role.kubernetes.io/control-plane' -o jsonpath='{.items[*].status.addresses[?(@.type=="InternalIP")].address}'); do
          echo "  ‚Üí Upgrading $node..."
          talosctl upgrade --nodes "$node" --talosconfig ./talosconfig --image "ghcr.io/siderolabs/installer:$VERSION"
          echo "  ‚è≥ Waiting for node to be ready..."
          kubectl wait --for=condition=Ready node/$node --timeout=10m
        done
        echo ""
        echo "‚úÖ Talos upgrade complete"

  # ===========================================================================
  # DEBUG - Troubleshooting
  # ===========================================================================

  debug:events:
    desc: 'Watch cluster events in real-time'
    summary: |
      Usage: task debug:events [--namespace=<ns>]
      Example: task debug:events --namespace=default
    cmds:
      - kubectl get events --watch {{.CLI_ARGS}}

  debug:network:
    desc: 'Test network connectivity'
    summary: |
      Usage: task debug:network

      Runs network connectivity tests.
    cmds:
      - |
        echo "üîå Network Connectivity Test"
        echo ""
        echo "Testing pod-to-pod connectivity..."
        kubectl run netshoot --rm -i --tty --image nicolaka/netshoot -- /bin/bash -c "
          echo 'DNS test:';
          nslookup kubernetes.default.svc.cluster.local;
          echo '';
          echo 'Internet test:';
          ping -c 3 1.1.1.1
        " 2>/dev/null || echo "  Test pod failed"

  debug:dns:
    desc: 'Test DNS resolution'
    summary: |
      Usage: task debug:dns
    cmds:
      - |
        echo "üîç DNS Test"
        kubectl run dnstest --rm -i --tty --image busybox --restart=Never -- nslookup kubernetes.default.svc.cluster.local

  debug:pod:
    desc: 'Debug pod issues'
    summary: |
      Usage: task debug:pod -- <namespace/pod>
      Example: task debug:pod -- default/my-app-abc123
    cmds:
      - |
        echo "üîç Pod Debug Info"
        echo ""
        kubectl describe pod {{.CLI_ARGS}}
        echo ""
        echo "Recent Logs:"
        kubectl logs {{.CLI_ARGS}} --tail=50

  debug:node:
    desc: 'Debug node issues'
    summary: |
      Usage: task debug:node -- <node_name>
      Example: task debug:node -- solcp01
    cmds:
      - |
        echo "üîç Node Debug Info"
        echo ""
        kubectl describe node {{.CLI_ARGS}}
        echo ""
        echo "Node Conditions:"
        kubectl get node {{.CLI_ARGS}} -o jsonpath='{.status.conditions[*].type}: {.status.conditions[*].status}'

  # ===========================================================================
  # BACKUP - Backup & Recovery
  # ===========================================================================

  backup:etcd:
    desc: 'Backup etcd cluster'
    summary: |
      Usage: task backup:etcd -- <cluster_id>
      Example: task backup:etcd -- 101

      Creates etcd snapshot for disaster recovery.

      üìö Docs: docs/operations/backup.md
    dir: 'talos/clusters/cluster-{{.CLUSTER_ID}}'
    cmds:
      - |
        NODE=$(yq -r '.solcp01_public_ipv6 // .solcp01_ipAddress // ""' talenv.yaml)
        BACKUP_FILE="etcd-backup-$(date +%Y%m%d-%H%M%S).snapshot"

        echo "üíæ Backing up etcd..."
        talosctl -n "$NODE" --talosconfig ./talosconfig etcd snapshot "$BACKUP_FILE"
        echo "‚úÖ Backup saved: $BACKUP_FILE"

  backup:list:
    desc: 'List available backups'
    summary: |
      Usage: task backup:list -- <cluster_id>
    dir: 'talos/clusters/cluster-{{.CLUSTER_ID}}'
    cmds:
      - |
        echo "üìã Available Backups:"
        ls -lh etcd-backup-*.snapshot 2>/dev/null || echo "  No backups found"

  # ===========================================================================
  # K8S - Kubernetes Utilities
  # ===========================================================================

  k8s:context:
    desc: 'Show current kubectl context'
    summary: |
      Usage: task k8s:context
    cmds:
      - kubectl config current-context

  k8s:namespaces:
    desc: 'List all namespaces'
    summary: |
      Usage: task k8s:namespaces
    cmds:
      - kubectl get namespaces

  k8s:resources:
    desc: 'Show resource usage across cluster'
    summary: |
      Usage: task k8s:resources
    cmds:
      - |
        echo "üìä Cluster Resources"
        echo ""
        echo "Nodes:"
        kubectl top nodes
        echo ""
        echo "Pods (Top 20):"
        kubectl top pods -A | sort -k3 -rn | head -20

  k8s:port-forward:
    desc: 'Port forward to service/pod'
    summary: |
      Usage: task k8s:port-forward -- <local_port>:<namespace/resource:remote_port>
      Example: task k8s:port-forward -- 8080:default/svc/my-app:80
    cmds:
      - kubectl port-forward {{.CLI_ARGS}}
