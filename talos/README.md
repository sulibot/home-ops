## Talos Configuration Workflow

This repository uses **Terraform with the siderolabs/talos provider** to manage Talos clusters. The traditional talhelper/Jinja2 workflow has been replaced with native Terraform resources.

The flow for each cluster is:

1. **Image Building** – Terraform builds a custom Talos image with kernel arguments and system extensions defined in `common/schematic.hcl`
2. **VM Provisioning** – Terraform provisions VMs on Proxmox with the custom image
3. **Configuration Generation** – The `talos_config` module uses the Talos provider to generate machine configurations for all nodes
4. **Cluster Bootstrap** – The `talos_bootstrap` module applies configurations, bootstraps etcd, installs Cilium CNI, and deploys Flux GitOps

All steps are orchestrated via `task cluster:create CLUSTER_ID=101`

### Directory Structure

```
talos/
├── common/                      # Shared configuration (legacy, reference only)
│   └── schematic.yaml.j2       # Original Talos image schematic (kept for reference)
├── clusters/                    # Per-cluster outputs from Terraform
│   └── cluster-<id>/
│       ├── talosconfig         # Generated by Terraform (Talos CLI config)
│       └── kubeconfig          # Generated by Terraform (kubectl config)
├── scripts/                     # Legacy helper scripts (deprecated)
│   └── validate_talenv.py
└── templates/                   # Legacy Jinja2 templates (deprecated)
    └── talconfig.j2

# Active configuration is now in Terraform:
terraform/infra/
├── modules/
│   ├── talos_config/           # Generates Talos machine configurations
│   └── talos_bootstrap/        # Bootstraps and configures cluster
└── live/
    ├── common/
    │   └── schematic.hcl       # Active Talos image customization
    └── cluster-<id>/
        ├── talos-config/       # Configuration generation stack
        └── bootstrap/          # Bootstrap stack
```

### New Workflow

#### Quick Start
```bash
# Create complete cluster
task cluster:create CLUSTER_ID=101

# Access cluster
export TALOSCONFIG=talos/clusters/cluster-101/talosconfig
export KUBECONFIG=talos/clusters/cluster-101/kubeconfig

# Check cluster status
talosctl health
kubectl get nodes
```

#### Manual Terraform Workflow
```bash
# 1. Build custom Talos image
cd terraform/infra/live/cluster-101/image
terragrunt apply

# 2. Provision VMs
cd ../nodes
terragrunt apply

# 3. Generate Talos configurations
cd ../talos-config
terragrunt apply

# 4. Bootstrap cluster
cd ../bootstrap
terragrunt apply
```

### Configuration Management

#### Talos Image Customization

Modify `terraform/infra/live/common/schematic.hcl`:

```hcl
locals {
  schematic = {
    kernel_args = [
      "intel_iommu=on",
      "i915.enable_guc=3",
      "module_blacklist=igc",
    ]
    system_extensions = {
      official = [
        "siderolabs/i915",
        "siderolabs/zfs",
        "siderolabs/qemu-guest-agent",
      ]
      custom = [{
        image = "ghcr.io/jsenecal/frr-talos-extension:v1.0.2"
      }]
    }
    allow_unsigned_extensions = true
  }
}
```

#### Cluster-Specific Settings

Modify `terraform/infra/live/cluster-101/cluster.hcl`:

```hcl
locals {
  cluster_name  = "sol"
  cluster_id    = 101
  controlplanes = 3
  workers       = 3

  node_overrides = {
    "sol-wk01" = {
      memory_mb = 32768
      cpu_cores = 8
    }
  }
}
```

#### Version Management

Update `terraform/infra/live/common/versions.hcl`:

```hcl
locals {
  talos_version      = "v1.11.5"
  kubernetes_version = "v1.31.4"
  cilium_version     = "1.16.5"
}
```

Then run: `task cluster:upgrade CLUSTER_ID=101`

### Legacy Files

The following files are kept for reference but are no longer used:

- `talos/common/schematic.yaml.j2` - Replaced by `terraform/infra/live/common/schematic.hcl`
- `talos/templates/talconfig.j2` - Replaced by Terraform `talos_config` module
- `talos/scripts/validate_talenv.py` - No longer needed (Terraform handles validation)

#### Migration Notes

Old workflow used:
- talhelper for configuration generation
- Jinja2 templates for machine configs
- Manual secret management with talsecret.sops.yaml

New workflow uses:
- Native Terraform Talos provider resources
- Automatic secret generation via `talos_machine_secrets`
- Integrated bootstrap with Cilium and Flux

### Troubleshooting

#### View generated configuration
```bash
cd terraform/infra/live/cluster-101/talos-config
terragrunt output machine_configs
```

#### Re-apply configuration to nodes
```bash
task cluster:talos-config:apply CLUSTER_ID=101
```

#### Bootstrap issues
```bash
# Check bootstrap logs
cd terraform/infra/live/cluster-101/bootstrap
terragrunt output

# Re-run bootstrap
task cluster:bootstrap:apply CLUSTER_ID=101
```

#### Access cluster with talosctl
```bash
export TALOSCONFIG=talos/clusters/cluster-101/talosconfig

# List nodes
talosctl config nodes

# Check service status
talosctl service kubelet status

# Get logs
talosctl logs kubelet
```

## Secret Management

### Cluster Secrets (`secrets.sops.yaml`)
- **Encrypted with SOPS** - Required to add new nodes to cluster
- Contains cluster-wide secrets (bootstrap tokens, certificates, etcd keys)
- Automatically exported and encrypted by Terraform after `terragrunt apply`
- Decrypt for use: `sops -d talos/clusters/cluster-101/secrets.sops.yaml`
- **Committed to git** for team access and node addition

### Talosconfig (Per-User Credentials)
- **Not tracked in git** - Each user generates their own
- Automatically exported to `talos/clusters/cluster-101/talosconfig` by Terraform
- Automatically merged to `~/.talos/config` during cluster bootstrap
- Switch contexts: `talosctl config context cluster-101`

###  Kubeconfig (Per-User Credentials)
- Fetched via `talosctl kubeconfig --force` during bootstrap
- Automatically merged to `~/.kube/config`
- Context name: `cluster-101`

### Machine Configs (`controlplane.yaml`, `worker.yaml`)
- **Not tracked in git** - Regenerated from Terraform as needed
- Automatically exported for troubleshooting after `terragrunt apply`
- Available locally at `talos/clusters/cluster-101/{controlplane,worker}.yaml`
- Blocked from git by .gitignore (contains embedded secrets)

### For New Team Members
To get access to an existing cluster:
1. Clone the repo
2. Ensure you have the SOPS AGE key configured (`SOPS_AGE_KEY_FILE` env var)
3. Run: `cd terraform/infra/live/cluster-101/6-cluster-bootstrap && terragrunt apply`
4. Configs automatically merge to `~/.talos/config` and `~/.kube/config`
5. Use: `talosctl config context cluster-101` and `kubectl config use-context cluster-101`

### Adding New Nodes to Existing Cluster
1. Decrypt secrets: `sops -d talos/clusters/cluster-101/secrets.sops.yaml > /tmp/secrets.yaml`
2. Use secrets to generate config for new node
3. Apply config: `talosctl apply-config --nodes <new-node-ip> --file <config>.yaml`
4. Clean up decrypted file: `rm /tmp/secrets.yaml`
