## Talos Configuration Workflow

This repository keeps infrastructure (Terraform/Terragrunt) and Talos machine
configuration in sync without duplicating data. The flow for each cluster is:

1. **Terraform/Terragrunt** provisions or updates nodes and writes
   `talos/clusters/cluster-<id>/talenv.yaml` via the `talenv_yaml` Terraform output.
2. **Validation** – `task talos:gen-config -- <id>` runs
   `python3 scripts/validate_talenv.py --file talos/clusters/cluster-<id>/talenv.yaml`
   to ensure the env file contains the required cluster metadata and node
   definitions before advancing. (Uses PyYAML when available or falls back to
   the `yq` CLI.)
3. **Template rendering** – The same task renders `talos/templates/talconfig.j2`
   (Jinja2) with the values from `talenv.yaml`, producing a concrete
   `talos/clusters/cluster-<id>/talconfig.rendered.yaml`.
4. **talhelper** consumes the rendered config plus `talsecret.sops.yaml` to generate
   final per-node machine configs inside `talos/clusters/cluster-<id>/`.

### Directory Structure

```
talos/
├── common/                      # Shared configuration for all clusters
│   └── schematic.yaml.j2       # Talos image schematic (kernel args, extensions)
├── clusters/                    # Per-cluster generated configs
│   └── cluster-<id>/
│       ├── talenv.yaml         # Generated by Terraform (node IPs, metadata)
│       ├── talsecret.sops.yaml # Encrypted cluster secrets
│       ├── talconfig.rendered.yaml  # Generated from template (gitignored)
│       ├── talosconfig         # Talos CLI config
│       └── cluster-<id>-*.yaml # Generated node configs
├── scripts/                     # Validation and helper scripts
│   └── validate_talenv.py
└── templates/                   # Jinja2 templates
    └── talconfig.j2            # Main cluster configuration template
```

### Role-specific configuration

The Jinja template (`talos/templates/talconfig.j2`) supports branching on the `controlPlane` flag per node so we can
keep a single template while still producing different control-plane and worker
configurations. For example:

- Control-plane nodes receive `node-role.kubernetes.io/control-plane` labels and a
  `NoSchedule` taint by default.
- Worker nodes receive `node-role.kubernetes.io/worker` labels.

Additional role-specific tweaks can be added by extending the template with more
`{% if node.controlPlane %}` blocks.

### Regenerating configs

```bash
# From repo root
task talos:gen-config -- 101
```

The command validates the env file, renders the template with `jinja2`, and calls
`talhelper genconfig`. The resulting files stay under
`talos/clusters/cluster-101/`. The intermediate `talconfig.rendered.yaml` is
ignored by Git (`.gitignore`) but kept for easy inspection.
