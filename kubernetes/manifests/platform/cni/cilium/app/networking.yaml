---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumloadbalancerippool_v2.json
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: blue-pool
spec:
  blocks:
    # Range for Gateway LoadBalancer IPs (fd00:101::cafe:0 - fd00:101::cafe:ffff)
    - cidr: "fd00:101::cafe:0/112"
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumingressclass_v2.json
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: l2-announcement-policy
spec:
  # Announce LoadBalancer IPs on all network interfaces
  # Using broader patterns to match various interface naming schemes
  interfaces:
    - ^eth[0-9]+
    - ^ens[0-9]+
    - ^eno[0-9]+
    - ^enp[0-9]+s[0-9]+
  # Select LoadBalancer services from the blue-pool
  loadBalancerIPs: true
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/os
        operator: In
        values:
          - linux
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpadvertisement_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: advertise-pod-cidr
spec:
  # Advertise the PodCIDR assigned to each node.
  # This makes pods directly routable from your external network.
  advertisements:
    - advertisementType: PodCIDR
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpadvertisement_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: advertise-services
spec:
  # Advertise all LoadBalancer Service IPs via BGP.
  # This includes Gateway LoadBalancer IPs managed by Cilium.
  advertisements:
    - advertisementType: Service
      service:
        addresses: [LoadBalancerIP]
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgppeerconfig_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPPeerConfig
metadata:
  name: default-peer-config
spec:
  # IPv6-only address family
  families:
    - afi: ipv6
      safi: unicast
  # Enable graceful restart to prevent traffic loss during agent restarts.
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 120
  ebgpMultihop: 2
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpclusterconfig_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPClusterConfig
metadata:
  name: home-ops-bgp-config
spec:
  bgpInstances:
    - name: cilium-instance
      localASN: 65101
      peers:
        - name: edge-router-cilium
          peerASN: 65000
          peerAddress: "fd00:255::fffe"
          peerConfigRef:
            name: default-peer-config
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/gateway.networking.k8s.io/gatewayclass_v1.json
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: cilium
spec:
  controllerName: io.cilium/gateway-controller
