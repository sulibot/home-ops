---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumloadbalancerippool_v2.json
apiVersion: cilium.io/v2
kind: CiliumLoadBalancerIPPool
metadata:
  name: blue-pool-ipv6
spec:
  blocks:
    # Range for Gateway LoadBalancer IPs (fd00:101::cafe:0 - fd00:101::cafe:ffff)
    - cidr: "fd00:101::cafe:0/112"
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumloadbalancerippool_v2.json
apiVersion: cilium.io/v2
kind: CiliumLoadBalancerIPPool
metadata:
  name: blue-pool-ipv4
spec:
  blocks:
    # Range for dual-stack services (10.96.192.0 - 10.96.195.255, 1024 IPs)
    - cidr: "10.96.192.0/22"
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpadvertisement_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: advertise-pod-cidr
  labels:
    cilium-bgp-policy: pod-cidr
spec:
  # Advertise the PodCIDR assigned to each node.
  # This makes pods directly routable from your external network.
  advertisements:
    - advertisementType: PodCIDR
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpadvertisement_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: advertise-services
  labels:
    cilium-bgp-policy: services
spec:
  # Advertise Kubernetes Service IPs via BGP.
  advertisements:
    - advertisementType: Service
      service:
        addresses: [LoadBalancerIP, ClusterIP]
      selector:
        matchLabels:
          bgp-advertise: "true"
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgppeerconfig_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPPeerConfig
metadata:
  name: internal-peer-config
spec:
  # IPv6-only address family for internal P2P mesh
  families:
    - afi: ipv6
      safi: unicast
      advertisements:
        matchExpressions:
          - key: cilium-bgp-policy
            operator: In
            values:
              - pod-cidr
  # Enable graceful restart to prevent traffic loss during agent restarts.
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 120
  # Use custom port for iBGP mesh to avoid conflict with FRR on port 179
  transport:
    peerPort: 1179
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgppeerconfig_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPPeerConfig
metadata:
  name: external-peer-config
spec:
  # Dual-stack address families for external ROS
  families:
    - afi: ipv6
      safi: unicast
      advertisements:
        matchExpressions:
          - key: cilium-bgp-policy
            operator: In
            values:
              - services
    - afi: ipv4
      safi: unicast
      advertisements:
        matchExpressions:
          - key: cilium-bgp-policy
            operator: In
            values:
              - services
  # Enable graceful restart to prevent traffic loss during agent restarts.
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 120
  ebgpMultihop: 2
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/cilium.io/ciliumbgpclusterconfig_v2.json
apiVersion: cilium.io/v2
kind: CiliumBGPClusterConfig
metadata:
  name: home-ops-bgp-config
spec:
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/os
        operator: In
        values:
          - linux
  bgpInstances:
    - name: internal-p2p-mesh
      localASN: 65101
      localPort: 1179
      peers:
        - name: solcp011-internal
          peerASN: 65101
          peerAddress: "fc00:101::11"
          peerConfigRef:
            name: internal-peer-config
        - name: solcp012-internal
          peerASN: 65101
          peerAddress: "fc00:101::12"
          peerConfigRef:
            name: internal-peer-config
        - name: solcp013-internal
          peerASN: 65101
          peerAddress: "fc00:101::13"
          peerConfigRef:
            name: internal-peer-config
        - name: solwk021-internal
          peerASN: 65101
          peerAddress: "fc00:101::21"
          peerConfigRef:
            name: internal-peer-config
        - name: solwk022-internal
          peerASN: 65101
          peerAddress: "fc00:101::22"
          peerConfigRef:
            name: internal-peer-config
        - name: solwk023-internal
          peerASN: 65101
          peerAddress: "fc00:101::23"
          peerConfigRef:
            name: internal-peer-config
    - name: external-ros
      localASN: 65101
      peers:
        - name: edge-router-external
          peerASN: 65000
          peerAddress: "fd00:101::fffe"
          peerConfigRef:
            name: external-peer-config
