---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPPeerConfig
metadata:
  name: default-peer-config
spec:
  # Enable graceful restart to prevent traffic loss during agent restarts.
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 120 # Default is 120s, 15s is quite short.
  # Allow peering with a router that is not directly connected.
  ebgpMultihop: 2
  # Align timers with the router configuration for predictable behavior.
  holdTimeSeconds: 30
  keepaliveTimeSeconds: 10
---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPClusterConfig
metadata:
  name: home-ops-bgp-config
spec:
  # Apply this BGP configuration to all Linux nodes in the cluster.
  nodeSelector:
    matchLabels:
      kubernetes.io/os: linux
  bgpInstances:
    - name: "main-instance"
      localASN: 65101
      peers:
        - name: "edge-router"
          peerASN: 65000
          peerAddress: "fd00:255::fffe"
          # Reference the reusable peer configuration.
          peerConfigRef:
            name: default-peer-config
---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPAdvertisement
metadata:
  name: advertise-pod-cidr
spec:
  # Advertise the PodCIDR assigned to each node.
  # This makes pods directly routable from your external network.
  advertisements:
    - advertisementType: PodCIDR
---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPAdvertisement
metadata:
  name: advertise-services
spec:
  # Advertise Kubernetes Service IPs via BGP.
  advertisements:
    - advertisementType: Service
      service:
        # Advertise both LoadBalancer and ClusterIP addresses.
        addresses: [LoadBalancerIP, ClusterIP]
      # Best Practice: Use a label selector to explicitly control which services are advertised.
      selector:
        matchLabels:
          bgp-advertise: "true"
