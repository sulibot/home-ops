---
# Bootstrap Helmfile for cluster-101
# Installs critical components BEFORE Flux is running
#
# Components installed:
# - Cilium CNI (networking required for Flux pods)
# - Spegel (P2P image distribution mirror)
#
# Usage:
#   helmfile apply
#
# After bootstrap, Flux will adopt these HelmReleases

repositories:
  - name: cilium
    url: https://helm.cilium.io

releases:
  - name: cilium
    namespace: kube-system
    chart: cilium/cilium
    version: 1.18.4
    values:
      - ../apps/networking/cilium/app/values.yaml
    wait: true
    timeout: 300
    hooks:
      - events: ["postsync"]
        showlogs: true
        command: "kubectl"
        args:
          - "wait"
          - "--for=condition=Ready"
          - "pods"
          - "-l"
          - "k8s-app=cilium"
          - "-n"
          - "kube-system"
          - "--timeout=5m"

  - name: spegel
    namespace: kube-system
    chart: oci://ghcr.io/spegel-org/helm-charts/spegel
    version: 0.4.0
    needs:
      - kube-system/cilium
    wait: true
    timeout: 120
    values:
      - spegel:
          containerdSock: /run/containerd/containerd.sock
          containerdRegistryConfigPath: /etc/cri/conf.d/hosts
        service:
          registry:
            hostPort: 29999
