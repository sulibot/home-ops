version: '3'

includes:
  app: .taskfiles/app/gomplate-taskfile.yaml

tasks:
  scaffold-default-values:
    desc: "Scaffold values.yaml for a new app (NAME & NAMESPACE required)"
    vars:
      NAME: '{{.NAME | default "example"}}'
      NAMESPACE: '{{.NAMESPACE | default "default"}}'
    cmds:
      - mkdir -p kubernetes/apps/{{.NAMESPACE}}/{{.NAME}}
      - cp .taskfiles/app/values.tmpl.yaml kubernetes/apps/{{.NAMESPACE}}/{{.NAME}}/values.yaml
      - echo "âœ… Created scaffolded values.yaml for {{.NAME}}"

  create-app:
    desc: "Render all gomplate templates for an app"
    vars:
      NAME: '{{.NAME | default "example"}}'
      NAMESPACE: '{{.NAMESPACE | default "default"}}'
    cmds:
      - echo "ðŸ”§ Generating manifests for '{{.NAME}}' in namespace '{{.NAMESPACE}}'"
      - mkdir -p kubernetes/apps/{{.NAMESPACE}}/{{.NAME}}
      - |
        for f in helmrelease externalsecret volsync gatus ks kustomization prometheusrule lokirule; do
          gomplate \
            --file .taskfiles/app/${f}.yaml.tmpl \
            --datasource values=kubernetes/apps/{{.NAMESPACE}}/{{.NAME}}/values.yaml \
            --out kubernetes/apps/{{.NAMESPACE}}/{{.NAME}}/${f}.yaml
        done
