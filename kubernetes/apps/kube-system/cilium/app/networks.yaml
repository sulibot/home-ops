---
# CiliumLoadBalancerIPPool for internal IPv6 allocation
apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: pool
spec:
  allowFirstLastIPs: "No"
  blocks:
    - cidr: fd00:101::/120
---
# L2 Announcement Policy
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: l2-policy
spec:
  loadBalancerIPs: true
  interfaces: ["^eth0$"]
  nodeSelector:
    matchLabels:
      kubernetes.io/os: linux
---
# BGP Advertisement
apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: l3-bgp-advertisement
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: Service
      service:
        addresses: ["LoadBalancerIP"]
      selector:
        matchExpressions:
          - { key: somekey, operator: NotIn, values: ["never-used-value"] }
---
# BGP PeerConfig (IPv6 MikroTik peer)
apiVersion: cilium.io/v2
kind: CiliumBGPPeerConfig
metadata:
  name: l3-bgp-peer-config
spec:
  timers:
    connectRetryTimeSeconds: 30
    holdTimeSeconds: 30
    keepAliveTimeSeconds: 10
  families:
    - afi: ipv6
      safi: unicast
      advertisements:
        matchLabels:
          advertise: bgp
---
# Cluster-wide BGP Config
apiVersion: cilium.io/v2
kind: CiliumBGPClusterConfig
metadata:
  name: l3-bgp-cluster-config
spec:
  nodeSelector:
    matchLabels:
      kubernetes.io/os: linux
  bgpInstances:
    - name: cilium
      localASN: 65101
      peers:
        - name: mikrotik
          peerASN: 65000
          peerAddress: fd00:101::fffe
          peerConfigRef:
            name: l3-bgp-peer-config
---
# Per-node BGP config overrides to set unique source IPs
# Control plane nodes
apiVersion: cilium.io/v2
kind: CiliumBGPNodeConfigOverride
metadata:
  name: solcp011-bgp-override
spec:
  nodeRef: solcp011
  bgpInstances:
    - name: cilium
      localAddress: fd00:255:101::11
---
apiVersion: cilium.io/v2
kind: CiliumBGPNodeConfigOverride
metadata:
  name: solcp012-bgp-override
spec:
  nodeRef: solcp012
  bgpInstances:
    - name: cilium
      localAddress: fd00:255:101::12
---
apiVersion: cilium.io/v2
kind: CiliumBGPNodeConfigOverride
metadata:
  name: solcp013-bgp-override
spec:
  nodeRef: solcp013
  bgpInstances:
    - name: cilium
      localAddress: fd00:255:101::13
---
# Worker nodes
apiVersion: cilium.io/v2
kind: CiliumBGPNodeConfigOverride
metadata:
  name: solwk021-bgp-override
spec:
  nodeRef: solwk021
  bgpInstances:
    - name: cilium
      localAddress: fd00:255:101::21
---
apiVersion: cilium.io/v2
kind: CiliumBGPNodeConfigOverride
metadata:
  name: solwk022-bgp-override
spec:
  nodeRef: solwk022
  bgpInstances:
    - name: cilium
      localAddress: fd00:255:101::22
---
apiVersion: cilium.io/v2
kind: CiliumBGPNodeConfigOverride
metadata:
  name: solwk023-bgp-override
spec:
  nodeRef: solwk023
  bgpInstances:
    - name: cilium
      localAddress: fd00:255:101::23