---
# Cilium Bootstrap Values for cluster-101
# Talos-specific configuration with dual-stack networking
#
# This file is used by helmfile during bootstrap.
# After Flux takes over, these same values are managed by the HelmRelease.

# API Server endpoint - use localhost for Talos
k8sServiceHost: localhost
k8sServicePort: 7445

# Replace kube-proxy with Cilium
kubeProxyReplacement: true

# Enable dual-stack
ipv4:
  enabled: true
ipv6:
  enabled: true

# IPAM mode
ipam:
  mode: kubernetes

# Native routing (no encapsulation for better performance)
routingMode: native
tunnelProtocol: disabled
tunnel: disabled
autoDirectNodeRoutes: true
endpointRoutes:
  enabled: true

# Pod CIDRs for cluster-101
ipv4NativeRoutingCIDR: 10.101.0.0/16
ipv6NativeRoutingCIDR: fd00:101:1::/60

# Enable BPF masquerading (iptables-free NAT)
# Only masquerade traffic going outside the cluster network
bpf:
  masquerade: true

# Disable masquerading for traffic within these CIDRs
# This allows native routing within your cluster/network
# Traffic to the internet will still be masqueraded
ipMasqAgent:
  enabled: true
  config:
    nonMasqueradeCIDRs:
      # Cluster pod CIDRs - use native routing
      - 10.101.0.0/16
      - fd00:101:1::/60
      # Node networks - use native routing
      - 10.0.101.0/24
      - fd00:101::/64
      - 10.10.101.0/24
      - fc00:101::/64
      # RFC1918 private networks - typically don't masquerade
      - 10.0.0.0/8
      - 172.16.0.0/12
      - 192.168.0.0/16
      # IPv6 ULA - typically don't masquerade
      - fc00::/7
      # Link-local
      - 169.254.0.0/16
      - fe80::/10

# BGP Control Plane for VIP and LoadBalancer advertisement
bgpControlPlane:
  enabled: true

# LoadBalancer IP Address Management (IPAM)
# Define pools of IPs that can be assigned to LoadBalancer services
# These IPs will be advertised via BGP to the upstream router
l2announcements:
  enabled: false  # Using BGP instead of L2

# LB IPAM pools - IPs from these pools are assigned to LoadBalancer services
# and advertised via BGP so the router knows how to route them back to the cluster
ingressController:
  enabled: false
  loadbalancerMode: shared

# Define IP pools for LoadBalancer services
# Note: These must NOT overlap with node IPs (10.0.101.0/24, fd00:101::/64)
loadBalancer:
  algorithm: maglev
  mode: dsr

# Operator settings
operator:
  replicas: 1

# Hubble observability
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - icmp
      - http

# Install CNI plugin
cni:
  install: true

# Talos-specific settings
cgroup:
  autoMount:
    enabled: false
  hostRoot: /sys/fs/cgroup

# Security context capabilities for Talos
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

# Gateway API
gatewayAPI:
  enabled: true
  enableProxyProtocol: false
  enableAppProtocol: false
  enableAlpn: true
  xffNumTrustedHops: 0
  externalTrafficPolicy: Cluster
  serviceLabels:
    bgp-advertise: "true"

gatewayClass:
  create: false
  secretsNamespace:
    create: true
    name: cilium-secrets
    sync: true
  hostNetwork:
    enabled: false

# Metrics
metrics:
  enabled: true
