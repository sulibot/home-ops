---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudflared
  namespace: network
spec:
  interval: 1h
  chart:
    spec:
      chart: cloudflare-tunnel
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: cloudflare
        namespace: flux-system
      version: 0.3.2
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: ConfigMap
              name: cloudflared-cloudflare-tunnel
            patch: |
              - op: add
                path: /data/config.yaml
                value: |
                  tunnel: sulibot-tunnel
                  credentials-file: /etc/cloudflared/creds/credentials.json
                  edge-ip-version: auto
                  protocol: http2
                  warp-routing:
                    enabled: false
                  metrics: 0.0.0.0:2000
                  no-autoupdate: true
                  ingress:
                    - hostname: plex.sulibot.com
                      service: http://plex.default.svc.cluster.local:32400
                    - hostname: overseerr.sulibot.com
                      service: http://overseerr.default.svc.cluster.local:80
                    - hostname: requests.sulibot.com
                      service: http://jellyseerr.default.svc.cluster.local:80
                    - hostname: hello.sulibot.com
                      service: hello_world
                    - service: http_status:404
  values:
    image:
      repository: cloudflare/cloudflared
      tag: "2026.2.0"
      pullPolicy: IfNotPresent
    cloudflare:
      account: 089ac5ef7a1525cb7d7129cdde5873cd
      enableWarp: false
      ingress:
        - hostname: plex.sulibot.com
          service: http://plex.default.svc.cluster.local:32400
        - hostname: overseerr.sulibot.com
          service: http://overseerr.default.svc.cluster.local:80
        - hostname: requests.sulibot.com
          service: http://jellyseerr.default.svc.cluster.local:80
        - hostname: hello.sulibot.com
          service: hello_world
      secretName: cloudflared-secret
      tunnelId: 0977043f-80e9-4549-a6f0-0af145a17f27
      tunnelName: sulibot-tunnel
    fullnameOverride: ""
    imagePullSecrets: []
    nameOverride: ""
    nodeSelector: {}
    podAnnotations: {}
    podLabels: {}
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 65532
      runAsGroup: 65532
      fsGroup: 65532
      fsGroupChangePolicy: OnRootMismatch
    replicaCount: 2
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        memory: 256Mi
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: true
    serviceAccount:
      annotations: {}
      name: ""
    tolerations: []
    affinity: {}
    dnsConfig:
      options:
        - name: ndots
          value: "1"
        - name: single-request
        - name: single-request-reopen
