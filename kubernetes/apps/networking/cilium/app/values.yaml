---
# Cilium Bootstrap Values for cluster-101
# Talos-specific configuration with dual-stack networking
#
# This file is used by helmfile during bootstrap.
# After Flux takes over, these same values are managed by the HelmRelease.

# API Server endpoint - use localhost for Talos
k8sServiceHost: localhost
k8sServicePort: 7445

# Replace kube-proxy with Cilium
kubeProxyReplacement: true

# Socket-based load balancing - restrict to host namespace only
# Required for Istio Ambient mesh compatibility
# This prevents interference with Istio's traffic redirection
socketLB:
  hostNamespaceOnly: true

# Enable dual-stack
ipv4:
  enabled: true
ipv6:
  enabled: true

# IPAM mode
ipam:
  mode: kubernetes

# Native routing (no encapsulation for better performance)
# routingMode: native should disable tunneling automatically in 1.18.x
routingMode: native
# Disable autoDirectNodeRoutes - BIRD2 will install routes instead
autoDirectNodeRoutes: false
directRoutingSkipUnreachable: false
# Disable endpointRoutes so Cilium installs per-node CIDR (/24) routes instead of per-endpoint (/32) routes
# This allows BIRD2 to redistribute these /24 routes via BGP instead of individual pod IPs
endpointRoutes:
  enabled: false

# Pod CIDRs for cluster-101
ipv4NativeRoutingCIDR: 10.101.244.0/22
ipv6NativeRoutingCIDR: fd00:101:244::/60

# BPF configuration optimized for Talos + Istio Ambient
# forwardKubeDNSToHost is disabled in Talos machine config to prevent conflicts
bpf:
  masquerade: true
  # LB mode: SNAT by default, allow per-service DSR/hybrid via annotations
  lbMode: snat
  lbModeAnnotation: true
  # Enable external ClusterIP access to handle LoadBalancer IPs
  lbExternalClusterIP: true
  # Map tuning for performance
  mapDynamicSizeRatio: 0.005
  preallocateMaps: true
  # BPF host routing (NOT legacy) - enables eBPF routing for autoDirectNodeRoutes
  hostLegacyRouting: false

# Disable ip-masq-agent - using eBPF masquerading instead
ipMasqAgent:
  enabled: false

# BGP Control Plane for VIP and LoadBalancer advertisement
bgpControlPlane:
  enabled: true

# LoadBalancer IP Address Management (IPAM)
# Define pools of IPs that can be assigned to LoadBalancer services
# These IPs will be advertised via BGP to the upstream router
l2announcements:
  enabled: false  # Using BGP instead of L2

# LB IPAM pools - IPs from these pools are assigned to LoadBalancer services
# and advertised via BGP so the router knows how to route them back to the cluster
ingressController:
  enabled: false
  loadbalancerMode: shared

# Define IP pools for LoadBalancer services
# Note: These must NOT overlap with node IPs (10.101.0.0/24, fd00:101::/64)
loadBalancer:
  algorithm: maglev
  # Mode is controlled by bpf.lbMode (snat) with per-service annotation override

# Operator settings
operator:
  replicas: 1

# Hubble observability
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - icmp
      - http

# Install CNI plugin
cni:
  install: true
  # Allow Istio CNI to coexist (required for Istio Ambient mesh)
  exclusive: false

# Talos-specific settings
cgroup:
  autoMount:
    enabled: false
  hostRoot: /sys/fs/cgroup

# Security context capabilities for Talos
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

# Envoy configuration - embedded in Cilium agent (not standalone DaemonSet)
# Setting enabled: false uses embedded Envoy within the Cilium agent pod
# This provides simpler deployment but Cilium restarts will affect proxied traffic
envoy:
  enabled: false

# Gateway API configuration
gatewayAPI:
  enabled: true
  # Host network mode for Gateway (recommended for BGP-advertised LB IPs)
  hostNetwork:
    enabled: true
  enableProxyProtocol: false
  enableAppProtocol: false
  enableAlpn: true
  xffNumTrustedHops: 0
  externalTrafficPolicy: Cluster
  serviceLabels:
    bgp-advertise: "true"

gatewayClass:
  create: false
  secretsNamespace:
    create: true
    name: cilium-secrets
    sync: true

# Metrics
metrics:
  enabled: true
