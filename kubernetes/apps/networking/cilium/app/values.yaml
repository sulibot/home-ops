---
# Cilium Bootstrap Values for cluster-101
# Talos-specific configuration with dual-stack networking
#
# This file is used by helmfile during bootstrap.
# After Flux takes over, these same values are managed by the HelmRelease.

# API Server endpoint - use localhost for Talos
k8sServiceHost: localhost
k8sServicePort: 7445

# Replace kube-proxy with Cilium
kubeProxyReplacement: true

# Socket-based load balancing - host namespace only
# Setting hostNamespaceOnly: true fixes libp2p compatibility (Spegel) and connection tracking races
# Pod traffic uses standard TC-BPF datapath (robust, fully compatible)
socketLB:
  enabled: false             # Disable socket-level load balancing to resolve libp2p/Spegel issues

# Enable dual-stack with IPv6 first
ipv4:
  enabled: true
ipv6:
  enabled: true

# Masquerade control
# Enable IPv4 masquerade to ensure egress connectivity (e.g. for Flux).
# IPv6 masquerade is enabled for egress toward non-routable external destinations.
enableIPv4Masquerade: true
enableIPv6Masquerade: true

# IPAM mode - kubernetes. Cilium uses the per-node PodCIDR assigned by the
# Kubernetes controller-manager. Your Talos config sets this to /64 for IPv6
# and /24 for IPv4.
ipam:
  mode: kubernetes

# IPv6 configuration - require pod CIDR from node spec
k8s:
  requireIPv6PodCIDR: true

# Native routing (no encapsulation for better performance)
# routingMode: native should disable tunneling automatically in 1.18.x
routingMode: native
# Enable autoDirectNodeRoutes to allow Cilium to manage pod-to-pod routes.
# Disabling this requires a fully functional external BGP setup for pod routes, which is currently not working.
# This is the primary cause of pod-to-service timeouts (e.g., to kube-apiserver).
autoDirectNodeRoutes: true
directRoutingSkipUnreachable: false  # Install routes to all nodes
# Disable endpoint routes so datapath uses node-level pod CIDR routing
# (aligned with Kubernetes IPAM + BGP route distribution).
endpointRoutes:
  enabled: false

# Explicitly set MTU to match the underlying VXLAN network (1450)
# This prevents packet drops during TLS handshakes (Spegel/libp2p) in Direct Routing mode
mtu: 1450

# Native routing CIDRs
# These should cover routable pod address space in the underlay.
# Do not include Service CIDRs (ClusterIP VIPs are virtual LB addresses).
ipv4NativeRoutingCIDR: 10.101.0.0/16
ipv6NativeRoutingCIDR: fd00:101::/48

# BPF configuration optimized for Talos + Istio Ambient
# forwardKubeDNSToHost must be DISABLED in Talos machine config for Direct Routing
bpf:
  # Enable BPF masquerading
  masquerade: true
  # LB mode: SNAT by default, allow per-service DSR/hybrid via annotations
  lbMode: snat
  lbModeAnnotation: true
  # Keep ClusterIP internal-only; expose services via LoadBalancer/Ingress/Gateway instead.
  lbExternalClusterIP: false
  # Map tuning for performance
  mapDynamicSizeRatio: 0.005
  preallocateMaps: true
  # Use BPF host routing (Direct Routing) for best performance
  hostLegacyRouting: false

# Disable ip-masq-agent - using native routing (no masquerading)
ipMasqAgent:
  enabled: false

# BGP Control Plane enabled; Cilium only peers to local FRR for LB VIP origination
bgpControlPlane:
  enabled: true

# LoadBalancer IP Address Management (IPAM)
# Define pools of IPs that can be assigned to LoadBalancer services
# These IPs will be advertised via BGP to the upstream router
l2announcements:
  enabled: false  # Using BGP instead of L2

# LB IPAM pools - IPs from these pools are assigned to LoadBalancer services
# and advertised via BGP so the router knows how to route them back to the cluster
ingressController:
  enabled: false
  loadbalancerMode: shared

# Define IP pools for LoadBalancer services
# Note: Pods use ULA range (fd00:101:224::/60) separate from node IPs (fd00:101::11, etc.)
# LB pool uses separate ULA range (fd00:101:250::/112) for LoadBalancer services
loadBalancer:
  algorithm: maglev
  # Mode is controlled by bpf.lbMode (snat) with per-service annotation override

# Operator settings
operator:
  replicas: 2

# Hubble observability
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - icmp
      - http

# DNS Proxy for performance and visibility
dnsProxy:
  enabled: true
  enableDNSCompression: false # Recommended for performance

# Install CNI plugin
cni:
  install: true
  # Allow Istio CNI to coexist (required for Istio Ambient mesh)
  exclusive: false

# Talos-specific settings
cgroup:
  autoMount:
    enabled: false
  hostRoot: /sys/fs/cgroup

# Security context capabilities for Talos
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

# Envoy configuration - standalone DaemonSet required for LoadBalancer Gateway services
# Required when gatewayAPI.hostNetwork.enabled is false
envoy:
  enabled: true

# Gateway API configuration
gatewayAPI:
  enabled: true
  # Host network mode breaks LoadBalancer IP allocation in Cilium
  # Use LoadBalancer services with LB-IPAM instead
  hostNetwork:
    enabled: false
  enableProxyProtocol: false
  enableAppProtocol: false
  enableAlpn: true
  xffNumTrustedHops: 0
  externalTrafficPolicy: Cluster
  serviceLabels:
    bgp-advertise: "true"

gatewayClass:
  create: false
  secretsNamespace:
    create: true
    name: cilium-secrets
    sync: true

# Metrics
metrics:
  enabled: true
