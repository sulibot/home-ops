---
# Cilium Bootstrap Values for cluster-101
# Talos-specific configuration with dual-stack networking
#
# This file is used by helmfile during bootstrap.
# After Flux takes over, these same values are managed by the HelmRelease.

# API Server endpoint - use localhost for Talos
k8sServiceHost: localhost
k8sServicePort: 7445

# Replace kube-proxy with Cilium
kubeProxyReplacement: true

# Socket-based load balancing - restrict to host namespace only
# Required for Istio Ambient mesh compatibility
# This prevents interference with Istio's traffic redirection
socketLB:
  hostNamespaceOnly: true

# Enable dual-stack with IPv6 first
ipv4:
  enabled: true
ipv6:
  enabled: true

# Masquerade control - IPv6 masquerading required for ClusterIP services
# While pod-to-pod uses native routing (no masquerade), ClusterIPs are virtual
# and need masquerading for kube-proxy replacement to function with BPF
enableIPv4Masquerade: false  # Keep false - will remove IPv4 eventually
enableIPv6Masquerade: false  # Disabled: Upstream router handles return paths via BGP

# IPAM mode - kubernetes with per-node /80 IPv6 allocations (standard)
# The /64 is subdivided into /80 subnets per node (281 trillion IPs each)
# Allows 65,536 nodes max - node-cidr-mask-size-ipv6 configured in Talos
ipam:
  mode: kubernetes

# IPv6 configuration - require pod CIDR from node spec
k8s:
  requireIPv6PodCIDR: true

# Native routing (no encapsulation for better performance)
# routingMode: native should disable tunneling automatically in 1.18.x
routingMode: native
# Enable autoDirectNodeRoutes so nodes learn each other's pod CIDRs
autoDirectNodeRoutes: true
directRoutingSkipUnreachable: true  # Skip unreachable routes - rely on BGP for inter-node routing
# Disable endpointRoutes so Cilium installs per-node CIDR (/24) routes instead of per-endpoint (/32) routes
# This allows FRR to redistribute these /24 routes via BGP instead of individual pod IPs
endpointRoutes:
  enabled: false

# Native routing CIDRs - must match cluster-pool IPAM configuration above
ipv4NativeRoutingCIDR: 0.0.0.0/0
ipv6NativeRoutingCIDR: "::/0"

# BPF configuration optimized for Talos + Istio Ambient
# forwardKubeDNSToHost is ENABLED in Talos machine config (Option 1)
bpf:
  # Must be FALSE when both IPv4/IPv6 masquerading are disabled to prevent crash
  masquerade: false
  # LB mode: SNAT by default, allow per-service DSR/hybrid via annotations
  lbMode: snat
  lbModeAnnotation: true
  # Enable external ClusterIP access to handle LoadBalancer IPs
  lbExternalClusterIP: true
  # Map tuning for performance
  mapDynamicSizeRatio: 0.005
  preallocateMaps: true
  # Use legacy routing for host-bound traffic to support Talos forwardKubeDNSToHost
  # Required for compatibility with link-local address 169.254.116.108
  hostLegacyRouting: true

# Disable ip-masq-agent - using native routing (no masquerading)
ipMasqAgent:
  enabled: false

# BGP Control Plane enabled; Cilium only peers to local FRR for LB VIP origination
bgpControlPlane:
  enabled: true

# LoadBalancer IP Address Management (IPAM)
# Define pools of IPs that can be assigned to LoadBalancer services
# These IPs will be advertised via BGP to the upstream router
l2announcements:
  enabled: false  # Using BGP instead of L2

# LB IPAM pools - IPs from these pools are assigned to LoadBalancer services
# and advertised via BGP so the router knows how to route them back to the cluster
ingressController:
  enabled: false
  loadbalancerMode: shared

# Define IP pools for LoadBalancer services
# Note: Pods share the same /64 as nodes for IPv6 (2600:1700:ab1a:500d::/64)
# LB pool uses separate ULA range (fd00:101:250::/112) for internal-only services
loadBalancer:
  algorithm: maglev
  # Mode is controlled by bpf.lbMode (snat) with per-service annotation override

# Operator settings
operator:
  replicas: 1

# Hubble observability
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - icmp
      - http

# Install CNI plugin
cni:
  install: true
  # Allow Istio CNI to coexist (required for Istio Ambient mesh)
  exclusive: false

# Talos-specific settings
cgroup:
  autoMount:
    enabled: false
  hostRoot: /sys/fs/cgroup

# Security context capabilities for Talos
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

# Envoy configuration - standalone DaemonSet required for LoadBalancer Gateway services
# Required when gatewayAPI.hostNetwork.enabled is false
envoy:
  enabled: true

# Gateway API configuration
gatewayAPI:
  enabled: true
  # Host network mode breaks LoadBalancer IP allocation in Cilium
  # Use LoadBalancer services with LB-IPAM instead
  hostNetwork:
    enabled: false
  enableProxyProtocol: false
  enableAppProtocol: false
  enableAlpn: true
  xffNumTrustedHops: 0
  externalTrafficPolicy: Cluster
  serviceLabels:
    bgp-advertise: "true"

gatewayClass:
  create: false
  secretsNamespace:
    create: true
    name: cilium-secrets
    sync: true

# Metrics
metrics:
  enabled: true
