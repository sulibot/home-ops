---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: media
spec:
  chart:
    spec:
      chart: immich
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: immich
        namespace: flux-system
      version: 0.10.3
  interval: 1h0m0s
  timeout: 10m
  maxHistory: 3
  install:
    remediation:
      retries: 5
    timeout: 10m
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 5
      strategy: rollback
    timeout: 10m
  values:
    immich:
      persistence:
        library:
          existingClaim: csi-cephfs-content-pvc
      configuration:
        storageTemplate:
          enabled: true
          template: '{{y}}/{{y}}-{{MM}}-{{dd}}/{{filename}}'
        trash:
          days: 30
          enabled: false
      metrics:
        enabled: false

    server:
      enabled: true
      controllers:
        main:
          containers:
            main:
              env:
                # Override chart default short-name with FQDN for IPv6-only cluster DNS resolution
                REDIS_HOSTNAME: immich-valkey.default.svc.cluster.local
                IMMICH_MACHINE_LEARNING_URL: http://immich-machine-learning.default.svc.cluster.local:3003
                DB_HOSTNAME:
                  valueFrom:
                    secretKeyRef:
                      name: postgres-vectorchord-app
                      key: host
                DB_USERNAME:
                  valueFrom:
                    secretKeyRef:
                      name: postgres-vectorchord-app
                      key: user
                DB_PASSWORD:
                  valueFrom:
                    secretKeyRef:
                      name: postgres-vectorchord-app
                      key: password
                DB_DATABASE_NAME:
                  valueFrom:
                    secretKeyRef:
                      name: postgres-vectorchord-app
                      key: dbname
      route:
        main:
          hostnames:
            - immich.sulibot.com
          parentRefs:
            - name: gateway-internal
              namespace: network
          rules:
            - backendRefs:
                - identifier: main

    valkey:
      enabled: true
      service:
        valkey:
          ipFamilyPolicy: PreferDualStack

    machine-learning:
      enabled: true
