---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: media
spec:
  chart:
    spec:
      chart: immich
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: immich
        namespace: flux-system
      version: 0.10.3
  interval: 1h0m0s
  timeout: 10m
  maxHistory: 3
  install:
    remediation:
      retries: 5
    timeout: 10m
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 5
      strategy: rollback
    timeout: 10m
  values:
    controllers:
      main:
        containers:
          main:
            env:
              DB_HOSTNAME:
                valueFrom:
                  secretKeyRef:
                    name: postgres-vectorchord-app
                    key: host
              DB_USERNAME:
                valueFrom:
                  secretKeyRef:
                    name: postgres-vectorchord-app
                    key: user
              DB_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: postgres-vectorchord-app
                    key: password
              DB_DATABASE_NAME:
                valueFrom:
                  secretKeyRef:
                    name: postgres-vectorchord-app
                    key: dbname

    immich:
      configuration:
        storageTemplate:
          enabled: true
          template: '{{y}}/{{y}}-{{MM}}-{{dd}}/{{filename}}'
        trash:
          days: 30
          enabled: false
      metrics:
        enabled: false

    persistence:
      library:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: csi-cephfs-content-pvc
        globalMounts:
          - path: /usr/src/app/upload
            subPath: media/photos

    valkey:
      enabled: true
      persistence:
        data:
          enabled: true
          type: persistentVolumeClaim
          size: 2Gi
          storageClass: csi-cephfs-config-sc
          accessMode: ReadWriteOnce

    server:
      enabled: true
      route:
        main:
          hostnames:
            - immich.sulibot.com
          parentRefs:
            - name: gateway-internal
              namespace: network
          rules:
            - backendRefs:
                - identifier: main

    machine-learning:
      enabled: true
