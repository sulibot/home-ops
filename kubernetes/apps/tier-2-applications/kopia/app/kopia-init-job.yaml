---
apiVersion: batch/v1
kind: Job
metadata:
  name: kopia-repository-connect
spec:
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      name: kopia-repository-connect
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      containers:
        - name: connect
          image: ghcr.io/home-operations/kopia:0.22.3@sha256:17ab64542280197a5368247deaefadc3e3bbe15714ab666c2455a06824e86efd
          env:
            - name: KOPIA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: kopia-secret
                  key: KOPIA_PASSWORD
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Check if repository is already connected
              if kopia repository status --config-file=/config/repository.config 2>/dev/null; then
                echo "Repository already connected"
                exit 0
              fi

              # Try to connect to existing repository, or create new one
              echo "Attempting to connect to existing Kopia repository..."
              if ! kopia repository connect filesystem \
                --path=/repository/repository \
                --password="$KOPIA_PASSWORD" \
                --config-file=/config/repository.config \
                --override-hostname=volsync.volsync-system.svc.cluster.local \
                --override-username=volsync 2>&1; then

                echo "Repository not found, creating new repository..."
                kopia repository create filesystem \
                  --path=/repository/repository \
                  --password="$KOPIA_PASSWORD" \
                  --config-file=/config/repository.config \
                  --override-hostname=volsync.volsync-system.svc.cluster.local \
                  --override-username=volsync

                echo "Repository created successfully"
              else
                echo "Repository connected successfully"
              fi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: config
              mountPath: /config
            - name: repository
              mountPath: /repository
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: kopia-config
        - name: repository
          persistentVolumeClaim:
            claimName: kopia
        - name: tmp
          emptyDir: {}
