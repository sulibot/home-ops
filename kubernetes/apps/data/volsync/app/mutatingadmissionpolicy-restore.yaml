---
# MutatingAdmissionPolicy to mount repository PVC for RESTORE jobs only
# Only matches volsync-dst-* (restores), NOT volsync-src-* (backups)
# Backups already have kopia PVC mounted as "repository-pvc" by volsync natively
# Using failurePolicy: Ignore to prevent hangs if the policy fails
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: volsync-repository
spec:
  policyName: volsync-repository
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: volsync-repository
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - batch
        apiVersions:
          - v1
        operations:
          - CREATE
          - UPDATE
        resources:
          - jobs
  matchConditions:
    # Match ONLY restore jobs (volsync-dst-*), NOT backup jobs (volsync-src-*)
    - name: is-restore-job
      expression: >-
        object.metadata.name.startsWith("volsync-dst-")
    - name: has-volsync-created-by-labels
      expression: >-
        object.metadata.?labels["app.kubernetes.io/created-by"].orValue("") == "volsync"
    - name: repository-volume-does-not-exist
      expression: >-
        !has(object.spec.template.spec.volumes) ||
        !object.spec.template.spec.volumes.exists(item, item.name == "repository")
  failurePolicy: Ignore  # Changed from Fail to Ignore to prevent hangs
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >-
          [
            JSONPatch{
              op: "add",
              path: "/spec/template/spec/containers/0/volumeMounts/-",
              value: Object.spec.template.spec.containers.volumeMounts{
                name: "repository",
                mountPath: "/repository"
              }
            },
            JSONPatch{
              op: "add",
              path: "/spec/template/spec/volumes/-",
              value: Object.spec.template.spec.volumes{
                name: "repository",
                persistentVolumeClaim: Object.spec.template.spec.volumes.persistentVolumeClaim{
                  claimName: "kopia",
                  readOnly: false
                }
              }
            }
          ]
