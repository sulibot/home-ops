---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ceph-csi-cephfs-nodeplugin
  namespace: ceph-csi
spec:
  template:
    spec:
      containers:
        - name: csi-cephfsplugin
          args:
            - --nodeid=$(NODE_ID)
            - --type=cephfs
            - --endpoint=$(CSI_ENDPOINT)
            - --v=5
            - --drivername=$(DRIVER_NAME)
            - --pidlimit=-1
            # FIX: Force FUSE mounter - avoids kernel CephFS client IMA hashing bug on Talos
            # and prevents indefinite mount() syscall hangs during MDS session storms.
            - --forcecephkernelclient=false
            # FIX: CSI-level operation timeout to bound hung goroutines.
            - --operationtimeout=30s
            - --setmetadata=true
            - --automaxprocs=true
            - --logslowopinterval=30s