# yaml-language-server: $schema=raw.githubusercontent.com
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nzbget
spec:
  chartRef:
    kind: OCIRepository
    name: nzbget
  interval: 1h
  timeout: 10m
  maxHistory: 3
  install:
    remediation:
      retries: 5
    timeout: 10m
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 5
      strategy: rollback
    timeout: 10m
  values:
    controllers:
      nzbget:
        containers:
          app:
            image:
              repository: ghcr.io/home-operations/nzbget
              tag: 25.4.0@sha256:cec63a94495ed4354597fe30ae82fcb202a19f9a3a7bd989d397e95ee50038da
            env:
              NZBGET__PORT: &port 80
              TZ: America/Los_Angeles
              # If necessary, explicitly set the bind address to all interfaces (IPv4 and IPv6)
              # This specific key might vary depending on the image maintainer's implementation
              NZBGET__HOST: "::"
              NZBGET__CONTROLIP: "::" 
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /jsonrpc/status
                    port: *port
                  initialDelaySeconds: 30 # Increased delay to allow app startup
                  periodSeconds: 10
                  timeoutSeconds: 5 # Slightly safer timeout
                  failureThreshold: 3
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 100m
#              limits:
#                memory: 8Gi
    defaultPodOptions:
#      annotations:
#        k8s.v1.cni.cncf.io/networks: |-
#          [{
#            "name": "vpn",
#            "namespace": "kube-system",
#            "ips": ["192.168.90.11/24"],
#            "mac": "a6:3e:4f:09:e4:9c"
#          }]
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        ports:
          http:
            port: *port
        # Explicitly configure the K8s Service object for dual-stack operation
        kubernetes:
          ipFamilyPolicy: PreferDualStack
          ipFamilies:
            - IPv6
            - IPv4

    route:
      app:
        enabled: true
        hostnames:
          - "{{ .Release.Name }}.sulibot.com"
        parentRefs:
          - name: gateway-external
            namespace: network

    persistence:
      config:
        enabled: true
        existingClaim: "{{ .Release.Name }}-config"
      downloads:
        type: emptyDir
        globalMounts:
          - path: /downloads
      content:
        type: persistentVolumeClaim
        existingClaim: csi-cephfs-content-pvc
        globalMounts:
          - path: /data
            subPath: data
      tmp:
        type: emptyDir
