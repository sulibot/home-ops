---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: intel-gpu-resource-driver
spec:
  chartRef:
    kind: OCIRepository
    name: intel-gpu-resource-driver
  interval: 1h
  # CDI configuration added to Talos machine config (terraform/infra/modules/talos_config/main.tf)
  # Enables containerd CDI support for GPU passthrough via /var/cdi/static and /var/cdi/dynamic
  values:
    cdi:
      staticPath: /var/cdi/static
      dynamicPath: /var/cdi/dynamic
    kubeletPlugin:
      # Only run on worker nodes (nodes without control-plane role)
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: gpu.passthrough.enabled
                operator: In
                values:
                  - "true"
