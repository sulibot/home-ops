version: '3'

includes:
  clusters: ./clusters/Taskfile.yml
  ansible: ./ansible/Taskfile.yml

env:
  # Default cluster id can be overridden at runtime: CLUSTER_ID=101
  CLUSTER_ID: '{{.CLUSTER_ID | default "101"}}'

tasks:
  default:
    desc: Show available commands
    cmds:
      - task --list

  # Full pipeline: image -> terraform infra -> kubeadm -> cilium -> flux -> validate
  build:all:
    desc: Build the entire cluster end-to-end
    deps: [build:image, build:infra, build:cluster, validate]

  build:image:
    desc: Download OS image(s) used by Terraform (idempotent)
    cmds:
      - task: clusters:download-image
        vars: { CLUSTER_ID: "{{.CLUSTER_ID}}" }

  build:infra:
    desc: Provision/Update infra for the cluster via Terraform
    cmds:
      - task: clusters:terraform-apply
        vars: { CLUSTER_ID: "{{.CLUSTER_ID}}" }

  build:cluster:
    desc: Configure Kubernetes on provisioned nodes (kubeadm, Cilium, Flux)
    cmds:
      - task: ansible:bootstrap
        vars: { CLUSTER_ID: "{{.CLUSTER_ID}}" }
      - task: ansible:cilium
        vars: { CLUSTER_ID: "{{.CLUSTER_ID}}" }
      - task: ansible:flux
        vars: { CLUSTER_ID: "{{.CLUSTER_ID}}" }

  validate:
    desc: Validate cluster is healthy
    cmds:
      - task: ansible:validate
        vars: { CLUSTER_ID: "{{.CLUSTER_ID}}" }
