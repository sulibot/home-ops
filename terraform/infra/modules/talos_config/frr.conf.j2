! FRR Configuration for ${hostname}
! BGP peering with Proxmox Static Anycast LLA (BGP unnumbered)
! Generated by Terraform templatefile()
!
frr version 10.2
frr defaults datacenter
hostname ${hostname}
log syslog informational
service integrated-vtysh-config
!
! Import only default routes from upstream
ipv6 prefix-list DEFAULT-ONLY-v6 seq 10 permit ::/0
ip prefix-list DEFAULT-ONLY-v4 seq 10 permit 0.0.0.0/0
!
route-map IMPORT-DEFAULT-v6 permit 10
 match ipv6 address prefix-list DEFAULT-ONLY-v6
exit
!
route-map IMPORT-DEFAULT-v6 deny 90
exit
!
route-map IMPORT-DEFAULT-v4 permit 10
 match ip address prefix-list DEFAULT-ONLY-v4
exit
!
route-map IMPORT-DEFAULT-v4 deny 90
exit
!
%{ if advertise_loopbacks ~}
! Advertise node loopback networks (10.${cluster_id}.254.0/24 and fd00:${cluster_id}:fe::/64)
ip prefix-list LOOPBACKS seq 10 permit 10.${cluster_id}.254.0/24 ge 32
ipv6 prefix-list LOOPBACKS-V6 seq 10 permit fd00:${cluster_id}:fe::/64 ge 128
!
route-map ADVERTISE-LOOPBACKS permit 10
 match ip address prefix-list LOOPBACKS
exit
!
route-map ADVERTISE-LOOPBACKS-V6 permit 10
 match ipv6 address prefix-list LOOPBACKS-V6
exit
!
%{ endif ~}
! BGP Configuration
router bgp ${local_asn}
 bgp router-id ${router_id}
 no bgp default ipv4-unicast
 no bgp default ipv6-unicast
 bgp graceful-restart
 timers bgp 30 90
 !
 ! Peer with PVE ULA anycast gateway (fd00:<cluster_id>::fffe)
 neighbor fd00:${cluster_id}::fffe remote-as ${gw_asn}
 neighbor fd00:${cluster_id}::fffe update-source ${node_ipv6}
 neighbor fd00:${cluster_id}::fffe description "PVE ULA Anycast Gateway"
 neighbor fd00:${cluster_id}::fffe capability extended-nexthop
 !
 ! Peer with local Cilium BGP speaker (veth point-to-point)
 neighbor CILIUMv4 peer-group
 neighbor CILIUMv4 remote-as ${cilium_asn}
 neighbor CILIUMv4 update-source ${frr_veth_ipv4}
 neighbor CILIUMv4 ebgp-multihop 2
 neighbor CILIUMv4 description "Cilium BGP (veth IPv4)"
 neighbor ${cilium_veth_ipv4} peer-group CILIUMv4
 !
 neighbor CILIUMv6 peer-group
 neighbor CILIUMv6 remote-as ${cilium_asn}
 neighbor CILIUMv6 update-source ${frr_veth_ipv6}
 neighbor CILIUMv6 ebgp-multihop 2
 neighbor CILIUMv6 description "Cilium BGP (veth IPv6)"
 neighbor ${cilium_veth_ipv6} peer-group CILIUMv6
 !
 address-family ipv4 unicast
%{ if advertise_loopbacks ~}
  redistribute connected route-map ADVERTISE-LOOPBACKS
%{ endif ~}
  neighbor CILIUMv4 activate
  neighbor fd00:${cluster_id}::fffe activate
  neighbor fd00:${cluster_id}::fffe route-map IMPORT-DEFAULT-v4 in
%{ if advertise_loopbacks ~}
  neighbor fd00:${cluster_id}::fffe route-map ADVERTISE-LOOPBACKS out
%{ endif ~}
 exit-address-family
 !
 address-family ipv6 unicast
%{ if advertise_loopbacks ~}
  redistribute connected route-map ADVERTISE-LOOPBACKS-V6
%{ endif ~}
  neighbor CILIUMv6 activate
  neighbor fd00:${cluster_id}::fffe activate
  neighbor fd00:${cluster_id}::fffe route-map IMPORT-DEFAULT-v6 in
%{ if advertise_loopbacks ~}
  neighbor fd00:${cluster_id}::fffe route-map ADVERTISE-LOOPBACKS-V6 out
%{ endif ~}
 exit-address-family
exit
!
line vty
!
