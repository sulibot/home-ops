! FRR Configuration for ${hostname}
! BGP peering with upstream router via link-local IPv6
! Generated by Terraform templatefile()
!
frr version 10.2
frr defaults datacenter
hostname ${hostname}
log syslog informational
service integrated-vtysh-config
!
%{ if enable_bfd ~}
! BFD (Bidirectional Forwarding Detection) for fast failover
bfd
 profile normal
  detect-multiplier 3
  receive-interval 300
  transmit-interval 300
 exit
exit
!
%{ endif ~}
! Import only default routes from upstream
ipv6 prefix-list DEFAULT-ONLY-v6 seq 10 permit ::/0
ip prefix-list DEFAULT-ONLY-v4 seq 10 permit 0.0.0.0/0
!
route-map IMPORT-DEFAULT-v6 permit 10
 match ipv6 address prefix-list DEFAULT-ONLY-v6
exit
!
route-map IMPORT-DEFAULT-v6 deny 90
exit
!
route-map IMPORT-DEFAULT-v4 permit 10
 match ip address prefix-list DEFAULT-ONLY-v4
exit
!
route-map IMPORT-DEFAULT-v4 deny 90
exit
!
route-map EXPORT_GUA_TO_EDGE permit 10
 exit
!
%{ if advertise_loopbacks ~}
! Advertise node loopback networks
ip prefix-list LOOPBACKS seq 10 permit 10.255.${cluster_id}.0/24 ge 32
ipv6 prefix-list LOOPBACKS-V6 seq 10 permit fd00:255:${cluster_id}::/48 ge 128
!
route-map ADVERTISE-LOOPBACKS permit 10
 match ip address prefix-list LOOPBACKS
exit
!
route-map ADVERTISE-LOOPBACKS-V6 permit 10
 match ipv6 address prefix-list LOOPBACKS-V6
exit
!
%{ endif ~}
! BGP Configuration
router bgp ${local_asn}
 bgp router-id ${router_id}
 no bgp default ipv4-unicast
 bgp graceful-restart
 timers bgp 10 30
 !
 ! Unnumbered BGP peering with Proxmox gateway using static link-local
 ! All Proxmox vnet interfaces use fe80::ffff as their link-local gateway address
 ! This allows multiple VMs on the same vnet to peer with the same gateway
 neighbor fe80::ffff remote-as ${remote_asn}
 neighbor fe80::ffff interface ${interface}
 neighbor fe80::ffff description "Proxmox SDN Gateway"
 neighbor fe80::ffff capability extended-nexthop
 neighbor fe80::ffff timers 10 30
 neighbor fe80::ffff ttl-security hops 1
%{ if enable_bfd ~}
 neighbor fe80::ffff bfd
 neighbor fe80::ffff bfd profile normal
%{ endif ~}
 !
 address-family ipv4 unicast
%{ if advertise_loopbacks ~}
  redistribute connected route-map ADVERTISE-LOOPBACKS
%{ endif ~}
  neighbor fe80::ffff activate
  neighbor fe80::ffff route-map IMPORT-DEFAULT-v4 in
%{ if advertise_loopbacks ~}
  neighbor fe80::ffff route-map ADVERTISE-LOOPBACKS out
%{ endif ~}
 exit-address-family
 !
 address-family ipv6 unicast
%{ if advertise_loopbacks ~}
  redistribute connected route-map ADVERTISE-LOOPBACKS-V6
%{ endif ~}
  neighbor fe80::ffff activate
  neighbor fe80::ffff route-map IMPORT-DEFAULT-v6 in
%{ if advertise_loopbacks ~}
  neighbor fe80::ffff route-map ADVERTISE-LOOPBACKS-V6 out
%{ endif ~}
 exit-address-family
exit
!
line vty
!
