machine:
  kubelet:
    nodeIP:
      validSubnets:
        - fd00:101::12/128
  network:
    hostname: solcp02
    interfaces:
      - addresses:
          - 2600:1700:ab1a:500d::12/64
          - fd00:101::12/64
          - 10.101.0.12/24
        interface: ens18
        mtu: 1450
        routes:
          - gateway: 10.101.0.254
            metric: 2048
            network: 0.0.0.0/0
          - gateway: fe80::101:fffe
            metric: 150
            network: ::/0
        vip:
          ip: fd00:101::10
      - addresses:
          - fd00:101:fe::12/128
          - 10.101.254.12/32
        interface: dummy0
    nameservers:
      - fd00:0:0:ffff::53
      - 10.255.0.53
  nodeLabels:
    bgp.frr.asn: "4210101012"
    topology.kubernetes.io/region: home-lab
    topology.kubernetes.io/zone: cluster-101
---
# YAML Document 2: ExtensionServiceConfig for FRR BGP daemon
# Per-node FRR configuration (peers, ASN, route filters)
# Updates safely via patch/ stage along with machine config above
apiVersion: v1alpha1
kind: ExtensionServiceConfig
name: bird2
configFiles:
  - content: |
      # bird2 BGP daemon configuration
      # Router ID uses the shared Cilium/bird2 loopback (.254)
      router id 10.101.254.12;

      # Logging
      log syslog all;

      # Device protocol - learns about network interfaces
      protocol device {
        scan time 10;
      }

      # Direct protocol - imports directly connected routes
      protocol direct {
        interface "dummy0", "lo";
        ipv4;
        ipv6;
      }

      # Kernel protocol for IPv4 - imports/exports routes from/to kernel
      protocol kernel {
        ipv4 {
          import none;
          export filter {
            # Don't export routes learned from Cilium or loopback back to kernel
            if proto = "cilium" then reject;
            if proto = "loopback" then reject;
            accept;
          };
        };
        merge paths on;
      }

      # Kernel protocol for IPv6
      protocol kernel {
        ipv6 {
          import none;
          export filter {
            # Don't export routes learned from Cilium or loopback back to kernel
            if proto = "cilium" then reject;
            if proto = "loopback" then reject;
            accept;
          };
        };
        merge paths on;
      }

      # BGP - Cilium Peering via localhost
      # bird2 listens on 179 (default), Cilium connects from localhost
      protocol bgp cilium {
        description "Cilium BGP Control Plane";
        passive on;
        multihop 2;
        local as 4210101012;
        neighbor 127.0.0.1 as 4220101000;

        ipv4 {
          import all;
          export none;  # One-way: Cilium → bird2
        };

        ipv6 {
          import all;
          export none;  # One-way: Cilium → bird2
          extended next hop on;  # Cilium sends IPv6 routes with IPv4 next hop
        };
      }

      # BGP - Upstream Peering (same as FRR - ULA addresses)
      protocol bgp upstream {
        description "PVE ULA Anycast Gateway";
        local as 4210101012;
        source address fd00:101::12;  # Use node's public IPv6 (fd00:101::X)
        neighbor fd00:101::fffe as 4200001000;

        ipv4 {
          import all;
          export all;
          next hop self;
        };

        ipv6 {
          import all;
          export all;
          next hop self;
          extended next hop on;  # MP-BGP over IPv6 for IPv4 routes
        };
      }
    mountPath: /usr/local/etc/bird.conf
