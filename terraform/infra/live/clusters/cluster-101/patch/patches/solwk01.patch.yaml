cluster: {}
machine:
  kernel:
    modules:
      - name: i915
        parameters:
          - enable_display=0
          - enable_guc=3
          - force_probe=*
  kubelet:
    nodeIP:
      validSubnets:
        - fd00:101::21/128
  network:
    hostname: solwk01
    interfaces:
      - addresses:
          - 2600:1700:ab1a:500d::21/64
          - fd00:101::21/64
          - 10.101.0.21/24
        interface: ens18
        mtu: 1450
        routes:
          - gateway: 10.101.0.254
            metric: 2048
            network: 0.0.0.0/0
          - gateway: fe80::101:fffe
            metric: 150
            network: ::/0
        vip: null
      - addresses:
          - fd00:101:fe::21/128
          - 10.101.254.21/32
        interface: dummy0
      - dhcp: false
        interface: ens19
        mtu: 1500
        vlans:
          - mtu: 1500
            vlanId: 30
          - mtu: 1500
            vlanId: 31
    nameservers:
      - fd00:0:0:ffff::53
      - 10.255.0.53
  nodeLabels:
    bgp.frr.asn: "4210101021"
    gpu.driver: i915
    gpu.passthrough.enabled: "true"
    gpu.pci.address: 0000-00-02.1
    topology.kubernetes.io/region: home-lab
    topology.kubernetes.io/zone: cluster-101
---
apiVersion: v1alpha1
kind: ExtensionServiceConfig
name: bird2
configFiles:
  - content: |
      # bird2 BGP daemon configuration
      # Router ID uses the shared Cilium/bird2 loopback (.254)
      router id 10.101.254.21;
      
      # Logging
      log syslog all;
      
      # Device protocol - learns about network interfaces
      protocol device {
        scan time 10;
      }
      
      # Direct protocol - imports directly connected routes
      protocol direct direct_routes {
        interface "dummy0", "lo", "ens18";
        ipv4 {
          import all;
        };
        ipv6 {
          import all;
        };
      }
      
      # Kernel protocol for IPv4 - imports/exports routes from/to kernel
      protocol kernel kernel_v4 {
        ipv4 {
          import none;
          export filter {
            # Never install Kubernetes Service CIDR routes in kernel.
            # ClusterIP is virtual and must be handled by Cilium eBPF service LB.
            if net ~ [10.101.96.0/24{24,32}] then reject;
            # Only export routes learned from upstream (FRR) to kernel
            if proto = "upstream" then accept;
            reject;
          };
        };
        merge paths on;
      }
      
      # Kernel protocol for IPv6
      protocol kernel kernel_v6 {
        ipv6 {
          import none;
          export filter {
            # Never install Kubernetes Service CIDR routes in kernel.
            # ClusterIP is virtual and must be handled by Cilium eBPF service LB.
            if net ~ [fd00:101:96::/112{112,128}] then reject;
            # Only export routes learned from upstream (FRR) to kernel
            if proto = "upstream" then accept;
            reject;
          };
        };
        merge paths on;
      }
      
      # BFD protocol
      protocol bfd {
        interface "*" { multiplier 3; interval 300 ms; };
      }
      
      # BGP - Cilium Peering via localhost
      # bird2 listens on 179 (default), Cilium connects from localhost
      protocol bgp cilium {
        description "Cilium BGP Control Plane";
        passive on;
        multihop 2;
        local as 4210101021;
        neighbor ::1 as 4220101000;
      
        ipv4 {
          import all;
          export filter {
            # Export routes learned from upstream FRR back to Cilium
            if proto = "upstream" then accept;
            reject;
          };
          extended next hop on;  # MP-BGP: IPv4 routes over IPv6 session
        };
      
        ipv6 {
          import all;
          export filter {
            # Export routes learned from upstream FRR back to Cilium
            if proto = "upstream" then accept;
            reject;
          };
        };
      }
      
      # BGP - Upstream Peering (same as FRR - ULA addresses)
      protocol bgp upstream {
        description "PVE ULA Anycast Gateway";
        local as 4210101021;
        source address fd00:101::21;  # Use node's public IPv6 (fd00:101::X)
        neighbor fd00:101::fffe as 4200001000;
        bfd on;
      
        ipv4 {
          import filter {
            # Do not learn Kubernetes Service CIDR from upstream.
            if net ~ [10.101.96.0/24{24,32}] then reject;
            accept;
          };
          export filter {
            # Tag Loopbacks (protocol direct_routes) as Public (Community :200)
            if proto = "direct_routes" then {
              bgp_large_community.add((4200001000, 0, 200));
              accept;
            }
            # Tag Pod CIDRs (from Cilium) as Internal (Community :100)
            # This is CRITICAL for FRR to accept the pod routes via RM_VMS_IN_V4/6
            if proto = "cilium" then {
              if net ~ [10.101.0.0/16] then {
                bgp_large_community.add((4200001000, 0, 100));
                accept;
              }
            }
            # Pass through other routes (e.g., LoadBalancer VIPs from Cilium)
            # These are accepted by FRR without a community tag.
            accept;
          };
          next hop self;
          extended next hop on;
        };
      
        ipv6 {
          import filter {
            # Reject the local node subnet - nodes use direct kernel routes
            # Importing this from gateway creates lower-metric route that breaks Cilium
            if net = fd00:101::/64 then reject;
            # Do not learn Kubernetes Service CIDR from upstream.
            if net ~ [fd00:101:96::/112{112,128}] then reject;
            accept;
          };
          export filter {
            # Tag Loopbacks (protocol direct_routes) as Public (Community :200)
            if proto = "direct_routes" then {
              bgp_large_community.add((4200001000, 0, 200));
              accept;
            }
            # Tag Pod CIDRs (from Cilium) as Internal (Community :100)
            # This is CRITICAL for FRR to accept the pod routes via RM_VMS_IN_V6
            if proto = "cilium" then {
              if net ~ [fd00:101::/48] then {
                bgp_large_community.add((4200001000, 0, 100));
                accept;
              }
            }
            accept;
          };
          next hop self;
          missing lladdr ignore;  # Allow exporting routes without link-local addresses
        };
      }
      
    mountPath: /usr/local/etc/bird.conf
