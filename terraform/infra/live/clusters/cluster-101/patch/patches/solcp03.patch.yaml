cluster:
  etcd:
    advertisedSubnets:
      - fd00:101::13/128
machine:
  kubelet:
    nodeIP:
      validSubnets:
        - fd00:101::13/128
  network:
    hostname: solcp03
    interfaces:
      - addresses:
          - 2600:1700:ab1a:500d::13/64
          - fd00:101::13/64
          - 10.101.0.13/24
        interface: ens18
        mtu: 1450
        routes:
          - gateway: 10.101.0.254
            metric: 2048
            network: 0.0.0.0/0
          - gateway: fe80::101:fffe
            metric: 150
            network: ::/0
        vip:
          ip: fd00:101::10
      - addresses:
          - fd00:101:fe::13/128
          - 10.101.254.13/32
        interface: dummy0
    nameservers:
      - fd00:0:0:ffff::53
      - 10.255.0.53
  nodeLabels:
    bgp.frr.asn: "4210101013"
    topology.kubernetes.io/region: home-lab
    topology.kubernetes.io/zone: cluster-101
---
apiVersion: v1alpha1
kind: ExtensionServiceConfig
name: bird2
configFiles:
  - content: |
      # bird2 BGP daemon configuration
      # Router ID uses the shared Cilium/bird2 loopback (.254)
      router id 10.101.254.13;
      
      # Logging
      log syslog all;
      
      # Device protocol - learns about network interfaces
      protocol device {
        scan time 10;
      }
      
      # Direct protocol - imports directly connected routes
      protocol direct direct_routes {
        interface "dummy0", "lo", "ens18";
        ipv4 {
          import all;
        };
        ipv6 {
          import all;
        };
      }
      
      # Kernel protocol for IPv4 - imports/exports routes from/to kernel
      protocol kernel {
        ipv4 {
          import none;
          export filter {
            # Don't export routes learned from Cilium or loopback back to kernel
            if proto = "cilium" then reject;
            if proto = "loopback" then reject;
            accept;
          };
        };
        merge paths on;
      }
      
      # Kernel protocol for IPv6
      protocol kernel {
        ipv6 {
          import none;
          export filter {
            # Don't export routes learned from Cilium or loopback back to kernel
            if proto = "cilium" then reject;
            if proto = "loopback" then reject;
            accept;
          };
        };
        merge paths on;
      }
      
      # BFD protocol
      protocol bfd {
        interface "*" { multiplier 3; interval 300 ms; };
      }
      
      # BGP - Cilium Peering via localhost
      # bird2 listens on 179 (default), Cilium connects from localhost
      protocol bgp cilium {
        description "Cilium BGP Control Plane";
        passive on;
        multihop 2;
        local as 4210101013;
        neighbor ::1 as 4220101000;
      
        ipv4 {
          import all;
          export none;  # One-way: Cilium → bird2
          extended next hop on;  # MP-BGP: IPv4 routes over IPv6 session
        };
      
        ipv6 {
          import all;
          export none;  # One-way: Cilium → bird2
        };
      }
      
      # BGP - Upstream Peering (same as FRR - ULA addresses)
      protocol bgp upstream {
        description "PVE ULA Anycast Gateway";
        local as 4210101013;
        source address fd00:101::13;  # Use node's public IPv6 (fd00:101::X)
        neighbor fd00:101::fffe as 4200001000;
        bfd on;
      
        ipv4 {
          import all;
          export filter {
            # Tag Loopbacks (protocol direct_routes) as Public (Community :200) so PVE exports them to Edge
            if proto = "direct_routes" then {
              bgp_large_community.add((4200001000, 0, 200));
              accept;
            }
            # Pass through other routes (e.g. from Cilium)
            accept;
          };
          next hop self;
          extended next hop on;
        };
      
        ipv6 {
          import filter {
            # Reject the local node subnet - nodes use direct kernel routes
            # Importing this from gateway creates lower-metric route that breaks Cilium
            if net = fd00:101::/64 then reject;
            accept;
          };
          export filter {
            # Tag Loopbacks (protocol direct_routes) as Public (Community :200) so PVE exports them to Edge
            if proto = "direct_routes" then {
              bgp_large_community.add((4200001000, 0, 200));
              accept;
            }
            # Pass through other routes (e.g. from Cilium)
            accept;
          };
          next hop self;
          missing lladdr ignore;  # Allow exporting routes without link-local addresses
        };
      }
      
    mountPath: /usr/local/etc/bird.conf
